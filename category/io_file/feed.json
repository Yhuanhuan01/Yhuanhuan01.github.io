{
    "version": "https://jsonfeed.org/version/1",
    "title": "null • All posts by \"io_file\" category",
    "description": "欢迎来到Huan的笔记空间~~~~~~🌸",
    "home_page_url": "https://yhuanhuan01.github.io",
    "items": [
        {
            "id": "https://yhuanhuan01.github.io/2024/07/15/IO-FILE/",
            "url": "https://yhuanhuan01.github.io/2024/07/15/IO-FILE/",
            "title": "IO_FILE",
            "date_published": "2024-07-15T04:24:42.000Z",
            "content_html": "<h1 id=\"io_file1\"><a class=\"markdownIt-Anchor\" href=\"#io_file1\">#</a> IO_FILE（1）</h1>\n<blockquote>\n<p>前言：为了好好学习 house-of-orange 的利用，先在 house-of-orange 专题之前写一些 IO_FILE 的利用</p>\n</blockquote>\n<h3 id=\"_io_file-结构\"><a class=\"markdownIt-Anchor\" href=\"#_io_file-结构\">#</a> _IO_FILE 结构</h3>\n<p>FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流。 FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中。我们常定义一个指向 FILE 结构的指针来接收这个返回值 —— 文件描述符（eg:stdin=0;stdout=1)。</p>\n<p>在标准 I/O 库中，每个程序启动时有三个文件流是自动打开的：<strong>stdin、stdout、stderr，分别对应文件描述符：0、1、2</strong>。假设现在第一次用 fopen 打开一个文件流，这个文件流的文件描述符就为 3 。默认打开的三个文件流分配 libc data 段。fopen 等文件流控制函数创建的文件流是分配在堆上。</p>\n<p>FILE 结构体定义在 libio.h ：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_FILE</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">int</span> _flags<span class=\"token punctuation\">;</span>       <span class=\"token comment\">/* 高位字为_IO_MAGIC；剩下的就是旗帜。 */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_IO_file_flags</span> <span class=\"token expression\">_flags</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">/* 以下指针对应于 C++ Streambuf 协议。 */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">/* 注意：Tk 直接使用 _IO_read_ptr 和 _IO_read_end 字段。 */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_read_ptr<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Current read pointer */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_read_end<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* End of get area. */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_read_base<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* Start of putback+get area. */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_write_base<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* Start of put area. */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_write_ptr<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* Current put pointer. */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_write_end<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* End of put area. */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_buf_base<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Start of reserve area. */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> _IO_buf_end<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* End of reserve area. */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">/* The following fields are used to support backing up and undo. */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>_IO_save_base<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* Pointer to start of non-current get area. */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>_IO_backup_base<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* Pointer to first valid character of backup area */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>_IO_save_end<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* Pointer to end of non-current get area. */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_marker</span> <span class=\"token operator\">*</span>_markers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_FILE</span> <span class=\"token operator\">*</span>_chain<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">int</span> _fileno<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">int</span> _blksize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">int</span> _flags2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  _IO_off_t _old_offset<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* This used to be _offset but it's too small.  */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__HAVE_COLUMN</span> <span class=\"token comment\">/* temporary */</span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">/* 1+column number of pbase(); 0 is unknown. */</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> _cur_column<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">signed</span> <span class=\"token keyword\">char</span> _vtable_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">char</span> _shortbuf<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">/*  char* _save_gptr;  char* _save_egptr; */</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  _IO_lock_t <span class=\"token operator\">*</span>_lock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_IO_USE_OLD_IO_FILE</span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其实进程中的 FILE 结构会通过 <code>_chain</code>  域彼此连接形成一个链表，链表头部用全局变量 <code>_IO_list_all</code>  表示，通过这个值我们可以遍历所有的 FILE 结构。</p>\n<p><strong>每个文件流都有自己的 FILE 结构体</strong>。我们可以在  <code>libc.so</code>  中找到  <code>stdin\\stdout\\stderr</code>  等符号，这些符号是指向 FILE 结构的指针，真正结构的符号是</p>\n<blockquote>\n<p><code>_IO_2_1_stderr_</code> <br>\n <code>_IO_2_1_stdout_</code> <br>\n <code>_IO_2_1_stdin_</code></p>\n</blockquote>\n<p>但是 file 结构其实只是一小部分，还有一个叫 <code>vtable</code>  指针，同属于 <code>_IO_File_plus:</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_FILE_plus</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _IO_FILE    file<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IO_jump_t   <span class=\"token operator\">*</span>vtable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//32 位下的偏移是 0x94，而 64 位下偏移是 0xd8</span></pre></td></tr></table></figure><blockquote>\n<p>gdb</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pwndbg<span class=\"token operator\">></span> p  <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_FILE_plus</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0x7ffff7bc5620</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$<span class=\"token number\">11</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>file <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> _flags <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">72537977</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> _IO_read_ptr <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> _IO_read_end <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> _IO_read_base <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> _IO_write_base <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> _IO_write_ptr <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> _IO_write_end <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> _IO_buf_base <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a3</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">131</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> _IO_buf_end <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc56a4</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdout_<span class=\"token operator\">+</span><span class=\"token number\">132</span><span class=\"token operator\">></span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> _IO_save_base <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> _IO_backup_base <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> _IO_save_end <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> _markers <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> _chain <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc48e0</span> <span class=\"token operator\">&lt;</span>_IO_2_1_stdin_<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> _fileno <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> _flags2 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> _old_offset <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> _cur_column <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> _vtable_offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token char\">'\\000'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> _shortbuf <span class=\"token operator\">=</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre> _lock <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc6780</span> <span class=\"token operator\">&lt;</span>_IO_stdfile_1_lock<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre> _offset <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> _codecvt <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre> _wide_data <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc47a0</span> <span class=\"token operator\">&lt;</span>_IO_wide_data_1<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> _freeres_list <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> _freeres_buf <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre> __pad5 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre> _mode <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> _unused2 <span class=\"token operator\">=</span> <span class=\"token char\">'\\000'</span> <span class=\"token operator\">&lt;</span>repeats <span class=\"token number\">19</span> times<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>vtable <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7bc36e0</span> <span class=\"token operator\">&lt;</span>_IO_file_jumps<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></blockquote>\n<p>Vtable 存着一些跳转的函数指针</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> funcs<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token number\">1</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// \"extra word\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token number\">2</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// DUMMY</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token number\">3</span> exit<span class=\"token punctuation\">,</span> <span class=\"token comment\">// finish</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token number\">4</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// overflow</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token number\">5</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// underflow</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token number\">6</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// uflow</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token number\">7</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// pbackfail</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token number\">8</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// xsputn  #printf</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token number\">9</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// xsgetn</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token number\">10</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// seekoff</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token number\">11</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// seekpos</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token number\">12</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// setbuf</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token number\">13</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// sync</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token number\">14</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// doallocate</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token number\">15</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// read</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token number\">16</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// write</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token number\">17</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// seek</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token number\">18</span> pwn<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// close</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token number\">19</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// stat</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token number\">20</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// showmanyc</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   <span class=\"token number\">21</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// imbue</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pwndbg<span class=\"token operator\">></span> p _IO_file_jumps</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$<span class=\"token number\">12</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  __dummy <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  __dummy2 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  __finish <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff78799d0</span> <span class=\"token operator\">&lt;</span>_IO_new_file_finish<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  __overflow <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787a740</span> <span class=\"token operator\">&lt;</span>_IO_new_file_overflow<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  __underflow <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787a4b0</span> <span class=\"token operator\">&lt;</span>_IO_new_file_underflow<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  __uflow <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787b610</span> <span class=\"token operator\">&lt;</span>__GI__IO_default_uflow<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  __pbackfail <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787c990</span> <span class=\"token operator\">&lt;</span>__GI__IO_default_pbackfail<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  __xsputn <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff78791f0</span> <span class=\"token operator\">&lt;</span>_IO_new_file_xsputn<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  __xsgetn <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878ed0</span> <span class=\"token operator\">&lt;</span>__GI__IO_file_xsgetn<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  __seekoff <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff78784d0</span> <span class=\"token operator\">&lt;</span>_IO_new_file_seekoff<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  __seekpos <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787ba10</span> <span class=\"token operator\">&lt;</span>_IO_default_seekpos<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  __setbuf <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878440</span> <span class=\"token operator\">&lt;</span>_IO_new_file_setbuf<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  __sync <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878380</span> <span class=\"token operator\">&lt;</span>_IO_new_file_sync<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  __doallocate <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff786d190</span> <span class=\"token operator\">&lt;</span>__GI__IO_file_doallocate<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  __read <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff78791b0</span> <span class=\"token operator\">&lt;</span>__GI__IO_file_read<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  __write <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878b80</span> <span class=\"token operator\">&lt;</span>_IO_new_file_write<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  __seek <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878980</span> <span class=\"token operator\">&lt;</span>__GI__IO_file_seek<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  __close <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878350</span> <span class=\"token operator\">&lt;</span>__GI__IO_file_close<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  __stat <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff7878b70</span> <span class=\"token operator\">&lt;</span>__GI__IO_file_stat<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  __showmanyc <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787cb00</span> <span class=\"token operator\">&lt;</span>_IO_default_showmanyc<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  __imbue <span class=\"token operator\">=</span> <span class=\"token number\">0x7ffff787cb10</span> <span class=\"token operator\">&lt;</span>_IO_default_imbue<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_jump_t</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span><span class=\"token punctuation\">,</span> __dummy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span><span class=\"token punctuation\">,</span> __dummy2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_finish_t<span class=\"token punctuation\">,</span> __finish<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_overflow_t<span class=\"token punctuation\">,</span> __overflow<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_underflow_t<span class=\"token punctuation\">,</span> __underflow<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_underflow_t<span class=\"token punctuation\">,</span> __uflow<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_pbackfail_t<span class=\"token punctuation\">,</span> __pbackfail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">/* showmany */</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_xsputn_t<span class=\"token punctuation\">,</span> __xsputn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_xsgetn_t<span class=\"token punctuation\">,</span> __xsgetn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_seekoff_t<span class=\"token punctuation\">,</span> __seekoff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_seekpos_t<span class=\"token punctuation\">,</span> __seekpos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_setbuf_t<span class=\"token punctuation\">,</span> __setbuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_sync_t<span class=\"token punctuation\">,</span> __sync<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_doallocate_t<span class=\"token punctuation\">,</span> __doallocate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_read_t<span class=\"token punctuation\">,</span> __read<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_write_t<span class=\"token punctuation\">,</span> __write<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_seek_t<span class=\"token punctuation\">,</span> __seek<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_close_t<span class=\"token punctuation\">,</span> __close<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_stat_t<span class=\"token punctuation\">,</span> __stat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_showmanyc_t<span class=\"token punctuation\">,</span> __showmanyc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token function\">JUMP_FIELD</span><span class=\"token punctuation\">(</span>_IO_imbue_t<span class=\"token punctuation\">,</span> __imbue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    get_column<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    set_column<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>_IO_FILE_plus 结构中存在 vtable，一些函数会取出 vtable 中的指针进行调用。</p>\n<p>因此伪造 vtable 劫持控制流程的思想就是针对_IO_File_plus 的 vtable 动手脚，通过把 vtable 指向我们控制的内存，并在其中部署函数指针来实现</p>\n<p>所以 vtable 劫持分为 2 种，一种是直接改写 vtable 的函数的指针，通过任意地址写就可以实现。另一种是覆盖 vtable 的指针为我们控制的内存，然后在其中布置函数指针。</p>\n<h3 id=\"小结\"><a class=\"markdownIt-Anchor\" href=\"#小结\">#</a> 小结</h3>\n<ul>\n<li>\n<p><strong>stdin、stdout、stderr</strong> 文件流位于  <code>libc.so</code>  的数据段。而我们使用 fopen 创建的文件流是分配在堆内存上</p>\n</li>\n<li>\n<p><strong>stdin、stdout、stderr，分别对应文件描述符：0、1、2</strong>，开启新的文件流文件描述符从 3 开始递增</p>\n</li>\n<li>\n<p>每个文件流都单独的  <code>_IO_FILE</code>  、 <code>_IO_FILE_plus</code>  结构体， <code>_IO_jump_t   *vtable</code>  只有一个各个文件流公用</p>\n</li>\n<li>\n<p>指针  <code>vtable</code>  指向了一系列函数指针，各种 IO 操作均是通过  <code>vtable</code>  指向各个具体函数实现功能</p>\n</li>\n<li>\n<p>文件流通过  <code>_chain</code>  构成链表，<strong>链表头部用全局变量 _IO_list_all 表示</strong></p>\n</li>\n<li>\n<p>ida 中通过搜索文件流名可以找到  <code>_IO_FILE</code>  、 <code>_IO_FILE_plus</code>  ，根据偏移（结构体最后位置）找到  <code>vtable</code></p>\n<pre><code>（eg:IO_2_1_stderr)\n</code></pre>\n</li>\n</ul>\n<p>先暂时了解这么多…</p>\n<blockquote>\n<p>参考</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NreWVkYWk5MTAvd2lraS5tcnNreWUuY24vYmxvYi9tYXN0ZXIvZG9jcy9Qd24vSU9fRklMRS9Qd25fSU9fRklMRS5tZA==\">https://github.com/skyedai910/wiki.mrskye.cn/blob/master/docs/Pwn/IO_FILE/Pwn_IO_FILE.md</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjQ2OD90aW1lX18xMzExPW40JTJCeG5EMERnNzAlM0RHJTNERE96M0RzQTNFUG9ZZTdLRzhRJTJGUXpZUmVE\">https://xz.aliyun.com/t/6468?time__1311=n4%2BxnD0Dg70%3DG%3DDOz3DsA3EPoYe7KG8Q%2FQzYReD</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaGF3a0pXL3AvMTM1NDY0MTYuaHRtbA==\">https://www.cnblogs.com/hawkJW/p/13546416.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjU2Nz90aW1lX18xMzExPW40JTJCeG5EMERnN0clM0RCaERCcW9vR2tEUmlHNWklM0RkWURCN29E\">https://xz.aliyun.com/t/6567?time__1311=n4%2BxnD0Dg7G%3DBhDBqooGkDRiG5i%3DdYDB7oD</span></p>\n</blockquote>\n",
            "tags": [
                "IO_FILE"
            ]
        }
    ]
}